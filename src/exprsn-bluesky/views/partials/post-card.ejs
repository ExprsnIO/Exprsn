<!-- Post Card Component -->
<!-- Usage: <%- include('../partials/post-card', { post: postData }) %> -->

<%
const post = locals.post || {};
const author = post.author || {};
const embed = post.embed || null;
const stats = post.stats || { likes: 0, reposts: 0, replies: 0 };
const viewer = post.viewer || { liked: false, reposted: false, bookmarked: false };
%>

<div class="card border-0 border-bottom rounded-0 post-card" data-post-id="<%= post.id || post.rkey %>">
    <div class="card-body p-3">
        <div class="d-flex gap-3">
            <!-- Author Avatar -->
            <a href="/profile/<%= author.handle %>" class="text-decoration-none">
                <img src="<%= author.avatar || '/images/default-avatar.png' %>"
                     alt="<%= author.displayName || author.handle %>"
                     class="rounded-circle"
                     style="width: 48px; height: 48px; object-fit: cover;">
            </a>

            <!-- Post Content -->
            <div class="flex-grow-1 overflow-hidden">
                <!-- Author Info -->
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1 overflow-hidden">
                        <a href="/profile/<%= author.handle %>" class="text-decoration-none text-dark">
                            <span class="fw-semibold"><%= author.displayName || author.handle %></span>
                            <% if (author.isVerified) { %>
                            <i class="bi bi-patch-check-fill text-primary ms-1"></i>
                            <% } %>
                        </a>
                        <a href="/profile/<%= author.handle %>" class="text-decoration-none text-muted small ms-2">
                            @<%= author.handle %>
                        </a>
                        <span class="text-muted small ms-2">
                            Â· <%= formatTimestamp(post.createdAt) %>
                        </span>
                    </div>

                    <!-- Post Menu -->
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light border-0" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                            <% if (locals.user && user.did === author.did) { %>
                            <li><a class="dropdown-item" href="#" onclick="editPost('<%= post.id %>'); return false;">
                                <i class="bi bi-pencil me-2"></i>Edit
                            </a></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deletePost('<%= post.id %>'); return false;">
                                <i class="bi bi-trash me-2"></i>Delete
                            </a></li>
                            <% } else { %>
                            <li><a class="dropdown-item" href="#" onclick="reportPost('<%= post.id %>'); return false;">
                                <i class="bi bi-flag me-2"></i>Report
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="muteUser('<%= author.handle %>'); return false;">
                                <i class="bi bi-volume-mute me-2"></i>Mute @<%= author.handle %>
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="blockUser('<%= author.handle %>'); return false;">
                                <i class="bi bi-slash-circle me-2"></i>Block @<%= author.handle %>
                            </a></li>
                            <% } %>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="copyPostLink('<%= post.id %>'); return false;">
                                <i class="bi bi-link me-2"></i>Copy link
                            </a></li>
                        </ul>
                    </div>
                </div>

                <!-- Post Text -->
                <% if (post.text) { %>
                <div class="post-text mb-2">
                    <%- renderPostText(post.text, post.facets) %>
                </div>
                <% } %>

                <!-- Embeds -->
                <% if (embed) { %>
                    <% if (embed.$type === 'io.exprsn.timeline.embed#images' && embed.images) { %>
                    <!-- Image Embed -->
                    <div class="post-images mb-2">
                        <div class="row g-2">
                            <% embed.images.slice(0, 4).forEach((img, index) => { %>
                            <div class="<%= embed.images.length === 1 ? 'col-12' : 'col-6' %>">
                                <img src="<%= img.thumb || img.fullsize %>"
                                     alt="<%= img.alt || 'Image' %>"
                                     class="img-fluid rounded cursor-pointer"
                                     style="width: 100%; height: <%= embed.images.length === 1 ? 'auto' : '200px' %>; object-fit: cover;"
                                     onclick="openImageViewer('<%= post.id %>', <%= index %>)">
                            </div>
                            <% }); %>
                        </div>
                    </div>
                    <% } else if (embed.$type === 'io.exprsn.timeline.embed#external' && embed.uri) { %>
                    <!-- External Link Embed -->
                    <a href="<%= embed.uri %>" target="_blank" class="text-decoration-none">
                        <div class="card mb-2">
                            <% if (embed.thumb) { %>
                            <img src="<%= embed.thumb %>" class="card-img-top" alt="<%= embed.title %>">
                            <% } %>
                            <div class="card-body">
                                <h6 class="card-title mb-1"><%= embed.title || embed.uri %></h6>
                                <% if (embed.description) { %>
                                <p class="card-text small text-muted"><%= embed.description %></p>
                                <% } %>
                                <small class="text-muted">
                                    <i class="bi bi-link-45deg"></i>
                                    <%= new URL(embed.uri).hostname %>
                                </small>
                            </div>
                        </div>
                    </a>
                    <% } else if (embed.$type === 'io.exprsn.timeline.embed#video' && embed.video) { %>
                    <!-- Video Embed -->
                    <div class="post-video mb-2">
                        <video controls class="w-100 rounded" style="max-height: 500px;">
                            <source src="<%= embed.playlist || embed.video.ref %>" type="<%= embed.video.mimeType || 'video/mp4' %>">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    <% } %>
                <% } %>

                <!-- Tags -->
                <% if (post.tags && post.tags.length > 0) { %>
                <div class="post-tags mb-2">
                    <% post.tags.forEach(tag => { %>
                    <a href="/explore?tag=<%= encodeURIComponent(tag) %>" class="badge bg-light text-primary text-decoration-none me-1">
                        #<%= tag %>
                    </a>
                    <% }); %>
                </div>
                <% } %>

                <!-- Interaction Buttons -->
                <div class="d-flex justify-content-between align-items-center mt-3 post-actions">
                    <div class="d-flex gap-4">
                        <!-- Reply -->
                        <button class="btn btn-sm btn-light border-0 d-flex align-items-center gap-1"
                                onclick="replyToPost('<%= post.id %>')">
                            <i class="bi bi-chat"></i>
                            <% if (stats.replies > 0) { %>
                            <span class="small"><%= formatCount(stats.replies) %></span>
                            <% } %>
                        </button>

                        <!-- Repost -->
                        <button class="btn btn-sm btn-light border-0 d-flex align-items-center gap-1 <%= viewer.reposted ? 'text-success' : '' %>"
                                onclick="toggleRepost('<%= post.id %>')">
                            <i class="bi <%= viewer.reposted ? 'bi-arrow-repeat-fill' : 'bi-arrow-repeat' %>"></i>
                            <% if (stats.reposts > 0) { %>
                            <span class="small"><%= formatCount(stats.reposts) %></span>
                            <% } %>
                        </button>

                        <!-- Like -->
                        <button class="btn btn-sm btn-light border-0 d-flex align-items-center gap-1 <%= viewer.liked ? 'text-danger' : '' %>"
                                onclick="toggleLike('<%= post.id %>')">
                            <i class="bi <%= viewer.liked ? 'bi-heart-fill' : 'bi-heart' %>"></i>
                            <% if (stats.likes > 0) { %>
                            <span class="small"><%= formatCount(stats.likes) %></span>
                            <% } %>
                        </button>

                        <!-- Share -->
                        <button class="btn btn-sm btn-light border-0"
                                onclick="sharePost('<%= post.id %>')">
                            <i class="bi bi-share"></i>
                        </button>
                    </div>

                    <!-- Bookmark -->
                    <button class="btn btn-sm btn-light border-0 <%= viewer.bookmarked ? 'text-primary' : '' %>"
                            onclick="toggleBookmark('<%= post.id %>')">
                        <i class="bi <%= viewer.bookmarked ? 'bi-bookmark-fill' : 'bi-bookmark' %>"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<%
// Helper functions
function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;

    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (seconds < 60) return `${seconds}s`;
    if (minutes < 60) return `${minutes}m`;
    if (hours < 24) return `${hours}h`;
    if (days < 7) return `${days}d`;

    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatCount(count) {
    if (!count || count === 0) return '';
    if (count < 1000) return count.toString();
    if (count < 1000000) return (count / 1000).toFixed(1) + 'K';
    return (count / 1000000).toFixed(1) + 'M';
}

function renderPostText(text, facets) {
    if (!text) return '';

    let html = text;

    // Convert URLs to links
    html = html.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-primary">$1</a>');

    // Convert mentions to links
    html = html.replace(/@([\w.]+)/g, '<a href="/profile/$1" class="text-primary">@$1</a>');

    // Convert hashtags to links
    html = html.replace(/#([\w]+)/g, '<a href="/explore?tag=$1" class="text-primary">#$1</a>');

    // Convert newlines to <br>
    html = html.replace(/\n/g, '<br>');

    return html;
}
%>

<style>
.post-card {
    transition: background-color 0.2s;
}

.post-card:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.post-actions button {
    transition: all 0.2s;
}

.post-actions button:hover {
    background-color: rgba(0, 0, 0, 0.05);
    transform: scale(1.05);
}

.cursor-pointer {
    cursor: pointer;
}
</style>
