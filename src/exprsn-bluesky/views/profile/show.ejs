<!-- Profile View -->
<%
const profile = locals.profile || {};
const isOwnProfile = locals.user && user.did === profile.did;
const isFollowing = locals.isFollowing || false;
%>

<div class="profile-container">
    <!-- Profile Header -->
    <div class="card border-0 border-bottom rounded-0">
        <!-- Banner -->
        <div class="profile-banner position-relative"
             style="height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <% if (profile.banner) { %>
            <img src="<%= profile.banner %>"
                 alt="Profile banner"
                 class="w-100 h-100"
                 style="object-fit: cover;">
            <% } %>

            <!-- Edit Banner (if own profile) -->
            <% if (isOwnProfile) { %>
            <button class="btn btn-sm btn-light position-absolute top-0 end-0 m-3"
                    onclick="editBanner()">
                <i class="bi bi-camera"></i>
            </button>
            <% } %>
        </div>

        <div class="card-body">
            <!-- Avatar and Actions -->
            <div class="d-flex justify-content-between align-items-start" style="margin-top: -50px;">
                <div class="position-relative">
                    <img src="<%= profile.avatar || '/images/default-avatar.png' %>"
                         alt="<%= profile.displayName %>"
                         class="rounded-circle border border-4 border-white"
                         style="width: 120px; height: 120px; object-fit: cover;">
                    <% if (isOwnProfile) { %>
                    <button class="btn btn-sm btn-primary position-absolute bottom-0 end-0 rounded-circle"
                            onclick="editAvatar()">
                        <i class="bi bi-camera"></i>
                    </button>
                    <% } %>
                </div>

                <!-- Action Buttons -->
                <div class="mt-3">
                    <% if (isOwnProfile) { %>
                    <a href="/settings/profile" class="btn btn-outline-primary rounded-pill px-4">
                        Edit Profile
                    </a>
                    <% } else if (locals.user) { %>
                    <button class="btn <%= isFollowing ? 'btn-outline-primary' : 'btn-primary' %> rounded-pill px-4"
                            id="followBtn"
                            onclick="toggleFollow('<%= profile.handle %>')">
                        <%= isFollowing ? 'Following' : 'Follow' %>
                    </button>
                    <button class="btn btn-outline-secondary rounded-circle ms-2"
                            onclick="showMessageDialog('<%= profile.handle %>')">
                        <i class="bi bi-envelope"></i>
                    </button>
                    <div class="btn-group ms-2">
                        <button class="btn btn-outline-secondary rounded-circle" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="muteUser('<%= profile.handle %>'); return false;">
                                <i class="bi bi-volume-mute me-2"></i>Mute
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="blockUser('<%= profile.handle %>'); return false;">
                                <i class="bi bi-slash-circle me-2"></i>Block
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="reportUser('<%= profile.handle %>'); return false;">
                                <i class="bi bi-flag me-2"></i>Report
                            </a></li>
                        </ul>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- Profile Info -->
            <div class="mt-3">
                <h4 class="fw-bold mb-0">
                    <%= profile.displayName || profile.handle %>
                    <% if (profile.isVerified) { %>
                    <i class="bi bi-patch-check-fill text-primary ms-1"></i>
                    <% } %>
                </h4>
                <div class="text-muted">@<%= profile.handle %></div>

                <!-- Description -->
                <% if (profile.description) { %>
                <p class="mt-3 mb-2"><%= profile.description %></p>
                <% } %>

                <!-- Profile Metadata -->
                <div class="d-flex flex-wrap gap-3 mt-2 small text-muted">
                    <% if (profile.location) { %>
                    <div>
                        <i class="bi bi-geo-alt me-1"></i>
                        <%= profile.location %>
                    </div>
                    <% } %>
                    <% if (profile.website) { %>
                    <div>
                        <i class="bi bi-link-45deg me-1"></i>
                        <a href="<%= profile.website %>" target="_blank" class="text-primary"><%= profile.website %></a>
                    </div>
                    <% } %>
                    <div>
                        <i class="bi bi-calendar3 me-1"></i>
                        Joined <%= new Date(profile.createdAt).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) %>
                    </div>
                </div>

                <!-- Follow Stats -->
                <div class="d-flex gap-3 mt-3">
                    <a href="/profile/<%= profile.handle %>/following" class="text-decoration-none text-dark">
                        <span class="fw-bold"><%= profile.followingCount || 0 %></span>
                        <span class="text-muted">Following</span>
                    </a>
                    <a href="/profile/<%= profile.handle %>/followers" class="text-decoration-none text-dark">
                        <span class="fw-bold"><%= profile.followersCount || 0 %></span>
                        <span class="text-muted">Followers</span>
                    </a>
                    <div>
                        <span class="fw-bold"><%= profile.postsCount || 0 %></span>
                        <span class="text-muted">Posts</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Tabs -->
    <div class="card border-0 border-bottom rounded-0 sticky-top bg-white" style="top: 56px; z-index: 1020;">
        <div class="card-body p-0">
            <ul class="nav nav-tabs border-0" id="profileTabs" role="tablist">
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link border-0 w-100 active"
                            id="posts-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#posts"
                            type="button"
                            role="tab">
                        Posts
                    </button>
                </li>
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link border-0 w-100"
                            id="replies-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#replies"
                            type="button"
                            role="tab">
                        Replies
                    </button>
                </li>
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link border-0 w-100"
                            id="media-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#media"
                            type="button"
                            role="tab">
                        Media
                    </button>
                </li>
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link border-0 w-100"
                            id="likes-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#likes"
                            type="button"
                            role="tab">
                        Likes
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="profileTabContent">
        <!-- Posts Tab -->
        <div class="tab-pane fade show active" id="posts" role="tabpanel">
            <div id="postsContainer">
                <!-- Loading skeleton -->
                <div class="loading-skeleton" id="postsLoading">
                    <% for (let i = 0; i < 3; i++) { %>
                    <div class="card border-0 border-bottom rounded-0">
                        <div class="card-body p-3">
                            <div class="placeholder-glow">
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-4"></span>
                                <span class="placeholder col-6"></span>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Replies Tab -->
        <div class="tab-pane fade" id="replies" role="tabpanel">
            <div id="repliesContainer">
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-chat fs-1"></i>
                    <p class="mt-3">Replies will be shown here</p>
                </div>
            </div>
        </div>

        <!-- Media Tab -->
        <div class="tab-pane fade" id="media" role="tabpanel">
            <div id="mediaContainer" class="p-2">
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-images fs-1"></i>
                    <p class="mt-3">Media posts will be shown here</p>
                </div>
            </div>
        </div>

        <!-- Likes Tab -->
        <div class="tab-pane fade" id="likes" role="tabpanel">
            <div id="likesContainer">
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-heart fs-1"></i>
                    <p class="mt-3">Liked posts will be shown here</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const profileHandle = '<%= profile.handle %>';
let postsCursor = null;

document.addEventListener('DOMContentLoaded', () => {
    loadProfilePosts();

    // Tab change events
    document.querySelectorAll('#profileTabs button').forEach(tab => {
        tab.addEventListener('shown.bs.tab', (event) => {
            const targetId = event.target.getAttribute('data-bs-target').substring(1);
            loadTabContent(targetId);
        });
    });
});

async function loadProfilePosts() {
    try {
        const response = await fetch(`/api/feed/author/${encodeURIComponent(profileHandle)}?limit=20`);
        const data = await response.json();

        document.getElementById('postsLoading').style.display = 'none';

        if (data.success && data.data.posts.length > 0) {
            const container = document.getElementById('postsContainer');
            container.innerHTML = '';
            data.data.posts.forEach(post => {
                container.innerHTML += renderPost(post);
            });
            postsCursor = data.data.nextCursor;
        } else {
            document.getElementById('postsContainer').innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox fs-1"></i>
                    <p class="mt-3">No posts yet</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load posts:', error);
        showToast('Failed to load posts', 'error');
    }
}

async function loadTabContent(tabId) {
    // Implement loading for other tabs
    console.log('Loading content for tab:', tabId);
}

async function toggleFollow(handle) {
    const btn = document.getElementById('followBtn');
    const isFollowing = btn.textContent.trim() === 'Following';

    try {
        const response = await fetch(`/api/social/${isFollowing ? 'unfollow' : 'follow'}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ handle })
        });

        const data = await response.json();
        if (data.success) {
            btn.textContent = isFollowing ? 'Follow' : 'Following';
            btn.className = isFollowing ? 'btn btn-primary rounded-pill px-4' : 'btn btn-outline-primary rounded-pill px-4';
            showToast(isFollowing ? 'Unfollowed' : 'Followed', 'success');
        }
    } catch (error) {
        console.error('Failed to toggle follow:', error);
        showToast('Failed to update follow status', 'error');
    }
}

function editAvatar() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('avatar', file);

            try {
                const response = await fetch('/api/profile/avatar', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    showToast('Avatar updated!', 'success');
                    location.reload();
                }
            } catch (error) {
                showToast('Failed to update avatar', 'error');
            }
        }
    };
    input.click();
}

function editBanner() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('banner', file);

            try {
                const response = await fetch('/api/profile/banner', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    showToast('Banner updated!', 'success');
                    location.reload();
                }
            } catch (error) {
                showToast('Failed to update banner', 'error');
            }
        }
    };
    input.click();
}
</script>

<style>
#profileTabs .nav-link {
    color: #6c757d;
    font-weight: 600;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}

#profileTabs .nav-link:hover {
    color: #0d6efd;
}

#profileTabs .nav-link.active {
    color: #0d6efd;
    border-bottom-color: #0d6efd;
}

.profile-banner {
    position: relative;
    overflow: hidden;
}
</style>
