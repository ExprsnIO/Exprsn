<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | Exprsn Pulse</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/static/css/pulse.css">

  <%- include('../shared/head-extra') %>
</head>
<body>
  <!-- Navbar -->
  <%- include('../shared/navbar') %>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
        <%- include('../shared/sidebar') %>
      </nav>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">
            <i class="bi bi-play-circle text-success"></i>
            Execute Report: <%= report.name %>
          </h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
              <a href="/reports/<%= report.id %>/edit" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-pencil"></i> Edit
              </a>
              <a href="/schedules/new?reportId=<%= report.id %>" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-clock"></i> Schedule
              </a>
            </div>
            <a href="/reports" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-arrow-left"></i> Back
            </a>
          </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container"></div>

        <% if (report.description) { %>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <%= report.description %>
          </div>
        <% } %>

        <div class="row">
          <!-- Parameters Panel -->
          <div class="col-md-4 mb-4">
            <div class="card shadow">
              <div class="card-header">
                <h6 class="m-0">
                  <i class="bi bi-sliders"></i> Parameters
                </h6>
              </div>
              <div class="card-body">
                <form id="parameter-form">
                  <% if (report.parameters && report.parameters.length > 0) { %>
                    <% report.parameters.forEach((param, index) => { %>
                      <div class="mb-3">
                        <label for="param-<%= param.id %>" class="form-label">
                          <%= param.label %>
                          <% if (param.required) { %>
                            <span class="text-danger">*</span>
                          <% } %>
                        </label>

                        <% if (param.type === 'text') { %>
                          <input type="text"
                                 class="form-control"
                                 id="param-<%= param.id %>"
                                 name="<%= param.name %>"
                                 placeholder="<%= param.defaultValue || '' %>"
                                 <%= param.required ? 'required' : '' %>>
                        <% } else if (param.type === 'number') { %>
                          <input type="number"
                                 class="form-control"
                                 id="param-<%= param.id %>"
                                 name="<%= param.name %>"
                                 value="<%= param.defaultValue || '' %>"
                                 <%= param.required ? 'required' : '' %>>
                        <% } else if (param.type === 'date') { %>
                          <input type="date"
                                 class="form-control"
                                 id="param-<%= param.id %>"
                                 name="<%= param.name %>"
                                 value="<%= param.defaultValue || '' %>"
                                 <%= param.required ? 'required' : '' %>>
                        <% } else if (param.type === 'daterange') { %>
                          <div class="row">
                            <div class="col-6">
                              <input type="date"
                                     class="form-control"
                                     id="param-<%= param.id %>-start"
                                     name="<%= param.name %>_start"
                                     placeholder="Start date"
                                     <%= param.required ? 'required' : '' %>>
                            </div>
                            <div class="col-6">
                              <input type="date"
                                     class="form-control"
                                     id="param-<%= param.id %>-end"
                                     name="<%= param.name %>_end"
                                     placeholder="End date"
                                     <%= param.required ? 'required' : '' %>>
                            </div>
                          </div>
                        <% } else if (param.type === 'select') { %>
                          <select class="form-select"
                                  id="param-<%= param.id %>"
                                  name="<%= param.name %>"
                                  <%= param.required ? 'required' : '' %>>
                            <option value="">Select...</option>
                            <% if (param.options) { %>
                              <% param.options.forEach(opt => { %>
                                <option value="<%= opt.value %>"><%= opt.label %></option>
                              <% }) %>
                            <% } %>
                          </select>
                        <% } %>

                        <% if (param.description) { %>
                          <small class="form-text text-muted">
                            <%= param.description %>
                          </small>
                        <% } %>
                      </div>
                    <% }) %>
                  <% } else { %>
                    <p class="text-muted">No parameters required</p>
                  <% } %>

                  <!-- Filters -->
                  <% if (report.filters && report.filters.length > 0) { %>
                    <hr>
                    <h6 class="mb-3">Filters</h6>
                    <% report.filters.forEach(filter => { %>
                      <div class="mb-3">
                        <label class="form-label"><%= filter.field %></label>
                        <div class="input-group">
                          <select class="form-select" style="max-width: 120px;">
                            <option value="equals" <%= filter.operator === 'equals' ? 'selected' : '' %>>Equals</option>
                            <option value="contains" <%= filter.operator === 'contains' ? 'selected' : '' %>>Contains</option>
                            <option value="gt" <%= filter.operator === 'gt' ? 'selected' : '' %>>Greater than</option>
                            <option value="lt" <%= filter.operator === 'lt' ? 'selected' : '' %>>Less than</option>
                          </select>
                          <input type="text" class="form-control" value="<%= filter.value || '' %>">
                        </div>
                      </div>
                    <% }) %>
                  <% } %>
                </form>
              </div>
            </div>

            <!-- Output Format -->
            <div class="card shadow mt-3">
              <div class="card-header">
                <h6 class="m-0">
                  <i class="bi bi-file-earmark-arrow-down"></i> Output Format
                </h6>
              </div>
              <div class="card-body">
                <div class="export-options">
                  <div class="export-btn" data-format="pdf">
                    <i class="bi bi-file-earmark-pdf text-danger"></i>
                    <span>PDF</span>
                  </div>
                  <div class="export-btn" data-format="excel">
                    <i class="bi bi-file-earmark-excel text-success"></i>
                    <span>Excel</span>
                  </div>
                  <div class="export-btn" data-format="csv">
                    <i class="bi bi-filetype-csv text-info"></i>
                    <span>CSV</span>
                  </div>
                  <div class="export-btn" data-format="html">
                    <i class="bi bi-file-earmark-code text-primary"></i>
                    <span>HTML</span>
                  </div>
                  <div class="export-btn" data-format="json">
                    <i class="bi bi-filetype-json text-warning"></i>
                    <span>JSON</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Execute Button -->
            <button type="button" class="btn btn-success w-100 mt-3" onclick="executeReport()">
              <i class="bi bi-play-fill"></i> Execute Report
            </button>
          </div>

          <!-- Preview/Results Panel -->
          <div class="col-md-8 mb-4">
            <div class="card shadow">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0">
                  <i class="bi bi-eye"></i> Preview
                </h6>
                <div id="execution-status" class="badge bg-secondary">
                  Not executed
                </div>
              </div>
              <div class="card-body">
                <div id="preview-container" class="text-center py-5">
                  <i class="bi bi-file-earmark-text" style="font-size: 4rem; color: #dee2e6;"></i>
                  <p class="mt-3 text-muted">
                    Set parameters and click "Execute Report" to preview results
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Core Pulse JS -->
  <script src="/static/js/pulse-core.js"></script>

  <script>
    const reportId = '<%= report.id %>';
    let selectedFormat = 'html'; // Default for preview

    $(document).ready(function() {
      // Highlight HTML format by default
      $('.export-btn[data-format="html"]').css('background-color', '#e7f3ff');

      // Format selection
      $('.export-btn').on('click', function() {
        $('.export-btn').css('background-color', '');
        $(this).css('background-color', '#e7f3ff');
        selectedFormat = $(this).data('format');
      });
    });

    // Execute report
    async function executeReport() {
      // Validate form
      const form = $('#parameter-form')[0];
      if (form && !form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // Collect parameters
      const parameters = {};
      $('#parameter-form input, #parameter-form select').each(function() {
        const name = $(this).attr('name');
        const value = $(this).val();
        if (name && value) {
          parameters[name] = value;
        }
      });

      // Show loading
      $('#execution-status').removeClass('bg-secondary bg-success bg-danger').addClass('bg-warning').text('Executing...');
      $('#preview-container').html(`
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Generating report...</p>
      `);

      try {
        const result = await PulseAPI.reports.execute(reportId, parameters, selectedFormat);

        $('#execution-status').removeClass('bg-warning').addClass('bg-success').text('Success');

        if (selectedFormat === 'html') {
          // Show HTML preview
          $('#preview-container').html(result.output);
        } else if (selectedFormat === 'json') {
          // Show formatted JSON
          $('#preview-container').html(`
            <pre class="text-start"><code>${JSON.stringify(result.data, null, 2)}</code></pre>
          `);
        } else {
          // Download file for PDF, Excel, CSV
          const blob = new Blob([result.output], {
            type: getMimeType(selectedFormat)
          });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${slugify('<%= report.name %>')}.${selectedFormat}`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          $('#preview-container').html(`
            <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
            <p class="mt-3 text-success">
              Report downloaded successfully
            </p>
          `);
        }

        PulseUtils.showAlert('Report executed successfully', 'success');
      } catch (error) {
        $('#execution-status').removeClass('bg-warning').addClass('bg-danger').text('Failed');
        $('#preview-container').html(`
          <i class="bi bi-x-circle text-danger" style="font-size: 4rem;"></i>
          <p class="mt-3 text-danger">
            ${error.message || 'Failed to execute report'}
          </p>
        `);
        PulseUtils.showAlert('Failed to execute report: ' + error.message, 'danger');
      }
    }

    // Helper functions
    function getMimeType(format) {
      const mimeTypes = {
        'pdf': 'application/pdf',
        'excel': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'csv': 'text/csv',
        'html': 'text/html',
        'json': 'application/json'
      };
      return mimeTypes[format] || 'application/octet-stream';
    }

    function slugify(text) {
      return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    }
  </script>

  <%- include('../shared/body-extra') %>
</body>
</html>
