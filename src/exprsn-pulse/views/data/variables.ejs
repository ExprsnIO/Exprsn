<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | Exprsn Pulse</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/static/css/pulse.css">

  <%- include('../shared/head-extra') %>
</head>
<body>
  <!-- Navbar -->
  <%- include('../shared/navbar') %>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
        <%- include('../shared/sidebar') %>
      </nav>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">
            <i class="bi bi-code-square text-warning"></i>
            Variables & Functions
          </h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
              <button type="button" class="btn btn-warning" onclick="createVariable()">
                <i class="bi bi-plus-circle"></i> New Variable
              </button>
              <button type="button" class="btn btn-outline-warning" onclick="createFunction()">
                <i class="bi bi-braces"></i> New Function
              </button>
            </div>
          </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container"></div>

        <!-- Description -->
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i>
          <strong>Variables & Functions</strong> let you define reusable JSONLex expressions and custom JavaScript functions for data transformation and computed fields.
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="variableTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="variables-tab" data-bs-toggle="tab"
                    data-bs-target="#variables" type="button" role="tab">
              <i class="bi bi-file-code"></i> Variables
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="functions-tab" data-bs-toggle="tab"
                    data-bs-target="#functions" type="button" role="tab">
              <i class="bi bi-braces"></i> Functions
            </button>
          </li>
        </ul>

        <div class="tab-content" id="variableTabContent">
          <!-- Variables Tab -->
          <div class="tab-pane fade show active" id="variables" role="tabpanel">
            <div class="card shadow">
              <div class="card-body">
                <% if (variables.length === 0) { %>
                  <div class="text-center py-5">
                    <i class="bi bi-file-code" style="font-size: 4rem; color: #dee2e6;"></i>
                    <h4 class="mt-3">No variables yet</h4>
                    <p class="text-muted">Create reusable JSONLex variables for computed fields and data transformations</p>
                    <button type="button" class="btn btn-warning" onclick="createVariable()">
                      <i class="bi bi-plus-circle"></i> Create Variable
                    </button>
                  </div>
                <% } else { %>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Expression</th>
                          <th>Type</th>
                          <th>Description</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% variables.forEach(variable => { %>
                          <tr>
                            <td>
                              <code><%= variable.name %></code>
                            </td>
                            <td>
                              <code class="small"><%= variable.expression %></code>
                            </td>
                            <td>
                              <span class="badge bg-info"><%= variable.type %></span>
                            </td>
                            <td>
                              <span class="text-muted small"><%= variable.description || 'N/A' %></span>
                            </td>
                            <td>
                              <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editVariable('<%= variable.id %>')">
                                  <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteVariable('<%= variable.id %>')">
                                  <i class="bi bi-trash"></i>
                                </button>
                              </div>
                            </td>
                          </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                <% } %>
              </div>
            </div>

            <!-- Example Variables -->
            <div class="card bg-light mt-3">
              <div class="card-body">
                <h6 class="card-title"><i class="bi bi-lightbulb"></i> Example Variables</h6>
                <div class="row small">
                  <div class="col-md-6">
                    <p class="mb-1"><strong>Full Name:</strong> <code>$.firstName + ' ' + $.lastName</code></p>
                    <p class="mb-1"><strong>Age from DOB:</strong> <code>Math.floor((Date.now() - new Date($.dob)) / 31557600000)</code></p>
                  </div>
                  <div class="col-md-6">
                    <p class="mb-1"><strong>Total Price:</strong> <code>$.quantity * $.unitPrice * (1 + $.taxRate)</code></p>
                    <p class="mb-0"><strong>Status Color:</strong> <code>$.status === 'active' ? 'green' : 'red'</code></p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Functions Tab -->
          <div class="tab-pane fade" id="functions" role="tabpanel">
            <div class="card shadow">
              <div class="card-body">
                <div class="text-center py-5">
                  <i class="bi bi-braces" style="font-size: 4rem; color: #dee2e6;"></i>
                  <h4 class="mt-3">No custom functions yet</h4>
                  <p class="text-muted">Create reusable JavaScript functions for complex data transformations</p>
                  <button type="button" class="btn btn-warning" onclick="createFunction()">
                    <i class="bi bi-plus-circle"></i> Create Function
                  </button>
                </div>
              </div>
            </div>

            <!-- Example Functions -->
            <div class="card bg-light mt-3">
              <div class="card-body">
                <h6 class="card-title"><i class="bi bi-lightbulb"></i> Example Functions</h6>
                <div class="small">
                  <p class="mb-2"><strong>Format Currency:</strong></p>
                  <pre class="bg-white p-2 mb-3">function formatCurrency(value, currency = 'USD') {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: currency
  }).format(value);
}</pre>

                  <p class="mb-2"><strong>Calculate Discount:</strong></p>
                  <pre class="bg-white p-2 mb-0">function calculateDiscount(price, discountPercent) {
  return price * (1 - discountPercent / 100);
}</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Create/Edit Variable Modal -->
  <div class="modal fade" id="variableModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create Variable</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="variable-form">
            <div class="mb-3">
              <label for="var-name" class="form-label">Variable Name *</label>
              <input type="text" class="form-control" id="var-name" required
                     placeholder="e.g., fullName">
              <div class="form-text">Use camelCase naming convention</div>
            </div>

            <div class="mb-3">
              <label for="var-expression" class="form-label">JSONLex Expression *</label>
              <textarea class="form-control" id="var-expression" rows="3" required
                        placeholder="e.g., $.firstName + ' ' + $.lastName"></textarea>
              <div class="form-text">Use $ to reference data fields</div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="var-type" class="form-label">Return Type</label>
                <select class="form-select" id="var-type">
                  <option value="string">String</option>
                  <option value="number">Number</option>
                  <option value="boolean">Boolean</option>
                  <option value="date">Date</option>
                  <option value="array">Array</option>
                  <option value="object">Object</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="var-scope" class="form-label">Scope</label>
                <select class="form-select" id="var-scope">
                  <option value="global">Global</option>
                  <option value="query">Query</option>
                  <option value="visualization">Visualization</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label for="var-description" class="form-label">Description</label>
              <textarea class="form-control" id="var-description" rows="2"
                        placeholder="Describe what this variable computes..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" onclick="saveVariable()">
            Save Variable
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create/Edit Function Modal -->
  <div class="modal fade" id="functionModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create Function</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="function-form">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="func-name" class="form-label">Function Name *</label>
                <input type="text" class="form-control" id="func-name" required
                       placeholder="e.g., calculateTotal">
              </div>
              <div class="col-md-6">
                <label for="func-params" class="form-label">Parameters</label>
                <input type="text" class="form-control" id="func-params"
                       placeholder="e.g., price, quantity, taxRate">
                <div class="form-text">Comma-separated parameter names</div>
              </div>
            </div>

            <div class="mb-3">
              <label for="func-code" class="form-label">Function Code *</label>
              <textarea class="form-control font-monospace" id="func-code" rows="8" required
                        placeholder="// Your JavaScript code here&#10;return result;"></textarea>
            </div>

            <div class="mb-3">
              <label for="func-description" class="form-label">Description</label>
              <textarea class="form-control" id="func-description" rows="2"
                        placeholder="Describe what this function does..."></textarea>
            </div>

            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="func-async">
              <label class="form-check-label" for="func-async">
                Async function (can use await)
              </label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" onclick="saveFunction()">
            Save Function
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Core Pulse JS -->
  <script src="/static/js/pulse-core.js"></script>

  <script>
    let variableModal, functionModal;

    $(document).ready(function() {
      variableModal = new bootstrap.Modal('#variableModal');
      functionModal = new bootstrap.Modal('#functionModal');
    });

    function createVariable() {
      $('#var-name').val('');
      $('#var-expression').val('');
      $('#var-type').val('string');
      $('#var-scope').val('global');
      $('#var-description').val('');
      variableModal.show();
    }

    function createFunction() {
      $('#func-name').val('');
      $('#func-params').val('');
      $('#func-code').val('');
      $('#func-description').val('');
      $('#func-async').prop('checked', false);
      functionModal.show();
    }

    function saveVariable() {
      const form = $('#variable-form')[0];
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const variableData = {
        name: $('#var-name').val(),
        expression: $('#var-expression').val(),
        type: $('#var-type').val(),
        scope: $('#var-scope').val(),
        description: $('#var-description').val()
      };

      PulseUtils.showLoading();

      // TODO: Implement variable save API
      setTimeout(() => {
        PulseUtils.hideLoading();
        variableModal.hide();
        PulseUtils.showAlert('Variable saved successfully! (API not yet implemented)', 'info');
      }, 500);
    }

    function saveFunction() {
      const form = $('#function-form')[0];
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const functionData = {
        name: $('#func-name').val(),
        parameters: $('#func-params').val().split(',').map(p => p.trim()).filter(Boolean),
        code: $('#func-code').val(),
        description: $('#func-description').val(),
        isAsync: $('#func-async').is(':checked')
      };

      PulseUtils.showLoading();

      // TODO: Implement function save API
      setTimeout(() => {
        PulseUtils.hideLoading();
        functionModal.hide();
        PulseUtils.showAlert('Function saved successfully! (API not yet implemented)', 'info');
      }, 500);
    }

    function editVariable(id) {
      // TODO: Load variable data and show modal
      createVariable();
    }

    function deleteVariable(id) {
      PulseModals.showDeleteConfirm('Variable', 'this variable', function() {
        PulseUtils.showAlert('Variable deletion not yet implemented', 'info');
      });
    }
  </script>

  <%- include('../shared/body-extra') %>
</body>
</html>
