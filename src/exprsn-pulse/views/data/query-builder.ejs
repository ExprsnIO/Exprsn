<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | Exprsn Pulse</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/static/css/pulse.css">
  <!-- Monaco Editor -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/editor/editor.main.css">

  <%- include('../shared/head-extra') %>

  <style>
    #editor-container {
      height: 400px;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
    }

    .query-preview {
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <%- include('../shared/navbar') %>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
        <%- include('../shared/sidebar') %>
      </nav>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">
            <i class="bi bi-code-slash text-info"></i>
            <%= query ? 'Edit Query' : 'Create Query' %>
          </h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-success me-2" onclick="testQuery()">
              <i class="bi bi-play-fill"></i> Test Query
            </button>
            <button type="button" class="btn btn-primary" onclick="saveQuery()">
              <i class="bi bi-save"></i> Save Query
            </button>
          </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container"></div>

        <!-- Query Builder Form -->
        <form id="query-form">
          <div class="row">
            <!-- Left Column: Query Definition -->
            <div class="col-lg-8">
              <div class="card shadow mb-4">
                <div class="card-header">
                  <h6 class="m-0 font-weight-bold text-info">Query Definition</h6>
                </div>
                <div class="card-body">
                  <!-- Basic Info -->
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="query-name" class="form-label">Query Name *</label>
                      <input type="text" class="form-control" id="query-name"
                             value="<%= query ? query.name : '' %>" required
                             placeholder="e.g., Monthly Sales">
                    </div>
                    <div class="col-md-6">
                      <label for="query-type" class="form-label">Query Type *</label>
                      <select class="form-select" id="query-type" required>
                        <option value="">-- Select Type --</option>
                        <option value="sql" <%= query && query.queryType === 'sql' ? 'selected' : '' %>>SQL</option>
                        <option value="rest" <%= query && query.queryType === 'rest' ? 'selected' : '' %>>REST API</option>
                        <option value="jsonlex" <%= query && query.queryType === 'jsonlex' ? 'selected' : '' %>>JSONLex</option>
                        <option value="javascript" <%= query && query.queryType === 'javascript' ? 'selected' : '' %>>JavaScript</option>
                      </select>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="query-description" class="form-label">Description</label>
                    <textarea class="form-control" id="query-description" rows="2"
                              placeholder="Describe what this query does..."><%= query ? (query.description || '') : '' %></textarea>
                  </div>

                  <div class="mb-3">
                    <label for="data-source" class="form-label">Data Source *</label>
                    <select class="form-select" id="data-source" required>
                      <option value="">-- Select Data Source --</option>
                      <% dataSources.forEach(ds => { %>
                        <option value="<%= ds.id %>" data-type="<%= ds.type %>"
                                <%= query && query.dataSourceId === ds.id ? 'selected' : '' %>>
                          <%= ds.name %> (<%= ds.type %>)
                        </option>
                      <% }) %>
                    </select>
                  </div>

                  <!-- Query Editor -->
                  <div class="mb-3">
                    <label class="form-label">Query Content *</label>
                    <div id="editor-container"></div>
                    <div class="form-text">
                      <span id="editor-help">
                        Select a query type to begin editing
                      </span>
                    </div>
                  </div>

                  <!-- Cache Settings -->
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="cache-enabled"
                               <%= query && query.cacheEnabled ? 'checked' : '' %>>
                        <label class="form-check-label" for="cache-enabled">
                          Enable caching
                        </label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="cache-ttl" class="form-label">Cache TTL (seconds)</label>
                      <input type="number" class="form-control" id="cache-ttl"
                             value="<%= query ? (query.cacheTTL || 300) : 300 %>"
                             min="0" step="60">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column: Parameters & Preview -->
            <div class="col-lg-4">
              <!-- Parameters -->
              <div class="card shadow mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h6 class="m-0 font-weight-bold text-info">Parameters</h6>
                  <button type="button" class="btn btn-sm btn-outline-info" onclick="addParameter()">
                    <i class="bi bi-plus-circle"></i> Add
                  </button>
                </div>
                <div class="card-body">
                  <div id="parameters-list">
                    <p class="text-muted small">No parameters defined</p>
                  </div>
                </div>
              </div>

              <!-- Query Statistics -->
              <div class="card shadow mb-4">
                <div class="card-header">
                  <h6 class="m-0 font-weight-bold text-info">Query Statistics</h6>
                </div>
                <div class="card-body">
                  <div id="query-stats">
                    <p class="small mb-1"><strong>Lines:</strong> <span id="stat-lines">0</span></p>
                    <p class="small mb-1"><strong>Characters:</strong> <span id="stat-chars">0</span></p>
                    <p class="small mb-0"><strong>Status:</strong> <span class="badge bg-secondary" id="stat-status">Not tested</span></p>
                  </div>
                </div>
              </div>

              <!-- Quick Reference -->
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title"><i class="bi bi-info-circle"></i> Quick Reference</h6>
                  <div id="quick-ref">
                    <p class="small text-muted">Select a query type to see syntax help</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>

        <!-- Test Results -->
        <div id="test-results" class="card shadow mt-4" style="display: none;">
          <div class="card-header">
            <h6 class="m-0 font-weight-bold text-success">Test Results</h6>
          </div>
          <div class="card-body">
            <div id="test-results-content"></div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Monaco Editor -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
  <!-- Core Pulse JS -->
  <script src="/static/js/pulse-core.js"></script>

  <script>
    let editor;
    let parameters = <%= query && query.parameters ? JSON.stringify(query.parameters) : '[]' %>;

    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });

    require(['vs/editor/editor.main'], function() {
      // Initialize Monaco editor
      editor = monaco.editor.create(document.getElementById('editor-container'), {
        value: `<%= query && query.queryContent ? query.queryContent.replace(/\n/g, '\\n').replace(/"/g, '\\"') : '' %>`,
        language: 'sql',
        theme: 'vs',
        automaticLayout: true,
        minimap: { enabled: false }
      });

      // Update stats on content change
      editor.onDidChangeModelContent(function() {
        updateQueryStats();
      });

      // Initial stats
      updateQueryStats();
    });

    // Change editor language based on query type
    $('#query-type').on('change', function() {
      const type = $(this).val();
      let language = 'plaintext';
      let help = '';
      let reference = '';

      switch(type) {
        case 'sql':
          language = 'sql';
          help = 'Write SQL SELECT statements. Use {{paramName}} for parameters.';
          reference = `
            <p class="small mb-1"><code>SELECT * FROM users</code></p>
            <p class="small mb-1"><code>WHERE id = {{userId}}</code></p>
            <p class="small mb-0"><code>ORDER BY created_at DESC</code></p>
          `;
          break;
        case 'rest':
          language = 'json';
          help = 'Define REST API call configuration as JSON';
          reference = `
            <pre class="small mb-0">{
  "method": "GET",
  "path": "/api/users",
  "params": {{params}}
}</pre>
          `;
          break;
        case 'jsonlex':
          language = 'javascript';
          help = 'Write JSONLex expressions to transform data';
          reference = `
            <p class="small mb-1"><code>$.data.users</code></p>
            <p class="small mb-1"><code>| filter($.age > 18)</code></p>
            <p class="small mb-0"><code>| map({ name: $.fullName })</code></p>
          `;
          break;
        case 'javascript':
          language = 'javascript';
          help = 'Write JavaScript function that returns data';
          reference = `
            <pre class="small mb-0">async function query(params) {
  // Your code here
  return data;
}</pre>
          `;
          break;
      }

      monaco.editor.setModelLanguage(editor.getModel(), language);
      $('#editor-help').text(help);
      $('#quick-ref').html(reference);
    });

    // Trigger initial setup
    if ($('#query-type').val()) {
      $('#query-type').trigger('change');
    }

    function updateQueryStats() {
      const content = editor.getValue();
      const lines = content.split('\n').length;
      const chars = content.length;

      $('#stat-lines').text(lines);
      $('#stat-chars').text(chars);
    }

    // Add parameter
    function addParameter() {
      const name = prompt('Parameter name (e.g., userId):');
      if (!name) return;

      const type = prompt('Parameter type (text, number, date, select):');
      if (!type) return;

      parameters.push({ name, type, required: true });
      renderParameters();
    }

    function renderParameters() {
      if (parameters.length === 0) {
        $('#parameters-list').html('<p class="text-muted small">No parameters defined</p>');
        return;
      }

      let html = '<div class="list-group list-group-flush">';
      parameters.forEach((param, index) => {
        html += `
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>${param.name}</strong>
              <br><small class="text-muted">${param.type}</small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeParameter(${index})">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;
      });
      html += '</div>';

      $('#parameters-list').html(html);
    }

    function removeParameter(index) {
      parameters.splice(index, 1);
      renderParameters();
    }

    // Initial parameter render
    renderParameters();

    // Test query
    async function testQuery() {
      const queryData = {
        name: $('#query-name').val(),
        queryType: $('#query-type').val(),
        dataSourceId: $('#data-source').val(),
        queryContent: editor.getValue()
      };

      if (!queryData.queryType || !queryData.dataSourceId || !queryData.queryContent) {
        PulseUtils.showAlert('Please fill in all required fields', 'warning');
        return;
      }

      $('#test-results').show();
      $('#test-results-content').html(`
        <div class="text-center py-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Testing query...</span>
          </div>
        </div>
      `);

      try {
        const result = await PulseAPI.queries.test(queryData);
        const data = result.data;

        if (data && data.rows && data.rows.length > 0) {
          const columns = Object.keys(data.rows[0]);
          let html = `
            <p class="text-success"><i class="bi bi-check-circle"></i> Query executed successfully</p>
            <p class="text-muted">Returned ${data.rows.length} rows in ${data.executionTime || 0}ms</p>
            <div class="table-responsive query-preview">
              <table class="table table-sm table-striped">
                <thead><tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr></thead>
                <tbody>
                  ${data.rows.slice(0, 10).map(row => `
                    <tr>${columns.map(col => `<td>${row[col]}</td>`).join('')}</tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${data.rows.length > 10 ? `<p class="text-muted small">Showing first 10 of ${data.rows.length} rows</p>` : ''}
          `;
          $('#test-results-content').html(html);
          $('#stat-status').removeClass().addClass('badge bg-success').text('Test passed');
        } else {
          $('#test-results-content').html('<p class="text-warning">Query executed but returned no data</p>');
          $('#stat-status').removeClass().addClass('badge bg-warning').text('No data');
        }
      } catch (error) {
        $('#test-results-content').html(`
          <p class="text-danger"><i class="bi bi-x-circle"></i> Query failed</p>
          <pre class="bg-light p-3">${error.message}</pre>
        `);
        $('#stat-status').removeClass().addClass('badge bg-danger').text('Test failed');
      }
    }

    // Save query
    async function saveQuery() {
      const queryData = {
        name: $('#query-name').val(),
        description: $('#query-description').val(),
        queryType: $('#query-type').val(),
        dataSourceId: $('#data-source').val(),
        queryContent: editor.getValue(),
        parameters: parameters,
        cacheEnabled: $('#cache-enabled').is(':checked'),
        cacheTTL: parseInt($('#cache-ttl').val())
      };

      if (!queryData.name || !queryData.queryType || !queryData.dataSourceId || !queryData.queryContent) {
        PulseUtils.showAlert('Please fill in all required fields', 'warning');
        return;
      }

      try {
        PulseUtils.showLoading();

        <% if (query) { %>
          await PulseAPI.queries.update('<%= query.id %>', queryData);
          PulseUtils.showAlert('Query updated successfully!', 'success');
        <% } else { %>
          const result = await PulseAPI.queries.create(queryData);
          PulseUtils.showAlert('Query created successfully!', 'success');
          setTimeout(() => {
            window.location.href = '/data/queries/' + result.data.id + '/edit';
          }, 1000);
        <% } %>

        PulseUtils.hideLoading();
      } catch (error) {
        PulseUtils.hideLoading();
        PulseUtils.showAlert('Failed to save query: ' + error.message, 'danger');
      }
    }
  </script>

  <%- include('../shared/body-extra') %>
</body>
</html>
