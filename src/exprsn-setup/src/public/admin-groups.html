<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Groups Management - Exprsn Setup</title>

  <!-- Bootstrap 5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f8f9fa;
    }

    .navbar {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card {
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }

    .stats-card {
      border-left: 4px solid #0d6efd;
    }

    .table-container {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
    }

    .badge-status {
      padding: 0.35em 0.65em;
      font-size: 0.875em;
    }

    .group-actions .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }

    .loading-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }

    .loading-spinner.show {
      display: block;
    }

    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">
        <i class="bi bi-gear-fill"></i> Exprsn Setup
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/admin/database">
          <i class="bi bi-database"></i> Database
        </a>
        <a class="nav-link" href="/admin/redis">
          <i class="bi bi-server"></i> Redis
        </a>
        <a class="nav-link active" href="/admin/groups">
          <i class="bi bi-people"></i> Groups
        </a>
        <a class="nav-link" href="/admin/roles">
          <i class="bi bi-shield"></i> Roles
        </a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container-fluid mt-4">
    <!-- Page Header -->
    <div class="row mb-4">
      <div class="col">
        <h2><i class="bi bi-people-fill"></i> Groups Management</h2>
        <p class="text-muted">Manage organizational groups and memberships</p>
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" id="create-group-btn">
          <i class="bi bi-plus-circle"></i> Create Group
        </button>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="stats-container">
      <div class="col-md-3">
        <div class="card stats-card">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Total Groups</h6>
            <h3 class="card-title mb-0" id="stat-total">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Active Groups</h6>
            <h3 class="card-title mb-0" id="stat-active">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Total Members</h6>
            <h3 class="card-title mb-0" id="stat-members">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">By Type</h6>
            <div id="stat-by-type">-</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <input type="text" class="form-control" id="search-input" placeholder="Search groups...">
          </div>
          <div class="col-md-2">
            <select class="form-select" id="type-filter">
              <option value="">All Types</option>
              <option value="organization">Organization</option>
              <option value="department">Department</option>
              <option value="team">Team</option>
              <option value="project">Project</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="visibility-filter">
              <option value="">All Visibility</option>
              <option value="public">Public</option>
              <option value="private">Private</option>
              <option value="hidden">Hidden</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="status-filter">
              <option value="">All Status</option>
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" id="reset-filters">
              <i class="bi bi-arrow-clockwise"></i> Reset
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Groups Table -->
    <div class="table-container">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Visibility</th>
              <th>Members</th>
              <th>Status</th>
              <th>Created</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody id="groups-table-body">
            <tr>
              <td colspan="7" class="text-center">
                <div class="spinner-border spinner-border-sm" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                Loading groups...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted" id="pagination-info">Showing 0 groups</div>
        <nav>
          <ul class="pagination pagination-sm mb-0" id="pagination">
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container"></div>

  <!-- Loading Spinner -->
  <div class="loading-spinner">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Socket.IO Client -->
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <!-- Modal Manager -->
  <script src="/js/modal-manager.js"></script>

  <script>
    // Initialize Socket.IO
    const socket = io();

    // State
    let groups = [];
    let currentPage = 1;
    let totalPages = 1;
    let filters = {
      search: '',
      type: '',
      visibility: '',
      isActive: ''
    };

    // Load groups
    async function loadGroups() {
      try {
        const params = new URLSearchParams({
          page: currentPage,
          limit: 25,
          sort: '-created_at',
          ...filters
        });

        const response = await fetch(`/api/groups?${params}`);
        const data = await response.json();

        if (data.success) {
          groups = data.groups;
          totalPages = data.pagination.pages;
          renderGroups();
          renderPagination(data.pagination);
        }
      } catch (error) {
        console.error('Failed to load groups:', error);
        showToast('Failed to load groups', 'danger');
      }
    }

    // Load statistics
    async function loadStats() {
      try {
        const response = await fetch('/api/groups/stats');
        const data = await response.json();

        if (data.success) {
          document.getElementById('stat-total').textContent = data.stats.totalGroups;
          document.getElementById('stat-active').textContent = data.stats.activeGroups;
          document.getElementById('stat-members').textContent = data.stats.totalMembers;

          const byType = Object.entries(data.stats.byType)
            .map(([type, count]) => `<small>${type}: ${count}</small>`)
            .join('<br>');
          document.getElementById('stat-by-type').innerHTML = byType || '<small>-</small>';
        }
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    // Render groups table
    function renderGroups() {
      const tbody = document.getElementById('groups-table-body');

      if (groups.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-muted">No groups found</td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = groups.map(group => `
        <tr>
          <td>
            <strong>${group.name}</strong>
            <br>
            <small class="text-muted">${group.slug}</small>
          </td>
          <td>
            <span class="badge bg-info">${group.type}</span>
          </td>
          <td>
            <span class="badge bg-${group.visibility === 'public' ? 'success' : group.visibility === 'private' ? 'warning' : 'secondary'}">
              ${group.visibility}
            </span>
          </td>
          <td>${group.memberCount}</td>
          <td>
            <span class="badge badge-status ${group.isActive ? 'bg-success' : 'bg-danger'}">
              ${group.isActive ? 'Active' : 'Inactive'}
            </span>
          </td>
          <td>
            <small>${new Date(group.createdAt).toLocaleDateString()}</small>
          </td>
          <td class="text-end group-actions">
            <button class="btn btn-sm btn-outline-primary" onclick="viewGroup('${group.id}')">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-warning" onclick="editGroup('${group.id}')">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteGroup('${group.id}', '${group.name}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    // Render pagination
    function renderPagination(pagination) {
      const paginationEl = document.getElementById('pagination');
      const infoEl = document.getElementById('pagination-info');

      infoEl.textContent = `Showing ${groups.length} of ${pagination.total} groups`;

      if (totalPages <= 1) {
        paginationEl.innerHTML = '';
        return;
      }

      let html = '';

      // Previous button
      html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">Previous</a>
        </li>
      `;

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
              <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
            </li>
          `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }

      // Next button
      html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">Next</a>
        </li>
      `;

      paginationEl.innerHTML = html;
    }

    // Go to page
    function goToPage(page) {
      if (page < 1 || page > totalPages || page === currentPage) return;
      currentPage = page;
      loadGroups();
    }

    // Create group
    function createGroup() {
      modalManager.createEntity({
        entity: 'Group',
        fields: [
          {
            name: 'name',
            label: 'Group Name',
            type: 'text',
            required: true,
            placeholder: 'e.g., Engineering Team'
          },
          {
            name: 'slug',
            label: 'Slug',
            type: 'text',
            placeholder: 'auto-generated from name',
            help: 'Leave blank to auto-generate from name'
          },
          {
            name: 'description',
            label: 'Description',
            type: 'textarea',
            rows: 3
          },
          {
            name: 'type',
            label: 'Type',
            type: 'select',
            required: true,
            options: [
              { value: 'organization', label: 'Organization' },
              { value: 'department', label: 'Department' },
              { value: 'team', label: 'Team' },
              { value: 'project', label: 'Project' },
              { value: 'custom', label: 'Custom' }
            ]
          },
          {
            name: 'visibility',
            label: 'Visibility',
            type: 'select',
            required: true,
            options: [
              { value: 'public', label: 'Public' },
              { value: 'private', label: 'Private' },
              { value: 'hidden', label: 'Hidden' }
            ]
          },
          {
            name: 'isActive',
            label: 'Active',
            type: 'checkbox',
            value: true
          }
        ],
        onSubmit: async (formData) => {
          const response = await fetch('/api/groups', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ...formData,
              isActive: !!formData.isActive
            })
          });

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || 'Failed to create group');
          }

          loadGroups();
          loadStats();
          showToast('Group created successfully', 'success');
        }
      });
    }

    // Edit group
    async function editGroup(groupId) {
      try {
        const response = await fetch(`/api/groups/${groupId}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error('Failed to load group');
        }

        const group = data.group;

        modalManager.editEntity({
          entity: 'Group',
          entityId: groupId,
          data: group,
          fields: [
            {
              name: 'name',
              label: 'Group Name',
              type: 'text',
              required: true
            },
            {
              name: 'slug',
              label: 'Slug',
              type: 'text',
              required: true
            },
            {
              name: 'description',
              label: 'Description',
              type: 'textarea',
              rows: 3
            },
            {
              name: 'type',
              label: 'Type',
              type: 'select',
              required: true,
              options: [
                { value: 'organization', label: 'Organization' },
                { value: 'department', label: 'Department' },
                { value: 'team', label: 'Team' },
                { value: 'project', label: 'Project' },
                { value: 'custom', label: 'Custom' }
              ]
            },
            {
              name: 'visibility',
              label: 'Visibility',
              type: 'select',
              required: true,
              options: [
                { value: 'public', label: 'Public' },
                { value: 'private', label: 'Private' },
                { value: 'hidden', label: 'Hidden' }
              ]
            },
            {
              name: 'isActive',
              label: 'Active',
              type: 'checkbox'
            }
          ],
          onSubmit: async (formData) => {
            const response = await fetch(`/api/groups/${groupId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                ...formData,
                isActive: !!formData.isActive
              })
            });

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Failed to update group');
            }

            loadGroups();
            showToast('Group updated successfully', 'success');
          }
        });
      } catch (error) {
        showToast(error.message, 'danger');
      }
    }

    // Delete group
    function deleteGroup(groupId, groupName) {
      modalManager.deleteEntity({
        entity: 'Group',
        entityId: groupId,
        entityName: groupName,
        onConfirm: async () => {
          try {
            const response = await fetch(`/api/groups/${groupId}`, {
              method: 'DELETE'
            });

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Failed to delete group');
            }

            loadGroups();
            loadStats();
            showToast('Group deleted successfully', 'success');
          } catch (error) {
            showToast(error.message, 'danger');
          }
        }
      });
    }

    // View group
    function viewGroup(groupId) {
      window.location.href = `/admin/groups/${groupId}`;
    }

    // Show toast notification
    function showToast(message, variant = 'info') {
      const toastContainer = document.querySelector('.toast-container');
      const toastId = `toast-${Date.now()}`;

      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${variant} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.id = toastId;
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;

      toastContainer.appendChild(toast);

      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();

      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    // Event Listeners
    document.getElementById('create-group-btn').addEventListener('click', createGroup);

    document.getElementById('search-input').addEventListener('input', (e) => {
      filters.search = e.target.value;
      currentPage = 1;
      loadGroups();
    });

    document.getElementById('type-filter').addEventListener('change', (e) => {
      filters.type = e.target.value;
      currentPage = 1;
      loadGroups();
    });

    document.getElementById('visibility-filter').addEventListener('change', (e) => {
      filters.visibility = e.target.value;
      currentPage = 1;
      loadGroups();
    });

    document.getElementById('status-filter').addEventListener('change', (e) => {
      filters.isActive = e.target.value;
      currentPage = 1;
      loadGroups();
    });

    document.getElementById('reset-filters').addEventListener('click', () => {
      filters = { search: '', type: '', visibility: '', isActive: '' };
      document.getElementById('search-input').value = '';
      document.getElementById('type-filter').value = '';
      document.getElementById('visibility-filter').value = '';
      document.getElementById('status-filter').value = '';
      currentPage = 1;
      loadGroups();
    });

    // Socket.IO event listeners
    socket.on('group:created', () => {
      loadGroups();
      loadStats();
    });

    socket.on('group:updated', () => {
      loadGroups();
    });

    socket.on('group:deleted', () => {
      loadGroups();
      loadStats();
    });

    // Initialize
    loadGroups();
    loadStats();
  </script>
</body>
</html>
