<div class="row">
    <div class="col-12 mb-3">
        <a href="/admin/organizations" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Organizations
        </a>
    </div>
</div>

<div class="row">
    <!-- Organization Profile -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-building text-primary me-2"></i>
                    Organization Profile
                </h5>
            </div>
            <div class="card-body">
                <h4><%= organization.name %></h4>
                <% if (organization.domain) { %>
                <p class="text-muted"><%= organization.domain %></p>
                <% } %>

                <% if (organization.enabled) { %>
                <span class="badge bg-success mb-3">Active</span>
                <% } else { %>
                <span class="badge bg-danger mb-3">Suspended</span>
                <% } %>

                <hr>

                <dl class="row">
                    <dt class="col-sm-5">Org ID:</dt>
                    <dd class="col-sm-7"><small><code><%= organization.id %></code></small></dd>

                    <dt class="col-sm-5">Created:</dt>
                    <dd class="col-sm-7"><small><%= new Date(organization.createdAt).toLocaleString() %></small></dd>

                    <dt class="col-sm-5">Members:</dt>
                    <dd class="col-sm-7"><%= members.length %></dd>

                    <dt class="col-sm-5">Applications:</dt>
                    <dd class="col-sm-7"><%= applications.length %></dd>
                </dl>

                <% if (organization.description) { %>
                <hr>
                <h6>Description</h6>
                <p class="text-muted small"><%= organization.description %></p>
                <% } %>

                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editOrgModal">
                        <i class="bi bi-pencil"></i> Edit Organization
                    </button>
                    <% if (organization.enabled) { %>
                    <button class="btn btn-warning" onclick="toggleOrgStatus('<%= organization.id %>', 'suspend')">
                        <i class="bi bi-pause-circle"></i> Suspend Organization
                    </button>
                    <% } else { %>
                    <button class="btn btn-success" onclick="toggleOrgStatus('<%= organization.id %>', 'activate')">
                        <i class="bi bi-play-circle"></i> Activate Organization
                    </button>
                    <% } %>
                    <button class="btn btn-outline-danger" onclick="deleteOrg('<%= organization.id %>')">
                        <i class="bi bi-trash"></i> Delete Organization
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <!-- Members -->
        <div class="card mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-people text-primary me-2"></i>
                    Members
                </h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addMemberModal">
                    <i class="bi bi-person-plus"></i> Add Member
                </button>
            </div>
            <div class="card-body">
                <% if (members && members.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% members.forEach(member => { %>
                            <tr>
                                <td>
                                    <i class="bi bi-person-circle text-primary me-2"></i>
                                    <%= member.username %>
                                </td>
                                <td><%= member.email %></td>
                                <td><small><%= new Date(member.createdAt).toLocaleDateString() %></small></td>
                                <td>
                                    <a href="/admin/users/<%= member.id %>" class="btn btn-sm btn-outline-primary">
                                        View
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger"
                                            onclick="removeMember('<%= organization.id %>', '<%= member.id %>')">
                                        Remove
                                    </button>
                                </td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
                <% } else { %>
                <p class="text-muted mb-0">No members yet</p>
                <% } %>
            </div>
        </div>

        <!-- Applications -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-grid text-primary me-2"></i>
                    Applications
                </h5>
            </div>
            <div class="card-body">
                <% if (applications && applications.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Client ID</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% applications.forEach(app => { %>
                            <tr>
                                <td>
                                    <i class="bi bi-app-indicator text-primary me-2"></i>
                                    <%= app.name %>
                                </td>
                                <td>
                                    <% if (app.type === 'web') { %>
                                    <span class="badge bg-primary">Web</span>
                                    <% } else if (app.type === 'spa') { %>
                                    <span class="badge bg-info">SPA</span>
                                    <% } else if (app.type === 'native') { %>
                                    <span class="badge bg-success">Native</span>
                                    <% } else { %>
                                    <span class="badge bg-secondary">Service</span>
                                    <% } %>
                                </td>
                                <td><code class="small"><%= app.clientId %></code></td>
                                <td>
                                    <% if (app.enabled) { %>
                                    <span class="badge bg-success">Active</span>
                                    <% } else { %>
                                    <span class="badge bg-danger">Disabled</span>
                                    <% } %>
                                </td>
                                <td>
                                    <a href="/admin/applications/<%= app.id %>" class="btn btn-sm btn-outline-primary">
                                        View
                                    </a>
                                </td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
                <% } else { %>
                <p class="text-muted mb-0">No applications registered</p>
                <% } %>
            </div>
        </div>

        <!-- Settings -->
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-gear text-primary me-2"></i>
                    Organization Settings
                </h5>
            </div>
            <div class="card-body">
                <form id="orgSettingsForm">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="requireEmailDomain"
                                   <%= organization.settings?.requireEmailDomain ? 'checked' : '' %>>
                            <label class="form-check-label" for="requireEmailDomain">
                                Require matching email domain for members
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="allowSelfService"
                                   <%= organization.settings?.allowSelfService ? 'checked' : '' %>>
                            <label class="form-check-label" for="allowSelfService">
                                Allow self-service registration
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enforceMfa"
                                   <%= organization.settings?.enforceMfa ? 'checked' : '' %>>
                            <label class="form-check-label" for="enforceMfa">
                                Enforce MFA for all members
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Save Settings
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Organization Modal -->
<div class="modal fade" id="editOrgModal" tabindex="-1" aria-labelledby="editOrgModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editOrgModalLabel">Edit Organization</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editOrgForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="orgName" class="form-label">Organization Name</label>
                        <input type="text" class="form-control" id="orgName" value="<%= organization.name %>" required>
                    </div>
                    <div class="mb-3">
                        <label for="orgDomain" class="form-label">Domain</label>
                        <input type="text" class="form-control" id="orgDomain" value="<%= organization.domain || '' %>">
                    </div>
                    <div class="mb-3">
                        <label for="orgDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="orgDescription" rows="3"><%= organization.description || '' %></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Member Modal -->
<div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMemberModalLabel">Add Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="userSearch" class="form-label">Search User</label>
                    <input type="text" class="form-control" id="userSearch" placeholder="Search by username or email...">
                </div>
                <div id="userSearchResults"></div>
            </div>
        </div>
    </div>
</div>

<% locals.scripts = `
<script>
    async function toggleOrgStatus(orgId, action) {
        if (confirm(\`Are you sure you want to \${action} this organization?\`)) {
            try {
                const response = await fetch(\`/api/organizations/\${orgId}/\${action}\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Action failed');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred');
            }
        }
    }

    async function deleteOrg(orgId) {
        if (confirm('Are you sure you want to delete this organization? This action cannot be undone.')) {
            try {
                const response = await fetch(\`/api/organizations/\${orgId}\`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    window.location.href = '/admin/organizations';
                } else {
                    alert('Failed to delete organization');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred');
            }
        }
    }

    async function removeMember(orgId, userId) {
        if (confirm('Are you sure you want to remove this member?')) {
            try {
                const response = await fetch(\`/api/organizations/\${orgId}/members/\${userId}\`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to remove member');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred');
            }
        }
    }

    // Edit organization form
    document.getElementById('editOrgForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const orgId = '<%= organization.id %>';
        const data = {
            name: document.getElementById('orgName').value,
            domain: document.getElementById('orgDomain').value,
            description: document.getElementById('orgDescription').value
        };

        try {
            const response = await fetch(\`/api/organizations/\${orgId}\`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to update organization');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred');
        }
    });

    // Organization settings form
    document.getElementById('orgSettingsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const orgId = '<%= organization.id %>';
        const settings = {
            requireEmailDomain: document.getElementById('requireEmailDomain').checked,
            allowSelfService: document.getElementById('allowSelfService').checked,
            enforceMfa: document.getElementById('enforceMfa').checked
        };

        try {
            const response = await fetch(\`/api/organizations/\${orgId}/settings\`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ settings })
            });

            if (response.ok) {
                alert('Settings saved successfully');
            } else {
                alert('Failed to save settings');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred');
        }
    });
</script>
`; %>
