<div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-shield-check text-primary me-2"></i>
            Role & Permission Management
        </h5>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRoleModal">
            <i class="bi bi-plus-circle"></i> Create Role
        </button>
    </div>
    <div class="card-body">
        <!-- Search -->
        <div class="row mb-3">
            <div class="col-md-8">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text"
                           class="form-control"
                           id="roleSearch"
                           placeholder="Search roles by name..."
                           aria-label="Search roles">
                </div>
            </div>
            <div class="col-md-4">
                <select class="form-select" id="scopeFilter" aria-label="Filter by scope">
                    <option value="">All Scopes</option>
                    <option value="system">System</option>
                    <option value="organization">Organization</option>
                    <option value="application">Application</option>
                </select>
            </div>
        </div>

        <!-- Roles Table -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Role Name</th>
                        <th>Description</th>
                        <th>Scope</th>
                        <th>Users</th>
                        <th>Permissions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (roles && roles.length > 0) { %>
                        <% roles.forEach(role => { %>
                        <tr>
                            <td>
                                <i class="bi bi-shield-fill text-primary me-2"></i>
                                <strong><%= role.name %></strong>
                                <% if (role.isSystem) { %>
                                <span class="badge bg-secondary ms-2">System</span>
                                <% } %>
                            </td>
                            <td>
                                <small class="text-muted"><%= role.description || 'No description' %></small>
                            </td>
                            <td>
                                <% if (role.scope === 'system') { %>
                                <span class="badge bg-danger">System</span>
                                <% } else if (role.scope === 'organization') { %>
                                <span class="badge bg-primary">Organization</span>
                                <% } else { %>
                                <span class="badge bg-info">Application</span>
                                <% } %>
                            </td>
                            <td><%= role.userCount || 0 %></td>
                            <td>
                                <% if (role.permissions && role.permissions.length > 0) { %>
                                <span class="badge bg-secondary"><%= role.permissions.length %> permissions</span>
                                <% } else { %>
                                <span class="text-muted">None</span>
                                <% } %>
                            </td>
                            <td class="table-actions">
                                <div class="btn-group" role="group" aria-label="Role actions">
                                    <button class="btn btn-sm btn-outline-primary"
                                            data-action="view"
                                            data-role-id="<%= role.id %>"
                                            data-bs-toggle="modal"
                                            data-bs-target="#viewRoleModal"
                                            aria-label="View role <%= role.name %>">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <% if (!role.isSystem) { %>
                                    <button class="btn btn-sm btn-outline-secondary"
                                            data-action="edit"
                                            data-role-id="<%= role.id %>"
                                            aria-label="Edit role <%= role.name %>">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger"
                                            data-action="delete"
                                            data-role-id="<%= role.id %>"
                                            aria-label="Delete role <%= role.name %>">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <% } %>
                                </div>
                            </td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                No roles found
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Role Modal -->
<div class="modal fade" id="createRoleModal" tabindex="-1" aria-labelledby="createRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createRoleModalLabel">
                    <i class="bi bi-shield-check text-primary me-2"></i>
                    Create New Role
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createRoleForm" method="POST" action="/api/roles">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="roleName" class="form-label">Role Name</label>
                        <input type="text" class="form-control" id="roleName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="roleDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="roleDescription" name="description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="roleScope" class="form-label">Scope</label>
                        <select class="form-select" id="roleScope" name="scope" required>
                            <option value="">Select scope...</option>
                            <option value="system">System-wide</option>
                            <option value="organization">Organization</option>
                            <option value="application">Application</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-muted">User Management</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="permissions[]" value="users:read" id="perm1">
                                        <label class="form-check-label" for="perm1">Read Users</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="permissions[]" value="users:write" id="perm2">
                                        <label class="form-check-label" for="perm2">Write Users</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="permissions[]" value="users:delete" id="perm3">
                                        <label class="form-check-label" for="perm3">Delete Users</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted">Organization Management</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="permissions[]" value="orgs:read" id="perm4">
                                        <label class="form-check-label" for="perm4">Read Organizations</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="permissions[]" value="orgs:write" id="perm5">
                                        <label class="form-check-label" for="perm5">Write Organizations</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="permissions[]" value="orgs:delete" id="perm6">
                                        <label class="form-check-label" for="perm6">Delete Organizations</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted">Application Management</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="permissions[]" value="apps:read" id="perm7">
                                        <label class="form-check-label" for="perm7">Read Applications</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="permissions[]" value="apps:write" id="perm8">
                                        <label class="form-check-label" for="perm8">Write Applications</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="permissions[]" value="apps:delete" id="perm9">
                                        <label class="form-check-label" for="perm9">Delete Applications</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted">Administration</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="permissions[]" value="admin:*" id="perm10">
                                        <label class="form-check-label" for="perm10">Full Admin Access</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="permissions[]" value="roles:manage" id="perm11">
                                        <label class="form-check-label" for="perm11">Manage Roles</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Role</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Role Modal -->
<div class="modal fade" id="viewRoleModal" tabindex="-1" aria-labelledby="viewRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewRoleModalLabel">
                    <i class="bi bi-shield-check text-primary me-2"></i>
                    Role Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="roleDetailsContent">
                Loading...
            </div>
        </div>
    </div>
</div>

<% locals.scripts = `
<script>
    // Role search
    document.getElementById('roleSearch').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');

        rows.forEach(row => {
            const name = row.cells[0]?.textContent.toLowerCase() || '';
            const description = row.cells[1]?.textContent.toLowerCase() || '';

            if (name.includes(searchTerm) || description.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Scope filter
    document.getElementById('scopeFilter').addEventListener('change', function(e) {
        const scope = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');

        rows.forEach(row => {
            const scopeBadge = row.cells[2]?.textContent.toLowerCase() || '';

            if (!scope || scopeBadge.includes(scope)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // View role details
    document.querySelectorAll('[data-action="view"]').forEach(btn => {
        btn.addEventListener('click', async function() {
            const roleId = this.dataset.roleId;
            const content = document.getElementById('roleDetailsContent');

            content.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';

            try {
                const response = await fetch(\`/api/roles/\${roleId}\`);
                if (response.ok) {
                    const role = await response.json();
                    content.innerHTML = \`
                        <dl class="row">
                            <dt class="col-sm-4">Name:</dt>
                            <dd class="col-sm-8">\${role.name}</dd>

                            <dt class="col-sm-4">Description:</dt>
                            <dd class="col-sm-8">\${role.description || 'N/A'}</dd>

                            <dt class="col-sm-4">Scope:</dt>
                            <dd class="col-sm-8"><span class="badge bg-primary">\${role.scope}</span></dd>

                            <dt class="col-sm-4">Permissions:</dt>
                            <dd class="col-sm-8">
                                \${role.permissions && role.permissions.length > 0
                                    ? role.permissions.map(p => \`<span class="badge bg-secondary me-1">\${p}</span>\`).join('')
                                    : 'None'}
                            </dd>
                        </dl>
                    \`;
                } else {
                    content.innerHTML = '<div class="alert alert-danger">Failed to load role details</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                content.innerHTML = '<div class="alert alert-danger">An error occurred</div>';
            }
        });
    });

    // Role actions
    document.querySelectorAll('[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', async function() {
            const roleId = this.dataset.roleId;

            if (confirm('Are you sure you want to delete this role? This action cannot be undone.')) {
                try {
                    const response = await fetch(\`/api/roles/\${roleId}\`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete role. Please try again.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                }
            }
        });
    });
</script>
`; %>
