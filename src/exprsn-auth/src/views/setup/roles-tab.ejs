<!-- Roles Tab -->
<div class="tab-pane fade" id="roles" role="tabpanel">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3><i class="bi bi-shield"></i> Roles & Permissions</h3>
    <div class="d-flex gap-2">
      <a href="/admin/roles" class="btn btn-outline-primary">
        <i class="bi bi-gear"></i> Manage Roles
      </a>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRoleModal">
        <i class="bi bi-plus-circle"></i> Create Role
      </button>
    </div>
  </div>

  <div id="rolesList">
    <p class="text-muted">Loading roles...</p>
  </div>
</div>

<!-- Create Role Modal -->
<div class="modal fade" id="createRoleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-shield"></i> Create Role</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="createRoleForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Role Name *</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Priority</label>
            <input type="number" class="form-control" name="priority" value="0" min="0">
            <small class="text-muted">Higher priority roles override lower ones</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Role</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.getElementById('createRoleForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);

  const result = await api.post('/setup/api/roles', data);
  if (result.success) {
    bootstrap.Modal.getInstance(document.getElementById('createRoleModal')).hide();
    showAlert('Role created successfully!', 'success');
    loadRoles();
    e.target.reset();
  } else {
    showAlert('Failed to create role: ' + result.error, 'danger');
  }
});

async function loadRoles() {
  const result = await api.get('/setup/api/roles');
  if (result.success) {
    const roles = result.data;
    const html = roles.length > 0 ? `
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Priority</th>
              <th>Service Access</th>
            </tr>
          </thead>
          <tbody>
            ${roles.map(r => `
              <tr>
                <td>
                  <strong>${r.name}</strong><br>
                  <small class="text-muted">${r.description || ''}</small>
                </td>
                <td>
                  <span class="badge bg-${r.isSystem ? 'warning' : 'primary'}">${r.type}</span>
                </td>
                <td>${r.priority}</td>
                <td>
                  ${r.serviceAccess?.length > 0
                    ? r.serviceAccess.map(s => `<span class="badge bg-info">${s}</span>`).join(' ')
                    : '<span class="text-muted">None</span>'
                  }
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    ` : '<p class="text-muted">No custom roles yet. System roles are created automatically.</p>';
    document.getElementById('rolesList').innerHTML = html;
  }
}

document.getElementById('roles-tab').addEventListener('shown.bs.tab', loadRoles);
</script>
