<!-- OAuth2 Clients Tab -->
<div class="tab-pane fade" id="oauth2" role="tabpanel">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3><i class="bi bi-key"></i> OAuth2 Clients</h3>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createClientModal">
      <i class="bi bi-plus-circle"></i> Create Client
    </button>
  </div>

  <div id="oauth2ClientsList" class="table-container">
    <p class="text-muted">Loading clients...</p>
  </div>
</div>

<!-- Create OAuth2 Client Modal -->
<div class="modal fade" id="createClientModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-key"></i> Create OAuth2 Client</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="createClientForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Client Name *</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Redirect URIs (one per line)</label>
            <textarea class="form-control" name="redirectUris" rows="3" placeholder="http://localhost:3000/callback"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Client Type</label>
            <select class="form-select" name="type">
              <option value="confidential">Confidential (Server-side app)</option>
              <option value="public">Public (SPA/Mobile app)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Client</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.getElementById('createClientForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = {
    name: formData.get('name'),
    description: formData.get('description'),
    redirectUris: formData.get('redirectUris').split('\n').filter(u => u.trim()),
    type: formData.get('type')
  };

  const result = await api.post('/setup/api/oauth2/clients', data);
  if (result.success) {
    bootstrap.Modal.getInstance(document.getElementById('createClientModal')).hide();
    showAlert(`Client created! Client ID: ${result.data.clientId}<br>Client Secret: ${result.data.clientSecret}<br><strong>Save the secret now, it won't be shown again!</strong>`, 'warning');
    loadOAuth2Clients();
    e.target.reset();
  } else {
    showAlert('Failed to create client: ' + result.error, 'danger');
  }
});

async function loadOAuth2Clients() {
  const result = await api.get('/setup/api/oauth2/clients');
  if (result.success) {
    const clients = result.data;
    const html = clients.length > 0 ? `
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Client ID</th>
            <th>Type</th>
            <th>Redirect URIs</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${clients.map(c => `
            <tr>
              <td><strong>${c.name}</strong><br><small class="text-muted">${c.description || ''}</small></td>
              <td><code>${c.clientId}</code></td>
              <td><span class="badge bg-${c.type === 'confidential' ? 'primary' : 'info'}">${c.type}</span></td>
              <td><small>${c.redirectUris.join(', ')}</small></td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="deleteClient('${c.id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    ` : '<p class="text-muted">No OAuth2 clients yet. Create one to get started.</p>';
    document.getElementById('oauth2ClientsList').innerHTML = html;
  }
}

async function deleteClient(id) {
  if (confirm('Delete this OAuth2 client? This cannot be undone.')) {
    await api.delete(`/setup/api/oauth2/clients/${id}`);
    showAlert('Client deleted successfully');
    loadOAuth2Clients();
  }
}

document.getElementById('oauth2-tab').addEventListener('shown.bs.tab', loadOAuth2Clients);
</script>
