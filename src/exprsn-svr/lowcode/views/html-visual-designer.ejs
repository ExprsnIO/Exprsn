<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Visual Designer</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Interact.js for Drag & Drop -->
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      overflow: hidden;
      height: 100vh;
    }

    /* Top Toolbar */
    .top-toolbar {
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .toolbar-title {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .toolbar-actions {
      display: flex;
      gap: 10px;
    }

    .toolbar-btn {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .toolbar-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .toolbar-btn.primary {
      background: #28a745;
      border-color: #28a745;
    }

    .toolbar-btn.primary:hover {
      background: #218838;
    }

    /* Main Layout */
    .designer-container {
      display: flex;
      height: calc(100vh - 60px);
    }

    /* Left Panel - Components */
    .left-panel {
      width: 280px;
      background: #f8f9fa;
      border-right: 1px solid #dee2e6;
      overflow-y: auto;
      padding: 20px;
    }

    .panel-section {
      margin-bottom: 25px;
    }

    .panel-title {
      font-size: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
      color: #6c757d;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }

    .component-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .component-item {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 15px 10px;
      text-align: center;
      cursor: grab;
      transition: all 0.3s ease;
      user-select: none;
    }

    .component-item:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .component-item:active {
      cursor: grabbing;
    }

    .component-icon {
      font-size: 1.5rem;
      color: #667eea;
      margin-bottom: 8px;
    }

    .component-name {
      font-size: 0.75rem;
      font-weight: 600;
      color: #495057;
    }

    /* Center Canvas */
    .canvas-container {
      flex: 1;
      background: #e9ecef;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .canvas-toolbar {
      height: 50px;
      background: white;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 0 20px;
    }

    .device-btn {
      background: transparent;
      border: 2px solid #dee2e6;
      color: #6c757d;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .device-btn.active {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .canvas-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
      overflow: auto;
    }

    .canvas {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      min-height: 600px;
      position: relative;
      transition: all 0.3s ease;
    }

    .canvas.desktop {
      width: 100%;
      max-width: 1200px;
    }

    .canvas.tablet {
      width: 768px;
    }

    .canvas.mobile {
      width: 375px;
    }

    /* Canvas Elements */
    .canvas-element {
      position: relative;
      margin: 10px;
      padding: 15px;
      border: 2px dashed transparent;
      border-radius: 4px;
      transition: all 0.2s ease;
      cursor: move;
      min-height: 50px;
    }

    .canvas-element:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .canvas-element.selected {
      border-color: #667eea;
      border-style: solid;
      background: rgba(102, 126, 234, 0.1);
    }

    .element-controls {
      position: absolute;
      top: -30px;
      right: 0;
      display: none;
      gap: 5px;
    }

    .canvas-element.selected .element-controls,
    .canvas-element:hover .element-controls {
      display: flex;
    }

    .control-btn {
      background: #667eea;
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .control-btn:hover {
      background: #5568d3;
    }

    .control-btn.delete {
      background: #dc3545;
    }

    .control-btn.delete:hover {
      background: #c82333;
    }

    .dropzone {
      border: 2px dashed #adb5bd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: #6c757d;
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px;
    }

    .dropzone.drag-over {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    /* Right Panel - Properties */
    .right-panel {
      width: 320px;
      background: #f8f9fa;
      border-left: 1px solid #dee2e6;
      overflow-y: auto;
      padding: 20px;
    }

    .property-group {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .property-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
      display: block;
    }

    .property-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }

    .property-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .property-row {
      margin-bottom: 12px;
    }

    .property-row:last-child {
      margin-bottom: 0;
    }

    .color-picker-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .color-preview {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      border: 2px solid #dee2e6;
      cursor: pointer;
    }

    .spacing-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
    }

    .empty-state-icon {
      font-size: 3rem;
      color: #dee2e6;
      margin-bottom: 15px;
    }

    /* Layers Panel */
    .layers-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .layer-item {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
    }

    .layer-item:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .layer-item.selected {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .layer-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .layer-icon {
      color: #667eea;
      font-size: 0.875rem;
    }

    .layer-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: #495057;
    }

    .layer-actions {
      display: flex;
      gap: 5px;
    }

    .layer-action-btn {
      background: transparent;
      border: none;
      color: #6c757d;
      cursor: pointer;
      padding: 4px;
      font-size: 0.75rem;
    }

    .layer-action-btn:hover {
      color: #495057;
    }
  </style>
</head>
<body>
  <!-- Top Toolbar -->
  <div class="top-toolbar">
    <div class="toolbar-left">
      <div class="toolbar-title">
        <i class="fas fa-magic me-2"></i>Visual Designer
      </div>
      <div id="projectName" class="text-white-50">Loading...</div>
    </div>
    <div class="toolbar-actions">
      <button class="toolbar-btn" onclick="toggleMode()">
        <i class="fas fa-code me-1"></i>Code View
      </button>
      <button class="toolbar-btn" onclick="previewPage()">
        <i class="fas fa-eye me-1"></i>Preview
      </button>
      <button class="toolbar-btn primary" onclick="savePage()">
        <i class="fas fa-save me-1"></i>Save
      </button>
    </div>
  </div>

  <!-- Main Designer Container -->
  <div class="designer-container">
    <!-- Left Panel - Components & Layers -->
    <div class="left-panel">
      <!-- Components Section -->
      <div class="panel-section">
        <div class="panel-title">
          <i class="fas fa-th me-2"></i>Components
        </div>
        <div class="component-list" id="componentPalette">
          <!-- Components will be loaded here -->
        </div>
      </div>

      <!-- Layers Section -->
      <div class="panel-section">
        <div class="panel-title">
          <i class="fas fa-layer-group me-2"></i>Layers
        </div>
        <ul class="layers-list" id="layersList">
          <!-- Layers will be rendered here -->
        </ul>
      </div>
    </div>

    <!-- Center Canvas -->
    <div class="canvas-container">
      <!-- Canvas Toolbar -->
      <div class="canvas-toolbar">
        <button class="device-btn active" data-device="desktop" onclick="setDevice('desktop')">
          <i class="fas fa-desktop"></i>
        </button>
        <button class="device-btn" data-device="tablet" onclick="setDevice('tablet')">
          <i class="fas fa-tablet-alt"></i>
        </button>
        <button class="device-btn" data-device="mobile" onclick="setDevice('mobile')">
          <i class="fas fa-mobile-alt"></i>
        </button>
        <div class="ms-3 text-muted" id="canvasSize">1200px</div>
      </div>

      <!-- Canvas Wrapper -->
      <div class="canvas-wrapper">
        <div class="canvas desktop" id="canvas">
          <div class="dropzone" id="mainDropzone">
            <div>
              <div class="empty-state-icon">
                <i class="fas fa-hand-pointer"></i>
              </div>
              <div>Drag components here to start building</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Properties -->
    <div class="right-panel">
      <div class="panel-title mb-3">
        <i class="fas fa-sliders-h me-2"></i>Properties
      </div>

      <div id="propertiesPanel">
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-mouse-pointer"></i>
          </div>
          <div>Select an element to edit its properties</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Global state
    let projectId = new URLSearchParams(window.location.search).get('projectId');
    let currentFile = null;
    let selectedElement = null;
    let components = [];
    let elements = [];
    let elementCounter = 0;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      if (!projectId) {
        alert('No project ID provided');
        window.location.href = '/lowcode/html-projects';
        return;
      }

      await loadProject();
      await loadComponents();
      initializeDragAndDrop();
    });

    // Load project
    async function loadProject() {
      try {
        const response = await fetch(`/lowcode/api/html-projects/${projectId}`);
        const result = await response.json();

        if (result.success) {
          document.getElementById('projectName').textContent = result.data.name;
        }
      } catch (error) {
        console.error('Error loading project:', error);
      }
    }

    // Load components
    async function loadComponents() {
      try {
        const response = await fetch('/lowcode/api/html-components');
        const result = await response.json();

        if (result.success) {
          components = result.data.components;
          renderComponentPalette();
        }
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    // Render component palette
    function renderComponentPalette() {
      const palette = document.getElementById('componentPalette');

      // Add basic elements
      const basicElements = [
        { name: 'Text', icon: 'fa-font', type: 'text' },
        { name: 'Heading', icon: 'fa-heading', type: 'heading' },
        { name: 'Image', icon: 'fa-image', type: 'image' },
        { name: 'Button', icon: 'fa-hand-pointer', type: 'button' },
        { name: 'Container', icon: 'fa-box', type: 'container' },
        { name: 'Columns', icon: 'fa-columns', type: 'columns' }
      ];

      palette.innerHTML = basicElements.map(el => `
        <div class="component-item" draggable="true" data-component-type="${el.type}">
          <div class="component-icon">
            <i class="fas ${el.icon}"></i>
          </div>
          <div class="component-name">${el.name}</div>
        </div>
      `).join('');

      // Make components draggable
      document.querySelectorAll('.component-item').forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
      });
    }

    // Drag and Drop
    function initializeDragAndDrop() {
      const canvas = document.getElementById('canvas');
      const dropzone = document.getElementById('mainDropzone');

      // Make canvas a drop target
      canvas.addEventListener('dragover', handleDragOver);
      canvas.addEventListener('drop', handleDrop);

      dropzone.addEventListener('dragover', handleDragOver);
      dropzone.addEventListener('drop', handleDrop);
    }

    function handleDragStart(e) {
      e.dataTransfer.effectAllowed = 'copy';
      e.dataTransfer.setData('component-type', e.currentTarget.dataset.componentType);
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';

      if (e.target.classList.contains('dropzone')) {
        e.target.classList.add('drag-over');
      }
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();

      const componentType = e.dataTransfer.getData('component-type');
      if (componentType) {
        createElement(componentType, e);
      }

      document.querySelectorAll('.dropzone').forEach(dz => {
        dz.classList.remove('drag-over');
      });
    }

    // Create element on canvas
    function createElement(type, event) {
      const canvas = document.getElementById('canvas');
      const dropzone = document.getElementById('mainDropzone');

      // Hide dropzone after first element
      if (dropzone) {
        dropzone.style.display = 'none';
      }

      const elementId = `element-${++elementCounter}`;
      const element = {
        id: elementId,
        type: type,
        properties: getDefaultProperties(type)
      };

      elements.push(element);

      const elementHtml = renderElement(element);
      const div = document.createElement('div');
      div.innerHTML = elementHtml;
      const elementNode = div.firstElementChild;

      canvas.appendChild(elementNode);

      // Make element interactive
      elementNode.addEventListener('click', (e) => {
        e.stopPropagation();
        selectElement(elementId);
      });

      // Select newly created element
      selectElement(elementId);

      // Update layers
      renderLayers();
    }

    // Get default properties for element type
    function getDefaultProperties(type) {
      const defaults = {
        text: { content: 'Text content', fontSize: '16px', color: '#000000' },
        heading: { content: 'Heading', level: 'h2', color: '#000000' },
        image: { src: 'https://via.placeholder.com/400x300', alt: 'Image', width: '100%' },
        button: { text: 'Button', variant: 'primary', size: '' },
        container: { padding: '20px', background: '#ffffff' },
        columns: { columns: 2, gap: '20px' }
      };

      return defaults[type] || {};
    }

    // Render element HTML
    function renderElement(element) {
      const { id, type, properties } = element;

      const templates = {
        text: `<div class="canvas-element" id="${id}" data-type="${type}">
          <div class="element-controls">
            <button class="control-btn" onclick="duplicateElement('${id}')"><i class="fas fa-copy"></i></button>
            <button class="control-btn delete" onclick="deleteElement('${id}')"><i class="fas fa-trash"></i></button>
          </div>
          <p style="font-size: ${properties.fontSize}; color: ${properties.color};">${properties.content}</p>
        </div>`,

        heading: `<div class="canvas-element" id="${id}" data-type="${type}">
          <div class="element-controls">
            <button class="control-btn" onclick="duplicateElement('${id}')"><i class="fas fa-copy"></i></button>
            <button class="control-btn delete" onclick="deleteElement('${id}')"><i class="fas fa-trash"></i></button>
          </div>
          <${properties.level} style="color: ${properties.color};">${properties.content}</${properties.level}>
        </div>`,

        image: `<div class="canvas-element" id="${id}" data-type="${type}">
          <div class="element-controls">
            <button class="control-btn" onclick="duplicateElement('${id}')"><i class="fas fa-copy"></i></button>
            <button class="control-btn delete" onclick="deleteElement('${id}')"><i class="fas fa-trash"></i></button>
          </div>
          <img src="${properties.src}" alt="${properties.alt}" style="width: ${properties.width}; max-width: 100%; height: auto; display: block;">
        </div>`,

        button: `<div class="canvas-element" id="${id}" data-type="${type}">
          <div class="element-controls">
            <button class="control-btn" onclick="duplicateElement('${id}')"><i class="fas fa-copy"></i></button>
            <button class="control-btn delete" onclick="deleteElement('${id}')"><i class="fas fa-trash"></i></button>
          </div>
          <button class="btn btn-${properties.variant} ${properties.size}">${properties.text}</button>
        </div>`,

        container: `<div class="canvas-element" id="${id}" data-type="${type}" style="padding: ${properties.padding}; background: ${properties.background}; border: 1px solid #dee2e6; border-radius: 8px;">
          <div class="element-controls">
            <button class="control-btn" onclick="duplicateElement('${id}')"><i class="fas fa-copy"></i></button>
            <button class="control-btn delete" onclick="deleteElement('${id}')"><i class="fas fa-trash"></i></button>
          </div>
          <div class="text-center text-muted">Container - Drop elements here</div>
        </div>`,

        columns: `<div class="canvas-element" id="${id}" data-type="${type}">
          <div class="element-controls">
            <button class="control-btn" onclick="duplicateElement('${id}')"><i class="fas fa-copy"></i></button>
            <button class="control-btn delete" onclick="deleteElement('${id}')"><i class="fas fa-trash"></i></button>
          </div>
          <div class="row" style="gap: ${properties.gap};">
            ${Array(properties.columns).fill('<div class="col"><div class="text-center text-muted p-3" style="border: 1px dashed #dee2e6; border-radius: 4px;">Column</div></div>').join('')}
          </div>
        </div>`
      };

      return templates[type] || `<div class="canvas-element" id="${id}">Unknown element</div>`;
    }

    // Select element
    function selectElement(id) {
      // Deselect all
      document.querySelectorAll('.canvas-element').forEach(el => el.classList.remove('selected'));
      document.querySelectorAll('.layer-item').forEach(el => el.classList.remove('selected'));

      // Select element
      const element = document.getElementById(id);
      if (element) {
        element.classList.add('selected');
        selectedElement = elements.find(el => el.id === id);
        renderProperties();
      }

      // Select layer
      const layer = document.querySelector(`[data-layer-id="${id}"]`);
      if (layer) {
        layer.classList.add('selected');
      }
    }

    // Render properties panel
    function renderProperties() {
      const panel = document.getElementById('propertiesPanel');

      if (!selectedElement) {
        panel.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-mouse-pointer"></i></div>
            <div>Select an element to edit its properties</div>
          </div>
        `;
        return;
      }

      const { type, properties } = selectedElement;

      const propertyEditors = {
        text: `
          <div class="property-group">
            <div class="property-row">
              <label class="property-label">Content</label>
              <textarea class="property-input" rows="3" onchange="updateProperty('content', this.value)">${properties.content}</textarea>
            </div>
            <div class="property-row">
              <label class="property-label">Font Size</label>
              <input type="text" class="property-input" value="${properties.fontSize}" onchange="updateProperty('fontSize', this.value)">
            </div>
            <div class="property-row">
              <label class="property-label">Color</label>
              <div class="color-picker-wrapper">
                <div class="color-preview" style="background: ${properties.color};" onclick="document.getElementById('colorPicker').click()"></div>
                <input type="color" id="colorPicker" class="property-input" value="${properties.color}" onchange="updateProperty('color', this.value)">
              </div>
            </div>
          </div>
        `,
        heading: `
          <div class="property-group">
            <div class="property-row">
              <label class="property-label">Content</label>
              <input type="text" class="property-input" value="${properties.content}" onchange="updateProperty('content', this.value)">
            </div>
            <div class="property-row">
              <label class="property-label">Level</label>
              <select class="property-input" onchange="updateProperty('level', this.value)">
                ${['h1','h2','h3','h4','h5','h6'].map(h => `<option value="${h}" ${properties.level === h ? 'selected' : ''}>${h.toUpperCase()}</option>`).join('')}
              </select>
            </div>
            <div class="property-row">
              <label class="property-label">Color</label>
              <div class="color-picker-wrapper">
                <div class="color-preview" style="background: ${properties.color};" onclick="document.getElementById('colorPicker').click()"></div>
                <input type="color" id="colorPicker" class="property-input" value="${properties.color}" onchange="updateProperty('color', this.value)">
              </div>
            </div>
          </div>
        `,
        image: `
          <div class="property-group">
            <div class="property-row">
              <label class="property-label">Image URL</label>
              <input type="text" class="property-input" value="${properties.src}" onchange="updateProperty('src', this.value)">
            </div>
            <div class="property-row">
              <label class="property-label">Alt Text</label>
              <input type="text" class="property-input" value="${properties.alt}" onchange="updateProperty('alt', this.value)">
            </div>
            <div class="property-row">
              <label class="property-label">Width</label>
              <input type="text" class="property-input" value="${properties.width}" onchange="updateProperty('width', this.value)">
            </div>
          </div>
        `,
        button: `
          <div class="property-group">
            <div class="property-row">
              <label class="property-label">Button Text</label>
              <input type="text" class="property-input" value="${properties.text}" onchange="updateProperty('text', this.value)">
            </div>
            <div class="property-row">
              <label class="property-label">Style</label>
              <select class="property-input" onchange="updateProperty('variant', this.value)">
                ${['primary', 'secondary', 'success', 'danger', 'warning', 'info'].map(v => `<option value="${v}" ${properties.variant === v ? 'selected' : ''}>${v}</option>`).join('')}
              </select>
            </div>
            <div class="property-row">
              <label class="property-label">Size</label>
              <select class="property-input" onchange="updateProperty('size', this.value)">
                <option value="" ${properties.size === '' ? 'selected' : ''}>Default</option>
                <option value="btn-sm" ${properties.size === 'btn-sm' ? 'selected' : ''}>Small</option>
                <option value="btn-lg" ${properties.size === 'btn-lg' ? 'selected' : ''}>Large</option>
              </select>
            </div>
          </div>
        `,
        container: `
          <div class="property-group">
            <div class="property-row">
              <label class="property-label">Padding</label>
              <input type="text" class="property-input" value="${properties.padding}" onchange="updateProperty('padding', this.value)">
            </div>
            <div class="property-row">
              <label class="property-label">Background</label>
              <div class="color-picker-wrapper">
                <div class="color-preview" style="background: ${properties.background};" onclick="document.getElementById('bgPicker').click()"></div>
                <input type="color" id="bgPicker" class="property-input" value="${properties.background}" onchange="updateProperty('background', this.value)">
              </div>
            </div>
          </div>
        `,
        columns: `
          <div class="property-group">
            <div class="property-row">
              <label class="property-label">Number of Columns</label>
              <input type="number" class="property-input" min="1" max="12" value="${properties.columns}" onchange="updateProperty('columns', parseInt(this.value))">
            </div>
            <div class="property-row">
              <label class="property-label">Gap</label>
              <input type="text" class="property-input" value="${properties.gap}" onchange="updateProperty('gap', this.value)">
            </div>
          </div>
        `
      };

      panel.innerHTML = propertyEditors[type] || '<div class="empty-state">No properties available</div>';
    }

    // Update property
    function updateProperty(key, value) {
      if (!selectedElement) return;

      selectedElement.properties[key] = value;

      // Re-render element
      const elementNode = document.getElementById(selectedElement.id);
      const newHtml = renderElement(selectedElement);
      const div = document.createElement('div');
      div.innerHTML = newHtml;
      const newNode = div.firstElementChild;

      elementNode.parentNode.replaceChild(newNode, elementNode);

      // Re-attach event listener
      newNode.addEventListener('click', (e) => {
        e.stopPropagation();
        selectElement(selectedElement.id);
      });

      // Maintain selection
      newNode.classList.add('selected');
    }

    // Render layers
    function renderLayers() {
      const layersList = document.getElementById('layersList');

      if (elements.length === 0) {
        layersList.innerHTML = '<li class="text-muted text-center py-3">No elements yet</li>';
        return;
      }

      layersList.innerHTML = elements.map(el => `
        <li class="layer-item ${selectedElement && selectedElement.id === el.id ? 'selected' : ''}" data-layer-id="${el.id}" onclick="selectElement('${el.id}')">
          <div class="layer-info">
            <span class="layer-icon"><i class="fas fa-${getIconForType(el.type)}"></i></span>
            <span class="layer-name">${el.type.charAt(0).toUpperCase() + el.type.slice(1)}</span>
          </div>
          <div class="layer-actions">
            <button class="layer-action-btn" onclick="event.stopPropagation(); deleteElement('${el.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </li>
      `).join('');
    }

    function getIconForType(type) {
      const icons = {
        text: 'font',
        heading: 'heading',
        image: 'image',
        button: 'hand-pointer',
        container: 'box',
        columns: 'columns'
      };
      return icons[type] || 'cube';
    }

    // Delete element
    function deleteElement(id) {
      if (confirm('Delete this element?')) {
        elements = elements.filter(el => el.id !== id);
        const elementNode = document.getElementById(id);
        if (elementNode) {
          elementNode.remove();
        }

        selectedElement = null;
        renderProperties();
        renderLayers();

        // Show dropzone if no elements
        if (elements.length === 0) {
          document.getElementById('mainDropzone').style.display = 'flex';
        }
      }
    }

    // Duplicate element
    function duplicateElement(id) {
      const original = elements.find(el => el.id === id);
      if (!original) return;

      const newId = `element-${++elementCounter}`;
      const duplicate = {
        id: newId,
        type: original.type,
        properties: { ...original.properties }
      };

      elements.push(duplicate);

      const canvas = document.getElementById('canvas');
      const div = document.createElement('div');
      div.innerHTML = renderElement(duplicate);
      const newNode = div.firstElementChild;

      canvas.appendChild(newNode);

      newNode.addEventListener('click', (e) => {
        e.stopPropagation();
        selectElement(newId);
      });

      renderLayers();
    }

    // Device switching
    function setDevice(device) {
      const canvas = document.getElementById('canvas');
      canvas.className = `canvas ${device}`;

      document.querySelectorAll('.device-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[data-device="${device}"]`).classList.add('active');

      const sizes = { desktop: '1200px', tablet: '768px', mobile: '375px' };
      document.getElementById('canvasSize').textContent = sizes[device];
    }

    // Toggle code view
    function toggleMode() {
      window.location.href = `/lowcode/html-designer?projectId=${projectId}`;
    }

    // Preview
    function previewPage() {
      const canvas = document.getElementById('canvas');
      const html = canvas.innerHTML;

      const previewWindow = window.open('', '_blank');
      previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
          <style>
            .canvas-element { margin: 0 !important; padding: 0 !important; border: none !important; }
            .element-controls { display: none !important; }
          </style>
        </head>
        <body>
          ${html}
        </body>
        </html>
      `);
    }

    // Save page
    async function savePage() {
      // TODO: Implement save to file
      alert('Save functionality coming soon! This will save the visual design to your HTML file.');
    }
  </script>
</body>
</html>
