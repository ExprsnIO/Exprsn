<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Exprsn Low-Code</title>

  <!-- Exprsn Theme -->
  <link rel="stylesheet" href="/css/exprsn-theme.css">
  <link rel="stylesheet" href="/css/lowcode-theme.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Monaco Editor -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/editor/editor.main.css">

  <!-- DOMPurify for XSS protection -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    .designer-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--bg-primary);
      overflow: hidden;
    }

    /* Header */
    .designer-header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .form-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .form-name-input {
      font-size: 1.1rem;
      font-weight: 600;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-primary);
      padding: 0.25rem 0.5rem;
      min-width: 200px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .form-name-input:hover {
      border-color: var(--border-color);
      background: rgba(0, 120, 212, 0.03);
    }

    .form-name-input:focus {
      outline: none;
      border-color: var(--primary-color);
      background: white;
      cursor: text;
    }

    .form-name-input:read-only {
      cursor: pointer;
    }

    .form-name-input.input-error {
      border-color: #e74c3c !important;
      background: #fee !important;
      animation: shake 0.3s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* Loading Overlay Styles */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(2px);
    }

    .loading-overlay.hidden {
      display: none;
    }

    .loading-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      text-align: center;
      min-width: 300px;
      max-width: 500px;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1rem;
      color: #333;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .loading-subtext {
      font-size: 0.875rem;
      color: #666;
    }

    .loading-progress {
      margin-top: 1rem;
      height: 4px;
      background: #f3f3f3;
      border-radius: 2px;
      overflow: hidden;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2ecc71);
      width: 0%;
      transition: width 0.3s ease;
      animation: progressShimmer 1.5s ease-in-out infinite;
    }

    @keyframes progressShimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    /* Inline Loading Spinner (for smaller areas) */
    .inline-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-left: 0.5rem;
    }

    /* Button Loading State */
    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Top Tab Navigation */
    .top-tabs {
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border-color);
      display: flex;
      padding: 0 0.5rem;
      flex-shrink: 0;
    }

    .tab-btn {
      padding: 0.625rem 1.25rem;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.8125rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      position: relative;
    }

    .tab-btn:hover {
      color: var(--primary-color);
      background: rgba(0, 120, 212, 0.05);
    }

    .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      background: var(--bg-primary);
    }

    .tab-btn i {
      font-size: 1rem;
    }

    /* Main Layout - 4 Columns (Form Selector + Component Library + Canvas + Properties) */
    .designer-main {
      flex: 1;
      display: grid;
      grid-template-columns: 240px 280px 1fr 380px;
      gap: 0;
      overflow: hidden;
    }

    /* Toolbox panel removed - components now accessible through right-click context menu or component palette modal */

    .panel-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-primary);
    }

    .sidebar-toggle {
      position: absolute;
      top: 10px;
      right: -15px;
      width: 30px;
      height: 30px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }

    .sidebar-toggle:hover {
      background: var(--primary-hover);
      transform: scale(1.1);
    }

    .sidebar-toggle i {
      font-size: 0.875rem;
    }

    /* Toolbox tabs and content removed */

    /* Form Selector Panel */
    .form-selector-panel {
      border-right: 1px solid var(--border-color);
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      transition: width 0.3s ease;
    }

    .form-selector-panel.collapsed {
      width: 50px !important;
      min-width: 50px !important;
    }

    .form-selector-panel.collapsed .panel-header span,
    .form-selector-panel.collapsed .form-selector-toolbar,
    .form-selector-panel.collapsed .form-selector-search,
    .form-selector-panel.collapsed .form-selector-content {
      display: none;
    }

    .form-selector-toolbar {
      display: flex;
      gap: 0.25rem;
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-primary);
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      padding: 0;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: rgba(0, 120, 212, 0.1);
      color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-icon:active {
      background: rgba(0, 120, 212, 0.2);
    }

    .btn-icon i {
      font-size: 0.875rem;
    }

    .form-selector-search {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-selector-search input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.875rem;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .form-selector-search input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .form-selector-filter {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.875rem;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .form-selector-filter:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .form-selector-content {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .folder-tree {
      font-size: 0.875rem;
    }

    .folder-item {
      margin-bottom: 0.25rem;
    }

    .folder-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
      user-select: none;
    }

    .folder-header:hover {
      background: rgba(0, 120, 212, 0.08);
    }

    .folder-header.selected {
      background: rgba(0, 120, 212, 0.15);
    }

    .folder-toggle {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }

    .folder-toggle i {
      font-size: 0.75rem;
    }

    .folder-toggle.expanded {
      transform: rotate(90deg);
    }

    .folder-icon {
      color: var(--primary-color);
    }

    .folder-name {
      flex: 1;
      font-weight: 500;
    }

    .folder-count {
      font-size: 0.75rem;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      padding: 0.125rem 0.375rem;
      border-radius: 10px;
    }

    .folder-children {
      padding-left: 1.25rem;
      display: none;
    }

    .folder-children.expanded {
      display: block;
    }

    .form-selector-item {
      padding: 0.625rem 0.75rem;
      margin-bottom: 0.25rem;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
      font-size: 0.875rem;
      color: var(--text-primary);
      background: var(--bg-primary);
      border: 1px solid transparent;
    }

    .form-selector-item:hover {
      background: rgba(0, 120, 212, 0.08);
      border-color: var(--border-color);
    }

    .form-selector-item.active {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    .form-selector-item i {
      font-size: 0.875rem;
      opacity: 0.7;
    }

    .form-selector-item.active i {
      opacity: 1;
    }

    .form-selector-item .form-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .form-selector-empty {
      padding: 2rem 1rem;
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    /* Selector Modal Tabs */
    .selector-tab-btn {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-secondary);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .selector-tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .selector-tab-btn:hover {
      color: var(--text-primary);
    }

    .selector-tab-content {
      display: none;
    }

    .selector-tab-content.active {
      display: block;
    }

    /* Component Groups */
    .component-group {
      margin-bottom: 1.5rem;
    }

    .group-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      letter-spacing: 0.5px;
    }

    .component-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }

    .component-item {
      padding: 0.75rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: grab;
      transition: all 0.2s;
      text-align: center;
    }

    .component-item:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .component-item:active {
      cursor: grabbing;
    }

    .component-icon {
      font-size: 1.5rem;
      color: var(--primary-color);
      margin-bottom: 0.25rem;
    }

    .component-name {
      font-size: 0.75rem;
      color: var(--text-primary);
    }

    /* Component Library Panel */
    .component-library-panel {
      border-right: 1px solid var(--border-color);
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      transition: width 0.3s ease;
    }

    .component-library-panel.collapsed {
      width: 50px !important;
      min-width: 50px !important;
    }

    .component-library-panel.collapsed .panel-header span,
    .component-library-panel.collapsed .component-library-content {
      display: none;
    }

    .component-library-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .component-category {
      margin-bottom: 1.5rem;
    }

    .category-header {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      user-select: none;
      padding: 0.5rem;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .category-header:hover {
      background: rgba(0, 120, 212, 0.05);
      color: var(--primary-color);
    }

    .category-toggle {
      font-size: 0.625rem;
      transition: transform 0.2s;
    }

    .category-toggle.expanded {
      transform: rotate(90deg);
    }

    .category-components {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .category-components.collapsed {
      display: none;
    }

    .component-library-item {
      padding: 0.75rem 0.5rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: grab;
      transition: all 0.2s;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.375rem;
    }

    .component-library-item:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      background: white;
    }

    .component-library-item:active {
      cursor: grabbing;
      transform: translateY(0);
    }

    .component-library-item i {
      font-size: 1.25rem;
      color: var(--primary-color);
    }

    .component-library-item .component-name {
      font-size: 0.688rem;
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.2;
    }

    /* Center - Tab Content Area */
    .center-panel {
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Tab Content Sections */
    .tab-content {
      display: none;
      flex: 1;
      overflow: auto;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    /* Canvas Toolbar - Enhanced */
    .canvas-toolbar {
      background: white;
      border-bottom: 1px solid var(--border-color);
      padding: 0.5rem 1rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    .toolbar-divider {
      width: 1px;
      height: 20px;
      background: var(--border-color);
      margin: 0 0.25rem;
    }

    .toolbar-group {
      display: flex;
      gap: 0.25rem;
      align-items: center;
    }

    .toolbar-dropdown {
      padding: 0.375rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.813rem;
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .toolbar-dropdown:hover {
      border-color: var(--primary-color);
      background: white;
    }

    .toolbar-dropdown:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
    }

    /* Canvas Container with Rulers */
    .canvas-container {
      flex: 1;
      overflow: auto;
      position: relative;
      background: #e5e5e5;
    }

    .canvas-rulers-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .ruler-horizontal {
      position: sticky;
      top: 0;
      left: 30px;
      height: 30px;
      background: #f8f8f8;
      border-bottom: 1px solid var(--border-color);
      z-index: 100;
      display: flex;
      margin-left: 30px;
    }

    .ruler-horizontal.hidden {
      display: none;
    }

    .ruler-vertical {
      position: sticky;
      left: 0;
      top: 30px;
      width: 30px;
      background: #f8f8f8;
      border-right: 1px solid var(--border-color);
      z-index: 100;
      display: flex;
      flex-direction: column;
      margin-top: 30px;
    }

    .ruler-vertical.hidden {
      display: none;
    }

    .ruler-corner {
      position: sticky;
      top: 0;
      left: 0;
      width: 30px;
      height: 30px;
      background: #f0f0f0;
      border-right: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      z-index: 101;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.625rem;
      color: var(--text-secondary);
    }

    .ruler-corner.hidden {
      display: none;
    }

    .ruler-mark {
      position: absolute;
      font-size: 0.625rem;
      color: var(--text-secondary);
      user-select: none;
    }

    .ruler-tick {
      position: absolute;
      background: var(--text-secondary);
    }

    .ruler-horizontal .ruler-tick {
      width: 1px;
      height: 5px;
      bottom: 0;
    }

    .ruler-vertical .ruler-tick {
      height: 1px;
      width: 5px;
      right: 0;
    }

    /* Canvas Wrapper with Grid */
    .canvas-wrapper {
      padding: 2rem;
      min-height: calc(100% - 30px);
      margin-left: 30px;
      margin-top: 30px;
      position: relative;
    }

    .canvas-wrapper.no-rulers {
      margin-left: 0;
      margin-top: 0;
      min-height: 100%;
    }

    .grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      background-size: 24px 24px;
      background-image:
        linear-gradient(to right, rgba(0, 120, 212, 0.1) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0, 120, 212, 0.1) 1px, transparent 1px);
      display: none;
    }

    .grid-overlay.visible {
      display: block;
    }

    .grid-overlay.snap-8 {
      background-size: 8px 8px;
    }

    .grid-overlay.snap-16 {
      background-size: 16px 16px;
    }

    .grid-overlay.snap-24 {
      background-size: 24px 24px;
    }

    /* Form Canvas - Enhanced with Sections */
    .form-canvas {
      background: white;
      min-height: 600px;
      max-width: 1200px;
      margin: 0 auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      position: relative;
      z-index: 2;
      transition: transform 0.2s, max-width 0.3s;
      transform-origin: top center;
    }

    /* Zoom levels */
    .form-canvas.zoom-50 { transform: scale(0.5); }
    .form-canvas.zoom-75 { transform: scale(0.75); }
    .form-canvas.zoom-100 { transform: scale(1); }
    .form-canvas.zoom-125 { transform: scale(1.25); }
    .form-canvas.zoom-150 { transform: scale(1.5); }
    .form-canvas.zoom-200 { transform: scale(2); }

    /* Responsive preview modes */
    .form-canvas.preview-desktop { max-width: 1200px; }
    .form-canvas.preview-tablet { max-width: 768px; }
    .form-canvas.preview-mobile { max-width: 375px; }

    .form-canvas.empty .form-body::before {
      content: 'Drag components here to build your form';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-secondary);
      font-size: 1.25rem;
      text-align: center;
      white-space: nowrap;
      pointer-events: none;
    }

    /* Form Sections */
    .form-header,
    .form-body,
    .form-footer {
      position: relative;
      padding: 1.5rem 2rem;
      min-height: 60px;
    }

    .form-header {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-bottom: 2px solid var(--border-color);
      border-radius: 8px 8px 0 0;
      display: none;
    }

    .form-header.visible {
      display: block;
    }

    .form-body {
      min-height: 400px;
      background: white;
    }

    .form-footer {
      background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
      border-top: 2px solid var(--border-color);
      border-radius: 0 0 8px 8px;
      display: none;
    }

    .form-footer.visible {
      display: block;
    }

    .section-label {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      background: white;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      border: 1px solid var(--border-color);
      opacity: 0.7;
      pointer-events: none;
    }

    /* Dropped Components - Enhanced */
    .form-component {
      position: relative;
      margin-bottom: 1rem;
      padding: 0.75rem;
      border: 2px dashed transparent;
      border-radius: 4px;
      transition: all 0.2s;
      cursor: pointer;
      user-select: none;
    }

    .form-component:hover {
      border-color: var(--primary-color);
      border-style: dashed;
      background: rgba(0, 120, 212, 0.03);
    }

    .form-component.selected {
      border-color: var(--primary-color);
      border-style: solid;
      border-width: 3px;
      background: rgba(0, 120, 212, 0.08);
      box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
    }

    /* Resize Handles */
    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: white;
      border: 2px solid var(--primary-color);
      border-radius: 50%;
      display: none;
      z-index: 10;
    }

    .form-component.selected .resize-handle {
      display: block;
    }

    .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
    .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
    .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
    .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }
    .resize-handle.n { top: -5px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
    .resize-handle.s { bottom: -5px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
    .resize-handle.e { top: 50%; right: -5px; transform: translateY(-50%); cursor: e-resize; }
    .resize-handle.w { top: 50%; left: -5px; transform: translateY(-50%); cursor: w-resize; }

    /* Component Type Badge */
    .component-type-badge {
      position: absolute;
      top: -8px;
      left: 8px;
      background: var(--primary-color);
      color: white;
      font-size: 0.625rem;
      font-weight: 600;
      padding: 0.125rem 0.5rem;
      border-radius: 10px;
      display: none;
      z-index: 11;
      pointer-events: none;
    }

    .form-component.selected .component-type-badge,
    .form-component:hover .component-type-badge {
      display: block;
    }

    /* Smart Alignment Guides */
    .snap-guide {
      position: absolute;
      background: rgba(255, 0, 128, 0.6);
      z-index: 1000;
      pointer-events: none;
    }

    .snap-guide.vertical {
      width: 1px;
      height: 100%;
      top: 0;
    }

    .snap-guide.horizontal {
      height: 1px;
      width: 100%;
      left: 0;
    }

    .snap-guide.center {
      background: rgba(0, 120, 212, 0.8);
    }

    /* Distance Indicators */
    .distance-indicator {
      position: absolute;
      background: rgba(255, 0, 128, 0.9);
      color: white;
      font-size: 0.625rem;
      font-weight: 600;
      padding: 0.125rem 0.375rem;
      border-radius: 3px;
      z-index: 1001;
      pointer-events: none;
      white-space: nowrap;
    }

    .form-component input,
    .form-component textarea,
    .form-component select {
      user-select: text;
      pointer-events: auto;
    }

    .component-controls {
      position: absolute;
      top: -10px;
      right: -10px;
      display: none;
      gap: 0.25rem;
      z-index: 10;
    }

    .form-component:hover .component-controls,
    .form-component.selected .component-controls {
      display: flex;
    }

    .control-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      border: 2px solid white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: all 0.2s;
    }

    .control-btn:hover {
      background: #005a9e;
      transform: scale(1.1);
    }

    /* Functions Tab Styles */
    .functions-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      overflow: hidden;
      background: white;
    }

    .functions-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-color);
    }

    .functions-table-container {
      flex: 0 0 200px;
      overflow-y: auto;
      margin-bottom: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
    }

    .functions-table {
      width: 100%;
      border-collapse: collapse;
    }

    .functions-table thead {
      background: var(--bg-secondary);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .functions-table th {
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
    }

    .functions-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.875rem;
    }

    .functions-table tbody tr {
      cursor: pointer;
      transition: background 0.2s;
    }

    .functions-table tbody tr:hover {
      background: rgba(0, 120, 212, 0.05);
    }

    .functions-table tbody tr.selected {
      background: rgba(0, 120, 212, 0.1);
      border-left: 3px solid var(--primary-color);
    }

    .function-editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
    }

    .editor-header {
      background: var(--bg-secondary);
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .editor-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .editor-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    #functionEditor {
      flex: 1;
      min-height: 400px;
      background: #1e1e1e;
    }

    /* NPM Package Manager Styles */
    .npm-panel {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-top: 1rem;
      max-height: 300px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .npm-header {
      padding: 0.75rem 1rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .npm-search {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 0.5rem;
    }

    .npm-search input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.875rem;
    }

    .npm-packages {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .npm-package-item {
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      transition: all 0.2s;
    }

    .npm-package-item:hover {
      border-color: var(--primary-color);
      background: rgba(0, 120, 212, 0.03);
    }

    .npm-package-info {
      flex: 1;
    }

    .npm-package-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .npm-package-version {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .npm-package-actions {
      display: flex;
      gap: 0.25rem;
    }

    /* Event Handlers Tab Styles */
    .event-handlers-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      background: white;
      overflow: auto;
    }

    .event-handler-form {
      background: var(--bg-secondary);
      padding: 1.5rem;
      border-radius: 6px;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border-color);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.375rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.875rem;
      background: white;
      color: var(--text-primary);
    }

    .event-handlers-list {
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
    }

    .event-handler-item {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      transition: background 0.2s;
    }

    .event-handler-item:hover {
      background: rgba(0, 120, 212, 0.05);
    }

    .event-handler-item:last-child {
      border-bottom: none;
    }

    .event-handler-info {
      flex: 1;
    }

    .event-handler-object {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0.25rem;
    }

    .event-handler-details {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* Variables Tab Styles */
    .variables-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      background: white;
      overflow: auto;
    }

    .variables-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-color);
    }

    .variables-table-container {
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 6px;
    }

    .variables-table {
      width: 100%;
      border-collapse: collapse;
    }

    .variables-table thead {
      background: var(--bg-secondary);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .variables-table th {
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
    }

    .variables-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.875rem;
    }

    .variables-table tbody tr:hover {
      background: rgba(0, 120, 212, 0.05);
    }

    /* Right Sidebar - Properties */
    .properties-panel {
      border-left: 1px solid var(--border-color);
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      transition: width 0.3s ease;
    }

    .properties-panel.collapsed {
      width: 50px !important;
      min-width: 50px !important;
    }

    .properties-panel.collapsed .panel-header span,
    .properties-panel.collapsed .property-tabs,
    .properties-panel.collapsed .property-content,
    .properties-panel.collapsed .code-editor-container {
      display: none;
    }

    .properties-panel .sidebar-toggle {
      left: -15px;
      right: auto;
    }

    /* Properties Tabs */
    .properties-tabs {
      display: flex;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      overflow-x: auto;
      flex-shrink: 0;
    }

    .prop-tab-btn {
      padding: 0.625rem 0.875rem;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.375rem;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .prop-tab-btn:hover {
      color: var(--primary-color);
      background: rgba(0, 120, 212, 0.05);
    }

    .prop-tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      background: var(--bg-primary);
    }

    .prop-tab-btn i {
      font-size: 0.75rem;
    }

    .prop-tab-content {
      display: none;
      flex: 1;
      overflow: hidden;
    }

    .prop-tab-content.active {
      display: flex;
      flex-direction: column;
    }

    .properties-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .property-group {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--bg-primary);
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }

    .property-group-title {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-primary);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary-color);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .property-group-title::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--primary-color);
      border-radius: 2px;
    }

    .property-field {
      margin-bottom: 1rem;
    }

    .property-field:last-child {
      margin-bottom: 0;
    }

    .property-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.375rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .property-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.875rem;
      background: white;
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .property-input:hover {
      border-color: var(--primary-color);
    }

    .property-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
    }

    .property-input[type="checkbox"] {
      width: auto;
      margin-right: 0.5rem;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 2rem;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border-color);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.1);
      color: var(--text-primary);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    /* Drag Over State */
    .drag-over {
      border: 2px dashed var(--primary-color);
      background: rgba(0, 120, 212, 0.05);
    }

    /* Utility Classes */
    .text-muted {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .mt-2 { margin-top: 0.5rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .p-2 { padding: 0.5rem; }
  </style>
</head>
<body>
  <div class="designer-container">
    <!-- Git Toolbar -->
    <%- include('partials/git-toolbar') %>

    <!-- Header -->
    <header class="designer-header">
      <div class="form-info">
        <input
          type="text"
          id="formDisplayName"
          class="form-name-input"
          placeholder="Form Name"
          value="<%= form ? form.displayName : 'New Form' %>"
          readonly
          title="Double-click to edit">
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.location.href='/lowcode/designer?appId=<%= appId %>'">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button class="btn btn-secondary" id="previewBtn">
          <i class="fas fa-eye"></i> Preview
        </button>
        <button class="btn btn-secondary" id="saveBtn">
          <i class="fas fa-save"></i> Save
        </button>
        <button class="btn btn-primary" id="publishBtn">
          <i class="fas fa-rocket"></i> Publish
        </button>
      </div>
    </header>

    <!-- Top Tab Navigation -->
    <div class="top-tabs">
      <button class="tab-btn active" data-tab="canvas">
        <i class="fas fa-pencil-ruler"></i> Designer
      </button>
      <button class="tab-btn" data-tab="functions">
        <i class="fas fa-code"></i> Functions
      </button>
      <button class="tab-btn" data-tab="events">
        <i class="fas fa-bolt"></i> Events
      </button>
      <button class="tab-btn" data-tab="variables">
        <i class="fas fa-database"></i> Variables
      </button>
      <button class="tab-btn" data-tab="permissions">
        <i class="fas fa-lock"></i> Permissions
      </button>
      <button class="tab-btn" data-tab="workflows">
        <i class="fas fa-project-diagram"></i> Workflows
      </button>
      <button class="tab-btn" data-tab="json">
        <i class="fas fa-file-code"></i> JSON
      </button>
    </div>

    <!-- Main Designer Layout -->
    <main class="designer-main">
      <!-- Far Left Sidebar - Form Selector -->
      <aside class="form-selector-panel" id="formSelectorPanel">
        <button class="sidebar-toggle" id="formSelectorToggle" title="Toggle Form Selector">
          <i class="fas fa-chevron-left"></i>
        </button>
        <div class="panel-header">
          <span>Forms</span>
        </div>

        <!-- Toolbar -->
        <div class="form-selector-toolbar">
          <button class="btn-icon" id="addFormBtn" title="New Form">
            <i class="fas fa-plus"></i>
          </button>
          <button class="btn-icon" id="addFolderBtn" title="New Folder">
            <i class="fas fa-folder-plus"></i>
          </button>
          <button class="btn-icon" id="removeFormBtn" title="Delete Selected">
            <i class="fas fa-trash"></i>
          </button>
          <button class="btn-icon" id="refreshFormsBtn" title="Refresh">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>

        <!-- Search/Filter -->
        <div class="form-selector-search">
          <input type="text" id="formSelectorSearch" placeholder="Search forms...">
          <select id="formSelectorFilter" class="form-selector-filter">
            <option value="all">All Forms</option>
            <option value="recent">Recent</option>
            <option value="favorites">Favorites</option>
          </select>
        </div>

        <!-- Folder Tree -->
        <div class="form-selector-content" id="formSelectorContent">
          <div class="folder-tree" id="folderTree">
            <!-- Folders and forms will be loaded here -->
          </div>
        </div>
      </aside>

      <!-- Component Library Panel -->
      <aside class="component-library-panel" id="componentLibraryPanel">
        <div class="panel-header">
          <span>Component Library</span>
          <button class="sidebar-toggle" id="componentLibraryToggle" title="Collapse Component Library">
            <i class="fas fa-chevron-left"></i>
          </button>
        </div>

        <div class="component-library-content" id="componentLibraryContent">
          <!-- Layout Components -->
          <div class="component-category">
            <div class="category-header" data-category="layout">
              <i class="fas fa-chevron-right category-toggle expanded"></i>
              <span>Layout</span>
            </div>
            <div class="category-components">
              <div class="component-library-item" draggable="true" data-component="container">
                <i class="fas fa-square"></i>
                <div class="component-name">Container</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="grid">
                <i class="fas fa-th"></i>
                <div class="component-name">Grid</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="row">
                <i class="fas fa-grip-lines"></i>
                <div class="component-name">Row</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="column">
                <i class="fas fa-columns"></i>
                <div class="component-name">Column</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="card">
                <i class="fas fa-id-card"></i>
                <div class="component-name">Card</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="panel">
                <i class="fas fa-window-maximize"></i>
                <div class="component-name">Panel</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="tabs">
                <i class="fas fa-folder-open"></i>
                <div class="component-name">Tabs</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="accordion">
                <i class="fas fa-bars"></i>
                <div class="component-name">Accordion</div>
              </div>
            </div>
          </div>

          <!-- Form Inputs -->
          <div class="component-category">
            <div class="category-header" data-category="inputs">
              <i class="fas fa-chevron-right category-toggle expanded"></i>
              <span>Form Inputs</span>
            </div>
            <div class="category-components">
              <div class="component-library-item" draggable="true" data-component="text">
                <i class="fas fa-font"></i>
                <div class="component-name">Text Input</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="number">
                <i class="fas fa-hashtag"></i>
                <div class="component-name">Number</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="email">
                <i class="fas fa-at"></i>
                <div class="component-name">Email</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="password">
                <i class="fas fa-lock"></i>
                <div class="component-name">Password</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="textarea">
                <i class="fas fa-align-left"></i>
                <div class="component-name">Textarea</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="richtext">
                <i class="fas fa-file-alt"></i>
                <div class="component-name">Rich Text</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="date">
                <i class="fas fa-calendar"></i>
                <div class="component-name">Date Picker</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="time">
                <i class="fas fa-clock"></i>
                <div class="component-name">Time Picker</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="color">
                <i class="fas fa-palette"></i>
                <div class="component-name">Color Picker</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="file">
                <i class="fas fa-file-upload"></i>
                <div class="component-name">File Upload</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="checkbox">
                <i class="fas fa-check-square"></i>
                <div class="component-name">Checkbox</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="radio">
                <i class="fas fa-dot-circle"></i>
                <div class="component-name">Radio</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="switch">
                <i class="fas fa-toggle-on"></i>
                <div class="component-name">Switch</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="select">
                <i class="fas fa-caret-square-down"></i>
                <div class="component-name">Select</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="multiselect">
                <i class="fas fa-list-ul"></i>
                <div class="component-name">Multi-Select</div>
              </div>
            </div>
          </div>

          <!-- Display Components -->
          <div class="component-category">
            <div class="category-header" data-category="display">
              <i class="fas fa-chevron-right category-toggle expanded"></i>
              <span>Display</span>
            </div>
            <div class="category-components">
              <div class="component-library-item" draggable="true" data-component="label">
                <i class="fas fa-tag"></i>
                <div class="component-name">Label</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="heading">
                <i class="fas fa-heading"></i>
                <div class="component-name">Heading</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="paragraph">
                <i class="fas fa-paragraph"></i>
                <div class="component-name">Paragraph</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="divider">
                <i class="fas fa-minus"></i>
                <div class="component-name">Divider</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="spacer">
                <i class="fas fa-arrows-alt-v"></i>
                <div class="component-name">Spacer</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="image">
                <i class="fas fa-image"></i>
                <div class="component-name">Image</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="icon">
                <i class="fas fa-icons"></i>
                <div class="component-name">Icon</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="badge">
                <i class="fas fa-certificate"></i>
                <div class="component-name">Badge</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="alert">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="component-name">Alert</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="progress">
                <i class="fas fa-tasks"></i>
                <div class="component-name">Progress Bar</div>
              </div>
            </div>
          </div>

          <!-- Action Components -->
          <div class="component-category">
            <div class="category-header" data-category="actions">
              <i class="fas fa-chevron-right category-toggle expanded"></i>
              <span>Actions</span>
            </div>
            <div class="category-components">
              <div class="component-library-item" draggable="true" data-component="button">
                <i class="fas fa-hand-pointer"></i>
                <div class="component-name">Button</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="buttongroup">
                <i class="fas fa-object-group"></i>
                <div class="component-name">Button Group</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="link">
                <i class="fas fa-link"></i>
                <div class="component-name">Link</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="dropdown">
                <i class="fas fa-ellipsis-v"></i>
                <div class="component-name">Dropdown</div>
              </div>
            </div>
          </div>

          <!-- Data Components -->
          <div class="component-category">
            <div class="category-header" data-category="data">
              <i class="fas fa-chevron-right category-toggle expanded"></i>
              <span>Data</span>
            </div>
            <div class="category-components">
              <div class="component-library-item" draggable="true" data-component="table">
                <i class="fas fa-table"></i>
                <div class="component-name">Table</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="list">
                <i class="fas fa-list"></i>
                <div class="component-name">List</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="datagrid">
                <i class="fas fa-th-large"></i>
                <div class="component-name">Data Grid</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="chart">
                <i class="fas fa-chart-bar"></i>
                <div class="component-name">Chart</div>
              </div>
              <div class="component-library-item" draggable="true" data-component="calendar">
                <i class="fas fa-calendar-alt"></i>
                <div class="component-name">Calendar</div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Center Panel - Tab Content -->
      <div class="center-panel">
        <!-- Canvas Tab (Form Designer) -->
        <div class="tab-content active" id="canvasTab">
          <div class="canvas-toolbar">
            <!-- History Controls -->
            <div class="toolbar-group">
              <button class="btn btn-sm" id="undoBtn" title="Undo (Ctrl+Z)">
                <i class="fas fa-undo"></i>
              </button>
              <button class="btn btn-sm" id="redoBtn" title="Redo (Ctrl+Y)">
                <i class="fas fa-redo"></i>
              </button>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Grid & Ruler Controls -->
            <div class="toolbar-group">
              <button class="btn btn-sm" id="toggleGridBtn" title="Toggle Grid">
                <i class="fas fa-border-all"></i>
              </button>
              <button class="btn btn-sm" id="toggleRulersBtn" title="Toggle Rulers">
                <i class="fas fa-ruler-combined"></i>
              </button>
              <select id="snapToGridSelect" class="toolbar-dropdown" title="Snap to Grid">
                <option value="off">No Snap</option>
                <option value="8">Snap 8px</option>
                <option value="16">Snap 16px</option>
                <option value="24" selected>Snap 24px</option>
              </select>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Zoom Control -->
            <div class="toolbar-group">
              <select id="zoomSelect" class="toolbar-dropdown" title="Zoom Level">
                <option value="50">50%</option>
                <option value="75">75%</option>
                <option value="100" selected>100%</option>
                <option value="125">125%</option>
                <option value="150">150%</option>
                <option value="200">200%</option>
              </select>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Responsive Preview -->
            <div class="toolbar-group">
              <button class="btn btn-sm active" id="previewDesktopBtn" title="Desktop View">
                <i class="fas fa-desktop"></i>
              </button>
              <button class="btn btn-sm" id="previewTabletBtn" title="Tablet View">
                <i class="fas fa-tablet-alt"></i>
              </button>
              <button class="btn btn-sm" id="previewMobileBtn" title="Mobile View">
                <i class="fas fa-mobile-alt"></i>
              </button>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Alignment Tools -->
            <div class="toolbar-group">
              <button class="btn btn-sm" id="alignLeftBtn" title="Align Left">
                <i class="fas fa-align-left"></i>
              </button>
              <button class="btn btn-sm" id="alignCenterBtn" title="Align Center">
                <i class="fas fa-align-center"></i>
              </button>
              <button class="btn btn-sm" id="alignRightBtn" title="Align Right">
                <i class="fas fa-align-right"></i>
              </button>
              <button class="btn btn-sm" id="alignJustifyBtn" title="Justify">
                <i class="fas fa-align-justify"></i>
              </button>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Distribution Tools -->
            <div class="toolbar-group">
              <button class="btn btn-sm" id="distributeHorizontalBtn" title="Distribute Horizontally">
                <i class="fas fa-arrows-alt-h"></i>
              </button>
              <button class="btn btn-sm" id="distributeVerticalBtn" title="Distribute Vertically">
                <i class="fas fa-arrows-alt-v"></i>
              </button>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Form Type -->
            <select id="formTypeSelect" class="toolbar-dropdown">
              <option value="standard">Standard Form</option>
              <option value="data-browser">Data Browser</option>
              <option value="crud">CRUD Interface</option>
              <option value="wizard">Wizard</option>
              <option value="dashboard">Dashboard</option>
            </select>

            <div class="toolbar-divider"></div>

            <!-- Section Toggles -->
            <div class="toolbar-group">
              <button class="btn btn-sm" id="toggleHeaderBtn" title="Toggle Header Section">
                <i class="fas fa-window-maximize"></i> Header
              </button>
              <button class="btn btn-sm" id="toggleFooterBtn" title="Toggle Footer Section">
                <i class="fas fa-window-restore"></i> Footer
              </button>
            </div>

            <div style="flex: 1;"></div>

            <!-- Preview Button -->
            <button class="btn btn-sm btn-secondary" id="togglePreviewBtn">
              <i class="fas fa-eye"></i> Live Preview
            </button>
          </div>

          <div class="canvas-container" id="canvasContainer">
            <!-- Ruler Corner -->
            <div class="ruler-corner" id="rulerCorner">
              <i class="fas fa-arrows-alt"></i>
            </div>

            <!-- Horizontal Ruler -->
            <div class="ruler-horizontal" id="rulerHorizontal"></div>

            <!-- Vertical Ruler -->
            <div class="ruler-vertical" id="rulerVertical"></div>

            <!-- Canvas Wrapper -->
            <div class="canvas-wrapper" id="canvasWrapper">
              <!-- Grid Overlay -->
              <div class="grid-overlay" id="gridOverlay"></div>

              <!-- Form Canvas -->
              <div class="form-canvas empty zoom-100 preview-desktop" id="formCanvas">
                <!-- Form Header Section (Optional) -->
                <div class="form-header" id="formHeaderSection">
                  <div class="section-label">Header</div>
                  <!-- Header components will be dropped here -->
                </div>

                <!-- Form Body Section (Main) -->
                <div class="form-body" id="formBodySection">
                  <div class="section-label">Body</div>
                  <!-- Form components will be dropped here -->
                </div>

                <!-- Form Footer Section (Optional) -->
                <div class="form-footer" id="formFooterSection">
                  <div class="section-label">Footer</div>
                  <!-- Footer components will be dropped here -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Functions Tab -->
        <div class="tab-content" id="functionsTab">
          <div class="functions-container">
            <div class="functions-toolbar">
              <h3 style="margin: 0; color: var(--text-primary);">Custom Functions</h3>
              <button class="btn btn-primary btn-sm" id="addFunctionBtn">
                <i class="fas fa-plus"></i> Add Function
              </button>
            </div>

            <div class="functions-table-container">
              <table class="functions-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Parameters</th>
                    <th>Return Type</th>
                    <th>Description</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="functionsTableBody">
                  <tr>
                    <td colspan="5" class="text-muted" style="text-align: center; padding: 2rem;">
                      No custom functions defined. Click "Add Function" to create one.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="function-editor-container">
              <div class="editor-header">
                <span class="editor-title" id="currentFunctionName">Select a function to edit</span>
                <div class="editor-actions">
                  <button class="btn btn-sm btn-secondary" id="npmPackagesBtn" title="Manage NPM Packages">
                    <i class="fab fa-npm"></i> NPM Packages
                  </button>
                  <div style="width: 1px; height: 20px; background: var(--border-color);"></div>
                  <button class="btn btn-sm btn-secondary" id="formatFunctionBtn" title="Format Code">
                    <i class="fas fa-align-left"></i> Format
                  </button>
                  <button class="btn btn-sm btn-secondary" id="debugFunctionBtn" title="Enable Debugging">
                    <i class="fas fa-bug"></i> Debug
                  </button>
                  <button class="btn btn-sm btn-secondary" id="testFunctionBtn" title="Test Function">
                    <i class="fas fa-play"></i> Test
                  </button>
                  <button class="btn btn-sm btn-primary" id="deployFunctionBtn" title="Deploy Function">
                    <i class="fas fa-rocket"></i> Deploy
                  </button>
                </div>
              </div>
              <div id="functionEditor"></div>
            </div>

            <!-- NPM Package Manager Panel (initially hidden) -->
            <div id="npmPanel" class="npm-panel" style="display: none;">
              <div class="npm-header">
                <span><i class="fab fa-npm"></i> NPM Package Manager</span>
                <button class="btn btn-sm btn-secondary" id="closeNpmPanelBtn">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="npm-search">
                <input type="text" id="npmSearchInput" placeholder="Search npm packages...">
                <button class="btn btn-sm btn-primary" id="npmSearchBtn">
                  <i class="fas fa-search"></i> Search
                </button>
              </div>
              <div class="npm-packages" id="npmPackagesList">
                <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                  <p><strong>Installed Packages:</strong></p>
                  <p style="margin-top: 1rem; font-size: 0.875rem;">No packages installed yet. Search above to add packages.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Event Handlers Tab -->
        <div class="tab-content" id="eventsTab">
          <div class="event-handlers-container">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Event Handlers</h3>

            <div class="event-handler-form">
              <div class="form-row">
                <div class="form-group">
                  <label style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Object Lookup</span>
                    <button type="button" class="btn btn-sm btn-secondary" id="refreshObjectsBtn" title="Refresh object list">
                      <i class="fas fa-sync-alt"></i>
                    </button>
                  </label>
                  <select id="eventObjectSelect" class="property-input">
                    <option value="">Select an object...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Event Trigger <small style="color: var(--text-secondary);">(contextual)</small></label>
                  <select id="eventTriggerSelect" class="property-input">
                    <option value="">Select object first...</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Action Type</label>
                  <select id="eventActionType" class="property-input">
                    <option value="function">Custom Function</option>
                    <option value="navigation">Navigation</option>
                    <option value="data">Data Operation</option>
                    <option value="workflow">Trigger Workflow</option>
                    <option value="api">API Call</option>
                    <option value="socketio">Socket.IO Event</option>
                    <option value="webhook">Webhook</option>
                    <option value="jsonlex">JSONLex Expression</option>
                    <option value="ui">UI Manipulation</option>
                    <option value="state">State Management</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Function/Action</label>
                  <select id="eventActionSelect" class="property-input">
                    <option value="">Select action...</option>
                  </select>
                </div>
              </div>

              <!-- Configuration Buttons (shown based on action type) -->
              <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <button type="button" class="btn btn-sm btn-secondary" id="apiCallBuilderBtn" style="display: none;">
                  <i class="fas fa-cog"></i> Build API Call
                </button>
                <button type="button" class="btn btn-sm btn-secondary" id="socketConfigBtn" style="display: none;">
                  <i class="fas fa-cog"></i> Configure Socket.IO
                </button>
                <button type="button" class="btn btn-sm btn-secondary" id="webhookConfigBtn" style="display: none;">
                  <i class="fas fa-cog"></i> Configure Webhook
                </button>
                <button type="button" class="btn btn-sm btn-secondary" id="jsonlexConfigBtn" style="display: none;">
                  <i class="fas fa-cog"></i> Configure JSONLex
                </button>
              </div>

              <div class="form-group">
                <label>
                  <input type="checkbox" id="eventConditional">
                  Run conditionally (enter condition)
                </label>
                <input type="text" id="eventCondition" class="property-input mt-2" placeholder="e.g., $.fieldName === 'value'" disabled>
              </div>

              <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button class="btn btn-primary" id="addEventHandlerBtn">
                  <i class="fas fa-plus"></i> Add Event Handler
                </button>
                <button class="btn btn-secondary" id="clearEventHandlerBtn">
                  <i class="fas fa-times"></i> Clear
                </button>
              </div>
            </div>

            <h4 style="margin-bottom: 0.75rem; color: var(--text-primary);">Configured Event Handlers</h4>
            <div class="event-handlers-list" id="eventHandlersList">
              <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                No event handlers configured yet.
              </div>
            </div>
          </div>
        </div>

        <!-- Variables Tab -->
        <div class="tab-content" id="variablesTab">
          <div class="variables-container" style="padding: 2rem; background: var(--bg-primary); overflow: auto;">
            <div class="variables-toolbar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3 style="margin: 0; color: var(--text-primary);">Variables</h3>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary btn-sm" id="importVariablesBtn">
                  <i class="fas fa-file-import"></i> Import
                </button>
                <button class="btn btn-secondary btn-sm" id="exportVariablesBtn">
                  <i class="fas fa-file-export"></i> Export
                </button>
                <button class="btn btn-primary btn-sm" id="addVariableBtn">
                  <i class="fas fa-plus"></i> Add Variable
                </button>
              </div>
            </div>

            <!-- Search Bar -->
            <div style="margin-bottom: 1.5rem;">
              <input type="text" id="variablesGlobalSearch" placeholder="Search variables..."
                     class="property-input" style="width: 100%; max-width: 400px;">
            </div>

            <!-- Variables Table -->
            <div class="variables-table-container" style="overflow-x: auto;">
              <table class="variables-table" style="width: 100%; border-collapse: collapse; background: white;">
                <thead>
                  <tr>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color); background: var(--bg-secondary); font-weight: 600; color: var(--text-primary);">Name</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color); background: var(--bg-secondary); font-weight: 600; color: var(--text-primary);">Type</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color); background: var(--bg-secondary); font-weight: 600; color: var(--text-primary);">Scope</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color); background: var(--bg-secondary); font-weight: 600; color: var(--text-primary);">Default Value</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color); background: var(--bg-secondary); font-weight: 600; color: var(--text-primary);">Source</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color); background: var(--bg-secondary); font-weight: 600; color: var(--text-primary);">Actions</th>
                  </tr>
                </thead>
                <tbody id="variablesTableBody">
                  <tr>
                    <td colspan="6" class="text-muted" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                      No variables defined. Click "Add Variable" to create one.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Permissions Tab -->
        <div class="tab-content" id="permissionsTab">
          <div style="padding: 2rem; background: white; overflow: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3 style="margin: 0; color: var(--text-primary);">Permissions Manager</h3>
              <button class="btn btn-sm btn-primary" id="addPermissionRuleBtn">
                <i class="fas fa-plus"></i> Add Rule
              </button>
            </div>

            <div class="property-group">
              <div class="property-group-title">Form-Level Permissions</div>

              <!-- Permissions Table -->
              <div style="overflow-x: auto; margin-top: 1rem;">
                <table class="permissions-table" style="width: 100%; border-collapse: collapse; background: white;">
                  <thead style="background: var(--bg-secondary);">
                    <tr>
                      <th style="padding: 0.75rem; text-align: left; border: 1px solid var(--border-color); font-weight: 600; font-size: 0.875rem;">Action</th>
                      <th style="padding: 0.75rem; text-align: left; border: 1px solid var(--border-color); font-weight: 600; font-size: 0.875rem;">Enabled</th>
                      <th style="padding: 0.75rem; text-align: left; border: 1px solid var(--border-color); font-weight: 600; font-size: 0.875rem; min-width: 200px;">Permission Type</th>
                      <th style="padding: 0.75rem; text-align: left; border: 1px solid var(--border-color); font-weight: 600; font-size: 0.875rem; min-width: 250px;">Specific Users/Groups/Roles</th>
                      <th style="padding: 0.75rem; text-align: center; border: 1px solid var(--border-color); font-weight: 600; font-size: 0.875rem; width: 100px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="permissionsTableBody">
                    <!-- View Permission -->
                    <tr>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color); font-weight: 500;">
                        <i class="fas fa-eye" style="margin-right: 0.5rem; color: var(--primary-color);"></i>View Form
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <input type="checkbox" id="permViewEnabled" checked style="cursor: pointer;">
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <select id="permViewSelect" class="property-input" style="margin: 0;">
                          <option value="all">All Users</option>
                          <option value="authenticated">Authenticated Users</option>
                          <option value="owner">Owner Only</option>
                          <option value="specific">Specific Users/Groups/Roles</option>
                          <option value="none">None (Private)</option>
                        </select>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <button class="btn btn-sm btn-secondary" id="selectViewSpecificBtn" style="display: none;">
                          <i class="fas fa-users"></i> Select...
                        </button>
                        <div id="viewSpecificList" style="font-size: 0.813rem; color: var(--text-secondary);"></div>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color); text-align: center;">
                        <button class="btn btn-sm btn-secondary" onclick="permissionsManager.resetPermission('view')" title="Reset to default">
                          <i class="fas fa-undo"></i>
                        </button>
                      </td>
                    </tr>

                    <!-- Edit Permission -->
                    <tr>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color); font-weight: 500;">
                        <i class="fas fa-edit" style="margin-right: 0.5rem; color: var(--warning-color);"></i>Edit Form
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <input type="checkbox" id="permEditEnabled" style="cursor: pointer;">
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <select id="permEditSelect" class="property-input" style="margin: 0;">
                          <option value="all">All Users</option>
                          <option value="authenticated">Authenticated Users</option>
                          <option value="owner">Owner Only</option>
                          <option value="specific">Specific Users/Groups/Roles</option>
                          <option value="none">None</option>
                        </select>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <button class="btn btn-sm btn-secondary" id="selectEditSpecificBtn" style="display: none;">
                          <i class="fas fa-users"></i> Select...
                        </button>
                        <div id="editSpecificList" style="font-size: 0.813rem; color: var(--text-secondary);"></div>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color); text-align: center;">
                        <button class="btn btn-sm btn-secondary" onclick="permissionsManager.resetPermission('edit')" title="Reset to default">
                          <i class="fas fa-undo"></i>
                        </button>
                      </td>
                    </tr>

                    <!-- Submit Permission -->
                    <tr>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color); font-weight: 500;">
                        <i class="fas fa-paper-plane" style="margin-right: 0.5rem; color: var(--success-color);"></i>Submit Form
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <input type="checkbox" id="permSubmitEnabled" style="cursor: pointer;">
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <select id="permSubmitSelect" class="property-input" style="margin: 0;">
                          <option value="all">All Users</option>
                          <option value="authenticated">Authenticated Users</option>
                          <option value="owner">Owner Only</option>
                          <option value="specific">Specific Users/Groups/Roles</option>
                          <option value="none">None</option>
                        </select>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <button class="btn btn-sm btn-secondary" id="selectSubmitSpecificBtn" style="display: none;">
                          <i class="fas fa-users"></i> Select...
                        </button>
                        <div id="submitSpecificList" style="font-size: 0.813rem; color: var(--text-secondary);"></div>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color); text-align: center;">
                        <button class="btn btn-sm btn-secondary" onclick="permissionsManager.resetPermission('submit')" title="Reset to default">
                          <i class="fas fa-undo"></i>
                        </button>
                      </td>
                    </tr>

                    <!-- Delete Permission -->
                    <tr>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color); font-weight: 500;">
                        <i class="fas fa-trash" style="margin-right: 0.5rem; color: var(--danger-color);"></i>Delete Records
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <input type="checkbox" id="permDeleteEnabled" style="cursor: pointer;">
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <select id="permDeleteSelect" class="property-input" style="margin: 0;">
                          <option value="all">All Users</option>
                          <option value="authenticated">Authenticated Users</option>
                          <option value="owner">Owner Only</option>
                          <option value="specific">Specific Users/Groups/Roles</option>
                          <option value="none">None</option>
                        </select>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <button class="btn btn-sm btn-secondary" id="selectDeleteSpecificBtn" style="display: none;">
                          <i class="fas fa-users"></i> Select...
                        </button>
                        <div id="deleteSpecificList" style="font-size: 0.813rem; color: var(--text-secondary);"></div>
                      </td>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color); text-align: center;">
                        <button class="btn btn-sm btn-secondary" onclick="permissionsManager.resetPermission('delete')" title="Reset to default">
                          <i class="fas fa-undo"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Component-Level Permissions Section -->
            <div class="property-group" style="margin-top: 2rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="property-group-title">Component-Level Permissions</div>
                <button class="btn btn-sm btn-primary" id="configureComponentPermsBtn">
                  <i class="fas fa-cog"></i> Configure
                </button>
              </div>
              <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                Control which users can see or edit specific components on the canvas. Click "Configure" to set per-component permissions.
              </p>
              <div id="componentPermsSummary" style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 4px; font-size: 0.875rem;">
                <em>No component-specific permissions configured.</em>
              </div>
            </div>

            <!-- Token Requirements Section -->
            <div class="property-group" style="margin-top: 2rem;">
              <div class="property-group-title">Token & Authentication Requirements</div>

              <div style="margin-top: 1rem;">
                <table style="width: 100%; border-collapse: collapse;">
                  <tbody>
                    <tr>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <label style="display: flex; align-items: center; margin: 0; cursor: pointer;">
                          <input type="checkbox" id="requireCAToken" style="margin-right: 0.75rem;">
                          <div>
                            <div style="font-weight: 500;">Require CA Token</div>
                            <div style="font-size: 0.813rem; color: var(--text-secondary);">Users must provide a valid CA token to access this form</div>
                          </div>
                        </label>
                      </td>
                    </tr>
                    <tr>
                      <td style="padding: 0.75rem; border: 1px solid var(--border-color);">
                        <label style="display: flex; align-items: center; margin: 0; cursor: pointer;">
                          <input type="checkbox" id="validateExprsAuth" style="margin-right: 0.75rem;">
                          <div>
                            <div style="font-weight: 500;">Validate via exprsn-auth</div>
                            <div style="font-size: 0.813rem; color: var(--text-secondary);">Validate user authentication through exprsn-auth service</div>
                          </div>
                        </label>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="property-field" style="margin-top: 1rem;">
                <label class="property-label">Required CA Token Permissions</label>
                <select id="requiredPermissionsSelect" class="property-input" multiple size="4">
                  <option value="read">Read</option>
                  <option value="write">Write</option>
                  <option value="append">Append</option>
                  <option value="delete">Delete</option>
                </select>
                <p class="text-muted mt-2">Hold Ctrl/Cmd to select multiple</p>
              </div>
            </div>

            <div class="property-group">
              <div class="property-group-title">Component-Level Permissions</div>
              <p class="text-muted">Configure permissions for individual form components</p>
              <button class="btn btn-secondary btn-sm mt-2" id="configureComponentPermsBtn">
                <i class="fas fa-cog"></i> Configure Component Permissions
              </button>
            </div>
          </div>
        </div>

        <!-- Workflows Tab -->
        <div class="tab-content" id="workflowsTab">
          <div style="padding: 2rem; background: white; overflow: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3 style="margin: 0; color: var(--text-primary);">Workflow Integration</h3>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary btn-sm" id="importWorkflowBtn">
                  <i class="fas fa-file-import"></i> Import
                </button>
                <button class="btn btn-secondary btn-sm" id="exportWorkflowBtn">
                  <i class="fas fa-file-export"></i> Export
                </button>
                <button class="btn btn-primary btn-sm" id="newWorkflowBtn">
                  <i class="fas fa-plus"></i> New Workflow
                </button>
              </div>
            </div>

            <div class="property-group">
              <div class="property-group-title">Workflow Triggers</div>

              <div class="property-field">
                <label class="property-label">
                  <input type="checkbox" id="workflowOnSubmit"> Execute on Form Submit
                </label>
                <select id="workflowOnSubmitSelect" class="property-input mt-2">
                  <option value="">Select workflow...</option>
                </select>
              </div>

              <div class="property-field">
                <label class="property-label">
                  <input type="checkbox" id="workflowOnChange"> Execute on Field Change
                </label>
                <select id="workflowOnChangeSelect" class="property-input mt-2">
                  <option value="">Select workflow...</option>
                </select>
              </div>

              <div class="property-field">
                <label class="property-label">
                  <input type="checkbox" id="workflowOnLoad"> Execute on Form Load
                </label>
                <select id="workflowOnLoadSelect" class="property-input mt-2">
                  <option value="">Select workflow...</option>
                </select>
              </div>
            </div>

            <div class="property-group">
              <div class="property-group-title">Exprsn-Kicks Workflow Canvas</div>
              <div id="exprsn-kicks-container" style="min-height: 400px; border: 1px solid var(--border-color); border-radius: 6px; background: #f9f9f9;">
                <div style="display: flex; align-items: center; justify-content: center; height: 400px; color: var(--text-secondary);">
                  <div style="text-align: center;">
                    <i class="fas fa-project-diagram" style="font-size: 3rem; margin-bottom: 1rem; color: var(--primary-color);"></i>
                    <p>Exprsn-Kicks visual workflow builder will load here</p>
                    <button class="btn btn-primary mt-2" id="launchKicksBtn">
                      <i class="fas fa-rocket"></i> Launch Workflow Designer
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="property-group">
              <div class="property-group-title">Field Mapping</div>
              <p class="text-muted">Map form fields to workflow inputs</p>
              <div id="fieldMappingContainer">
                <p class="text-muted" style="text-align: center; padding: 1rem;">
                  Select a workflow to configure field mapping
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Form JSON Tab -->
        <div class="tab-content" id="jsonTab">
          <div style="display: flex; flex-direction: column; height: 100%;">
            <div style="background: white; border-bottom: 1px solid var(--border-color); padding: 0.75rem 1rem; display: flex; gap: 0.5rem; align-items: center;">
              <button class="btn btn-secondary btn-sm" id="importJsonBtn">
                <i class="fas fa-file-import"></i> Import
              </button>
              <button class="btn btn-secondary btn-sm" id="exportJsonBtn">
                <i class="fas fa-file-export"></i> Export
              </button>
              <button class="btn btn-secondary btn-sm" id="validateJsonBtn">
                <i class="fas fa-check-circle"></i> Validate
              </button>
              <button class="btn btn-secondary btn-sm" id="formatJsonBtn">
                <i class="fas fa-magic"></i> Format
              </button>
              <div style="flex: 1;"></div>
              <button class="btn btn-primary btn-sm" id="copyJsonBtn">
                <i class="fas fa-copy"></i> Copy JSON
              </button>
            </div>
            <div id="jsonEditor" style="flex: 1;"></div>
          </div>
        </div>
      </div>

      <!-- Right Sidebar - Properties -->
      <aside class="properties-panel" id="propertiesPanel">
        <button class="sidebar-toggle" id="propertiesToggle" title="Toggle Properties Panel">
          <i class="fas fa-chevron-right"></i>
        </button>
        <div class="panel-header">
          <span id="propertiesPanelTitle">Properties</span>
        </div>

        <!-- Properties Tabs -->
        <div class="properties-tabs">
          <button class="prop-tab-btn active" data-prop-tab="properties" title="Properties">
            <i class="fas fa-sliders-h"></i>
          </button>
          <button class="prop-tab-btn" data-prop-tab="styling" title="Styling">
            <i class="fas fa-palette"></i>
          </button>
          <button class="prop-tab-btn" data-prop-tab="events" title="Events">
            <i class="fas fa-bolt"></i>
          </button>
          <button class="prop-tab-btn" data-prop-tab="code" title="Code">
            <i class="fas fa-code"></i>
          </button>
          <button class="prop-tab-btn" data-prop-tab="variables" title="Variables">
            <i class="fas fa-database"></i>
          </button>
          <button class="prop-tab-btn" data-prop-tab="workflows" title="Workflows">
            <i class="fas fa-project-diagram"></i>
          </button>
          <button class="prop-tab-btn" data-prop-tab="permissions" title="Permissions">
            <i class="fas fa-lock"></i>
          </button>
          <button class="prop-tab-btn" data-prop-tab="json" title="JSON">
            <i class="fas fa-code-branch"></i>
          </button>
        </div>

        <!-- Properties Tab Content -->
        <div class="prop-tab-content active" id="propTabProperties">
          <div class="properties-content" id="propertiesContent">
            <div class="property-group">
              <div class="property-group-title">Component Settings</div>
              <p style="color: var(--text-secondary); font-size: 0.875rem;">
                Select a component to edit its properties
              </p>
            </div>
          </div>
        </div>

        <!-- Styling Tab Content -->
        <div class="prop-tab-content" id="propTabStyling">
          <div class="properties-content">
            <div class="property-group">
              <div class="property-group-title">Styling</div>
              <div class="property-field">
                <label class="property-label">Width</label>
                <input type="text" class="property-input" id="styleWidth" placeholder="auto">
              </div>
              <div class="property-field">
                <label class="property-label">Height</label>
                <input type="text" class="property-input" id="styleHeight" placeholder="auto">
              </div>
              <div class="property-field">
                <label class="property-label">Padding</label>
                <input type="text" class="property-input" id="stylePadding" placeholder="0">
              </div>
              <div class="property-field">
                <label class="property-label">Margin</label>
                <input type="text" class="property-input" id="styleMargin" placeholder="0">
              </div>
              <div class="property-field">
                <label class="property-label">Background Color</label>
                <input type="color" class="property-input" id="styleBgColor">
              </div>
              <div class="property-field">
                <label class="property-label">Text Color</label>
                <input type="color" class="property-input" id="styleTextColor">
              </div>
              <div class="property-field">
                <label class="property-label">Border</label>
                <input type="text" class="property-input" id="styleBorder" placeholder="1px solid #ccc">
              </div>
              <div class="property-field">
                <label class="property-label">Border Radius</label>
                <input type="text" class="property-input" id="styleBorderRadius" placeholder="4px">
              </div>
              <div class="property-field">
                <label class="property-label">Custom CSS</label>
                <textarea class="property-input" id="styleCustomCss" rows="4" placeholder="Enter custom CSS..."></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Events Tab Content -->
        <div class="prop-tab-content" id="propTabEvents">
          <div class="properties-content">
            <div class="property-group">
              <div class="property-group-title">Component Events</div>
              <div id="componentEventsTable"></div>
            </div>
          </div>
        </div>

        <!-- Code Inspector Tab Content -->
        <div class="prop-tab-content" id="propTabCode">
          <div style="display: flex; flex-direction: column; height: 100%;">
            <div style="padding: 0.75rem 1rem; background: var(--bg-primary); border-bottom: 1px solid var(--border-color);">
              <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                <button class="btn btn-secondary btn-sm" onclick="formatCode()">
                  <i class="fas fa-magic"></i> Format
                </button>
                <button class="btn btn-secondary btn-sm" onclick="validateCode()">
                  <i class="fas fa-check-circle"></i> Validate
                </button>
                <div style="flex: 1"></div>
                <select id="codeLanguage" class="property-input" style="width: auto; padding: 0.25rem 0.5rem; font-size: 0.813rem;">
                  <option value="javascript">JavaScript</option>
                  <option value="json">JSON</option>
                  <option value="html">HTML</option>
                  <option value="css">CSS</option>
                </select>
              </div>
            </div>
            <div style="flex: 1; overflow: hidden; position: relative;">
              <div id="codeEditor" style="width: 100%; height: 100%; font-size: 13px;"></div>
            </div>
          </div>
        </div>

        <!-- Variables Inspector Tab Content -->
        <div class="prop-tab-content" id="propTabVariables">
          <div style="display: flex; flex-direction: column; height: 100%;">
            <div style="padding: 0.75rem 1rem; background: var(--bg-primary); border-bottom: 1px solid var(--border-color);">
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-primary btn-sm" onclick="addComponentVariable()">
                  <i class="fas fa-plus"></i> Add Variable
                </button>
                <button class="btn btn-secondary btn-sm" onclick="refreshVariables()">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <div style="flex: 1"></div>
                <input type="text" placeholder="Search variables..." class="property-input" style="width: 150px; padding: 0.25rem 0.5rem; font-size: 0.813rem;" onkeyup="filterVariables(this.value)">
              </div>
            </div>
            <div style="flex: 1; overflow-y: auto; padding: 1rem;">
              <div id="componentVariablesTable">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                  <thead style="background: var(--bg-secondary); position: sticky; top: 0;">
                    <tr>
                      <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--border-color);">Name</th>
                      <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--border-color);">Type</th>
                      <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--border-color);">Value</th>
                      <th style="padding: 0.5rem; text-align: center; border-bottom: 2px solid var(--border-color); width: 80px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="variablesTableBody">
                    <tr>
                      <td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                        No variables defined. Click "Add Variable" to create one.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Permissions Tab Content -->
        <div class="prop-tab-content" id="propTabPermissions">
          <div class="properties-content">
            <div class="property-group">
              <div class="property-group-title">Component Permissions</div>
              <div id="componentPermissionsTable"></div>
            </div>
          </div>
        </div>

        <!-- Workflows Inspector Tab Content -->
        <div class="prop-tab-content" id="propTabWorkflows">
          <div style="display: flex; flex-direction: column; height: 100%;">
            <div style="padding: 0.75rem 1rem; background: var(--bg-primary); border-bottom: 1px solid var(--border-color);">
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-primary btn-sm" onclick="attachWorkflow()">
                  <i class="fas fa-link"></i> Attach Workflow
                </button>
                <button class="btn btn-secondary btn-sm" onclick="createNewWorkflow()">
                  <i class="fas fa-plus"></i> New Workflow
                </button>
                <div style="flex: 1"></div>
                <select class="property-input" style="width: auto; padding: 0.25rem 0.5rem; font-size: 0.813rem;" onchange="filterWorkflowsByType(this.value)">
                  <option value="">All Types</option>
                  <option value="onSubmit">On Submit</option>
                  <option value="onChange">On Change</option>
                  <option value="onLoad">On Load</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
            </div>
            <div style="flex: 1; overflow-y: auto; padding: 1rem;">
              <div id="componentWorkflowsTable">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                  <thead style="background: var(--bg-secondary); position: sticky; top: 0;">
                    <tr>
                      <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--border-color);">Workflow Name</th>
                      <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--border-color);">Trigger</th>
                      <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--border-color);">Status</th>
                      <th style="padding: 0.5rem; text-align: center; border-bottom: 2px solid var(--border-color); width: 100px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="workflowsTableBody">
                    <tr>
                      <td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                        No workflows attached. Click "Attach Workflow" to link an existing workflow or "New Workflow" to create one.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- JSON Tab Content -->
        <div class="prop-tab-content" id="propTabJson">
          <div class="properties-content">
            <div class="property-group">
              <div class="property-group-title">Component JSON</div>
              <pre id="componentJsonView" style="background: #f5f5f5; padding: 1rem; border-radius: 4px; font-size: 0.813rem; overflow-x: auto;"></pre>
            </div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Add Variable Modal -->
  <div class="modal" id="addVariableModal">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3 class="modal-title">Add Variable</h3>
        <button class="modal-close" onclick="variablesManager.closeAddVariableModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="form-group">
        <label>Variable Key</label>
        <input type="text" id="varKey" class="property-input" placeholder="e.g., currentUser">
        <small class="text-muted">Unique identifier for this variable</small>
      </div>

      <div class="form-group">
        <label>Type</label>
        <select id="varType" class="property-input">
          <option value="string">String</option>
          <option value="number">Number</option>
          <option value="boolean">Boolean</option>
          <option value="object">Object</option>
          <option value="array">Array</option>
        </select>
      </div>

      <div class="form-group">
        <label>Scope</label>
        <select id="varScope" class="property-input">
          <option value="form">Form (this form only)</option>
          <option value="workflow">Workflow (shared across workflow steps)</option>
          <option value="session">Session (user's browser session)</option>
          <option value="global">Global (application-wide)</option>
        </select>
      </div>

      <div class="form-group">
        <label>Default Value</label>
        <textarea id="varDefault" class="property-input" rows="4" placeholder="Enter default value (JSON format for objects/arrays)"></textarea>
      </div>

      <!-- Array Configurator (shown when type=array) -->
      <div id="arrayConfigurator" style="display: none; margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4 style="margin: 0; font-size: 1rem; color: var(--text-primary);">Array Configuration</h4>
          <button type="button" class="btn btn-sm btn-primary" id="addArrayColumnBtn">
            <i class="fas fa-plus"></i> Add Column
          </button>
        </div>

        <!-- Array Columns Table -->
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem;">Columns</label>
          <table style="width: 100%; border-collapse: collapse; background: white;">
            <thead>
              <tr style="background: var(--bg-secondary);">
                <th style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: left; font-size: 0.813rem;">Name</th>
                <th style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: left; font-size: 0.813rem;">Type</th>
                <th style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: center; width: 80px; font-size: 0.813rem;">Actions</th>
              </tr>
            </thead>
            <tbody id="arrayColumnsTable">
              <tr>
                <td colspan="3" style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">
                  No columns defined. Click "Add Column" to create one.
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Array Items Table -->
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <label style="margin: 0; font-weight: 600; font-size: 0.875rem;">Default Items</label>
            <button type="button" class="btn btn-sm btn-secondary" id="addArrayItemBtn">
              <i class="fas fa-plus"></i> Add Row
            </button>
          </div>
          <div style="overflow-x: auto; max-height: 200px; overflow-y: auto;">
            <table style="width: 100%; border-collapse: collapse; background: white;">
              <thead id="arrayItemsHeader">
                <tr style="background: var(--bg-secondary);">
                  <th style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: center; width: 80px; font-size: 0.813rem;">Actions</th>
                </tr>
              </thead>
              <tbody id="arrayItemsTable">
                <tr>
                  <td style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">
                    Define columns first, then add items.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Associations -->
      <div class="form-group" style="margin-top: 1.5rem;">
        <label>
          <i class="fas fa-link"></i> Associations
          <small class="text-muted" style="display: block; margin-top: 0.25rem;">Comma-separated list of forms, objects, workflows, or parameters that use this variable</small>
        </label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.5rem;">
          <div>
            <label style="font-size: 0.813rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Forms</label>
            <input type="text" id="assocForms" class="property-input" placeholder="e.g., user-profile, settings">
          </div>
          <div>
            <label style="font-size: 0.813rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Objects</label>
            <input type="text" id="assocObjects" class="property-input" placeholder="e.g., user-grid, dashboard">
          </div>
          <div>
            <label style="font-size: 0.813rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Workflows</label>
            <input type="text" id="assocWorkflows" class="property-input" placeholder="e.g., onboarding, approval">
          </div>
          <div>
            <label style="font-size: 0.813rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Parameters</label>
            <input type="text" id="assocParameters" class="property-input" placeholder="e.g., userId, sessionId">
          </div>
        </div>
      </div>

      <!-- Locked & Readonly Properties -->
      <div class="form-group" style="margin-top: 1rem;">
        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0.5rem;">
          <input type="checkbox" id="varLocked" style="margin-right: 0.5rem; cursor: pointer;">
          <i class="fas fa-lock" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
          <span>Locked (cannot be deleted)</span>
        </label>
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="checkbox" id="varReadonly" style="margin-right: 0.5rem; cursor: pointer;">
          <i class="fas fa-eye" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
          <span>Read-only (cannot be modified at runtime)</span>
        </label>
      </div>

      <!-- Description -->
      <div class="form-group" style="margin-top: 1rem;">
        <label>Description <span class="text-muted">(optional)</span></label>
        <textarea id="varDescription" class="property-input" rows="2" placeholder="Describe the purpose of this variable"></textarea>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="variablesManager.closeAddVariableModal()">Cancel</button>
        <button class="btn btn-primary" id="saveVariableBtn">Add Variable</button>
      </div>
    </div>
  </div>

  <!-- User/Role/Group Selector Modal -->
  <div class="modal" id="userRoleSelectorModal">
    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
      <div class="modal-header">
        <h3 class="modal-title" id="selectorModalTitle">Select Users, Groups & Roles</h3>
        <button class="modal-close" onclick="permissionsManager.closeSelectorModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Tabs for Users/Groups/Roles -->
      <div style="border-bottom: 1px solid var(--border-color);">
        <div style="display: flex; gap: 1rem; padding: 0 1.5rem;">
          <button class="selector-tab-btn active" data-selector-tab="users">
            <i class="fas fa-user"></i> Users
          </button>
          <button class="selector-tab-btn" data-selector-tab="groups">
            <i class="fas fa-users"></i> Groups
          </button>
          <button class="selector-tab-btn" data-selector-tab="roles">
            <i class="fas fa-user-tag"></i> Roles
          </button>
        </div>
      </div>

      <!-- Tab Content -->
      <div style="padding: 1.5rem; overflow-y: auto; max-height: 400px;">
        <!-- Users Tab -->
        <div class="selector-tab-content active" id="selectorTabUsers">
          <div style="margin-bottom: 1rem;">
            <input type="text" id="userSearchInput" class="property-input" placeholder="Search users by name or email...">
          </div>
          <div style="overflow-y: auto; max-height: 300px; border: 1px solid var(--border-color); border-radius: 4px;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 1;">
                <tr>
                  <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.875rem;">
                    <input type="checkbox" id="selectAllUsers" title="Select all"> Select
                  </th>
                  <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.875rem;">Name</th>
                  <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.875rem;">Email</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr>
                  <td colspan="3" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                    Loading users...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Groups Tab -->
        <div class="selector-tab-content" id="selectorTabGroups">
          <div style="margin-bottom: 1rem;">
            <input type="text" id="groupSearchInput" class="property-input" placeholder="Search groups...">
          </div>
          <div style="overflow-y: auto; max-height: 300px; border: 1px solid var(--border-color); border-radius: 4px;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 1;">
                <tr>
                  <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.875rem;">
                    <input type="checkbox" id="selectAllGroups" title="Select all"> Select
                  </th>
                  <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.875rem;">Group Name</th>
                  <th style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 0.875rem;">Members</th>
                </tr>
              </thead>
              <tbody id="groupsTableBody">
                <tr>
                  <td colspan="3" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                    Loading groups...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Roles Tab -->
        <div class="selector-tab-content" id="selectorTabRoles">
          <div style="margin-bottom: 1rem;">
            <input type="text" id="roleSearchInput" class="property-input" placeholder="Search roles...">
          </div>
          <div style="overflow-y: auto; max-height: 300px; border: 1px solid var(--border-color); border-radius: 4px;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 1;">
                <tr>
                  <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.875rem;">
                    <input type="checkbox" id="selectAllRoles" title="Select all"> Select
                  </th>
                  <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.875rem;">Role Name</th>
                  <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.875rem;">Description</th>
                </tr>
              </thead>
              <tbody id="rolesTableBody">
                <tr>
                  <td colspan="3" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                    Loading roles...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Selection Summary -->
      <div id="selectionSummary" style="padding: 1rem 1.5rem; background: var(--bg-secondary); border-top: 1px solid var(--border-color); font-size: 0.875rem;">
        <strong>Selected:</strong> <span id="selectionCount">0 users, 0 groups, 0 roles</span>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="permissionsManager.closeSelectorModal()">Cancel</button>
        <button class="btn btn-primary" onclick="permissionsManager.saveSelection()">Save Selection</button>
      </div>
    </div>
  </div>

  <!-- Add Function Modal -->
  <div class="modal" id="addFunctionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add Function</h3>
        <button class="modal-close" onclick="functionsManager.closeAddFunctionModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="form-group">
        <label>Function Name</label>
        <input type="text" id="funcName" class="property-input" placeholder="e.g., calculateTotal">
      </div>

      <div class="form-group">
        <label style="display: flex; justify-content: space-between; align-items: center;">
          <span>Parameters</span>
          <button type="button" class="btn btn-sm btn-primary" onclick="functionsManager.addParameterRow()" title="Add parameter">
            <i class="fas fa-plus"></i> Add
          </button>
        </label>
        <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px;">
          <table class="param-table" style="width: 100%; border-collapse: collapse;">
            <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 1;">
              <tr style="border-bottom: 1px solid var(--border-color);">
                <th style="padding: 0.5rem; text-align: left; font-size: 0.75rem; color: var(--text-secondary);">Name</th>
                <th style="padding: 0.5rem; text-align: left; font-size: 0.75rem; color: var(--text-secondary);">Type</th>
                <th style="padding: 0.5rem; text-align: center; font-size: 0.75rem; color: var(--text-secondary); width: 80px;">Required</th>
                <th style="padding: 0.5rem; text-align: center; font-size: 0.75rem; color: var(--text-secondary); width: 50px;"></th>
              </tr>
            </thead>
            <tbody id="funcParamsTable">
              <tr>
                <td colspan="4" style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">
                  No parameters. Click "+ Add" to add a parameter.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="form-group">
        <label>Return Type</label>
        <select id="funcReturn" class="property-input">
          <option value="void">void</option>
          <option value="string">string</option>
          <option value="number">number</option>
          <option value="boolean">boolean</option>
          <option value="object">object</option>
          <option value="array">array</option>
          <option value="function">function</option>
          <option value="date">Date</option>
          <option value="regexp">RegExp</option>
          <option value="promise">Promise</option>
          <option value="map">Map</option>
          <option value="set">Set</option>
          <option value="symbol">Symbol</option>
          <option value="bigint">BigInt</option>
          <option value="any">any</option>
        </select>
      </div>

      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="funcAsync" style="cursor: pointer;">
          <span>Async Function</span>
          <small style="color: var(--text-secondary); margin-left: auto;">(supports await)</small>
        </label>
      </div>

      <div class="form-group">
        <label>Description</label>
        <textarea id="funcDesc" class="property-input" rows="3" placeholder="Describe what this function does"></textarea>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="functionsManager.closeAddFunctionModal()">Cancel</button>
        <button class="btn btn-primary" id="saveFunctionMetaBtn">Create Function</button>
      </div>
    </div>
  </div>

  <script>
    // Global state
    window.FORM_DESIGNER_STATE = {
      appId: '<%= appId %>',
      formId: '<%= form ? form.id : null %>',
      form: <%= form ? JSON.stringify(form) : 'null' %>,
      selectedComponent: null,
      components: [],
      customFunctions: {},
      variables: {},
      eventHandlers: [],
      permissions: {},
      workflows: {},
      forgeMappings: [],
      isDirty: false,
      currentTab: 'canvas'
    };
  </script>

  <!-- Monaco Editor -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>

  <!-- Form Designer Modules -->
  <script src="/lowcode/public/js/form-functions-manager.js"></script>
  <script src="/lowcode/public/js/form-events-manager-enhanced.js"></script>
  <script src="/lowcode/public/js/form-variables-manager-enhanced.js"></script>
  <script src="/lowcode/public/js/form-permissions-manager.js"></script>
  <script src="/lowcode/public/js/form-workflow-manager.js"></script>
  <script src="/lowcode/public/js/form-forge-manager.js"></script>
  <script src="/lowcode/public/js/form-json-manager.js"></script>
  <script src="/lowcode/public/js/form-designer-pro.js"></script>

  <!-- Monaco Editor Integration & Enhanced Function Builder -->
  <script>
    // ============================================================================
    // XSS Protection Helper
    // ============================================================================
    /**
     * Safely sets HTML content with DOMPurify sanitization
     * @param {HTMLElement} element - The element to set innerHTML on
     * @param {string} html - The HTML content to sanitize and set
     */
    function safeSetHTML(element, html) {
      if (!element) return;
      element.innerHTML = DOMPurify.sanitize(html, {
        ALLOWED_TAGS: ['div', 'span', 'p', 'a', 'b', 'i', 'u', 'strong', 'em', 'br', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'button', 'input', 'label', 'select', 'option', 'textarea', 'form', 'img', 'svg', 'path'],
        ALLOWED_ATTR: ['class', 'id', 'style', 'href', 'src', 'alt', 'title', 'data-*', 'value', 'type', 'name', 'placeholder', 'disabled', 'readonly', 'checked', 'selected', 'role', 'aria-*', 'onclick', 'onchange', 'oninput'],
        ALLOW_DATA_ATTR: true
      });
    }

    // ============================================================================
    // Event Listener Cleanup Manager
    // ============================================================================
    /**
     * Centralized event listener manager with automatic cleanup
     * Prevents memory leaks by tracking all event listeners
     */
    class EventManager {
      constructor() {
        this.abortControllers = new Map();
        this.listenerCount = 0;
      }

      /**
       * Add an event listener with automatic cleanup support
       * @param {EventTarget} target - Element to attach listener to
       * @param {string} event - Event name
       * @param {Function} handler - Event handler function
       * @param {string} group - Optional group name for batch cleanup
       * @param {Object} options - Additional event listener options
       */
      on(target, event, handler, group = 'default', options = {}) {
        if (!target) {
          console.warn('EventManager: Invalid target for event', event);
          return;
        }

        // Get or create AbortController for this group
        if (!this.abortControllers.has(group)) {
          this.abortControllers.set(group, new AbortController());
        }

        const controller = this.abortControllers.get(group);

        // Add event listener with signal for cleanup
        target.addEventListener(event, handler, {
          ...options,
          signal: controller.signal
        });

        this.listenerCount++;
      }

      /**
       * Remove all event listeners in a group
       * @param {string} group - Group name to cleanup
       */
      off(group = 'default') {
        const controller = this.abortControllers.get(group);
        if (controller) {
          controller.abort();
          this.abortControllers.delete(group);
        }
      }

      /**
       * Remove all event listeners across all groups
       */
      cleanup() {
        this.abortControllers.forEach(controller => controller.abort());
        this.abortControllers.clear();
        this.listenerCount = 0;
      }

      /**
       * Get diagnostic info about active listeners
       */
      getStats() {
        return {
          groups: this.abortControllers.size,
          totalListeners: this.listenerCount
        };
      }
    }

    // Global event manager instance
    const eventManager = new EventManager();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      eventManager.cleanup();
    });

    // ============================================================================
    // Input Validation System
    // ============================================================================
    /**
     * Validation rules and helpers for form inputs
     */
    const InputValidator = {
      /**
       * Validate form name
       * @param {string} name - The form name to validate
       * @returns {object} - {valid: boolean, error: string}
       */
      validateFormName(name) {
        // Trim whitespace
        const trimmed = name.trim();

        // Check if empty
        if (!trimmed) {
          return {
            valid: false,
            error: 'Form name cannot be empty'
          };
        }

        // Check minimum length
        if (trimmed.length < 2) {
          return {
            valid: false,
            error: 'Form name must be at least 2 characters'
          };
        }

        // Check maximum length
        if (trimmed.length > 100) {
          return {
            valid: false,
            error: 'Form name must be less than 100 characters'
          };
        }

        // Check for invalid characters (allow letters, numbers, spaces, hyphens, underscores)
        const validPattern = /^[a-zA-Z0-9\s\-_]+$/;
        if (!validPattern.test(trimmed)) {
          return {
            valid: false,
            error: 'Form name can only contain letters, numbers, spaces, hyphens, and underscores'
          };
        }

        // Check for dangerous patterns (SQL injection attempts, script tags)
        const dangerousPatterns = [
          /<script/i,
          /javascript:/i,
          /on\w+=/i,  // onclick=, onerror=, etc.
          /drop\s+table/i,
          /union\s+select/i,
          /insert\s+into/i,
          /delete\s+from/i,
          /--/,  // SQL comment
          /\/\*/  // SQL block comment
        ];

        for (const pattern of dangerousPatterns) {
          if (pattern.test(trimmed)) {
            return {
              valid: false,
              error: 'Form name contains invalid patterns'
            };
          }
        }

        return {
          valid: true,
          error: null,
          sanitized: trimmed
        };
      },

      /**
       * Show validation error message
       * @param {HTMLElement} input - Input element
       * @param {string} message - Error message
       */
      showError(input, message) {
        // Remove existing error
        this.clearError(input);

        // Add error styling
        input.classList.add('input-error');

        // Create error message element
        const errorDiv = document.createElement('div');
        errorDiv.className = 'input-validation-error';
        errorDiv.textContent = message;
        errorDiv.style.cssText = `
          color: #e74c3c;
          font-size: 0.75rem;
          margin-top: 0.25rem;
          padding: 0.25rem 0.5rem;
          background: #fee;
          border: 1px solid #fcc;
          border-radius: 4px;
          position: absolute;
          z-index: 1000;
          max-width: 300px;
        `;

        // Insert after input
        input.parentNode.style.position = 'relative';
        input.parentNode.appendChild(errorDiv);

        // Auto-hide after 5 seconds
        setTimeout(() => this.clearError(input), 5000);
      },

      /**
       * Clear validation error
       * @param {HTMLElement} input - Input element
       */
      clearError(input) {
        input.classList.remove('input-error');
        const existingError = input.parentNode.querySelector('.input-validation-error');
        if (existingError) {
          existingError.remove();
        }
      }
    };

    // ============================================================================
    // Centralized State Management System
    // ============================================================================
    /**
     * FormDesignerState - Centralized state management for Form Designer Pro
     *
     * Features:
     * - Single source of truth for all form designer state
     * - Observable pattern with change listeners
     * - State validation and type checking
     * - Undo/redo support with history tracking
     * - Automatic dirty state management
     * - Integration with autosave system
     */
    class FormDesignerState {
      constructor() {
        this._state = {
          // Form metadata
          formId: null,
          formName: 'Untitled Form',
          formType: 'form',
          applicationId: null,

          // Form structure
          schema: {},
          components: [],
          selectedComponents: [],

          // Custom code
          customFunctions: {},
          variables: [],

          // Editor state
          currentEditingFunction: null,
          monacoEditor: null,

          // UI state
          activeTab: 'designer',
          sidebarCollapsed: false,
          previewMode: 'desktop',

          // Change tracking
          isDirty: false,
          lastSaved: null,
          version: 1,

          // History for undo/redo
          history: [],
          historyIndex: -1,
          maxHistory: 50
        };

        // Change listeners
        this.listeners = new Map();

        // Bind methods
        this.setState = this.setState.bind(this);
        this.getState = this.getState.bind(this);
        this.subscribe = this.subscribe.bind(this);
        this.unsubscribe = this.unsubscribe.bind(this);
      }

      /**
       * Get current state or specific property
       * @param {string} key - Optional property key
       * @returns {*} - State value
       */
      getState(key = null) {
        if (key) {
          return this._state[key];
        }
        // Return shallow copy to prevent direct mutations
        return { ...this._state };
      }

      /**
       * Update state with validation and notifications
       * @param {Object} updates - State updates
       * @param {Object} options - Update options
       */
      setState(updates, options = {}) {
        const {
          silent = false,           // Skip notifications
          skipHistory = false,      // Skip history tracking
          skipDirty = false         // Skip dirty flag update
        } = options;

        // Validate updates
        const validatedUpdates = this._validateUpdates(updates);

        // Save to history before updating (for undo)
        if (!skipHistory && !this._isHistoryUpdate) {
          this._saveToHistory();
        }

        // Apply updates
        const changedKeys = [];
        for (const [key, value] of Object.entries(validatedUpdates)) {
          if (this._state[key] !== value) {
            this._state[key] = value;
            changedKeys.push(key);
          }
        }

        // Mark as dirty if not explicitly skipped
        if (!skipDirty && changedKeys.length > 0 && !changedKeys.includes('isDirty')) {
          this._state.isDirty = true;
          changedKeys.push('isDirty');
        }

        // Notify listeners
        if (!silent && changedKeys.length > 0) {
          this._notifyListeners(changedKeys, validatedUpdates);
        }

        return changedKeys;
      }

      /**
       * Subscribe to state changes
       * @param {string|Array} keys - Keys to watch (or '*' for all)
       * @param {Function} callback - Callback function
       * @returns {string} - Subscription ID
       */
      subscribe(keys, callback) {
        const id = `sub_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        this.listeners.set(id, {
          keys: Array.isArray(keys) ? keys : [keys],
          callback
        });

        return id;
      }

      /**
       * Unsubscribe from state changes
       * @param {string} subscriptionId - Subscription ID to remove
       */
      unsubscribe(subscriptionId) {
        this.listeners.delete(subscriptionId);
      }

      /**
       * Undo last change
       * @returns {boolean} - True if undo was successful
       */
      undo() {
        if (this.historyIndex < 0) {
          console.log('Nothing to undo');
          return false;
        }

        const previousState = this.history[this.historyIndex];
        this.historyIndex--;

        this._isHistoryUpdate = true;
        this.setState(previousState, { skipHistory: true, silent: false });
        this._isHistoryUpdate = false;

        console.log(` Undo: reverted to state ${this.historyIndex + 2}/${this.history.length}`);
        return true;
      }

      /**
       * Redo last undone change
       * @returns {boolean} - True if redo was successful
       */
      redo() {
        if (this.historyIndex >= this.history.length - 1) {
          console.log('Nothing to redo');
          return false;
        }

        this.historyIndex++;
        const nextState = this.history[this.historyIndex + 1];

        this._isHistoryUpdate = true;
        this.setState(nextState, { skipHistory: true, silent: false });
        this._isHistoryUpdate = false;

        console.log(` Redo: advanced to state ${this.historyIndex + 2}/${this.history.length}`);
        return true;
      }

      /**
       * Reset to initial state
       */
      reset() {
        this._state = {
          formId: null,
          formName: 'Untitled Form',
          formType: 'form',
          applicationId: null,
          schema: {},
          components: [],
          selectedComponents: [],
          customFunctions: {},
          variables: [],
          currentEditingFunction: null,
          monacoEditor: null,
          activeTab: 'designer',
          sidebarCollapsed: false,
          previewMode: 'desktop',
          isDirty: false,
          lastSaved: null,
          version: 1,
          history: [],
          historyIndex: -1,
          maxHistory: 50
        };

        this.history = [];
        this.historyIndex = -1;
        this._notifyListeners(['*'], this._state);
      }

      /**
       * Load state from object
       * @param {Object} savedState - Saved state to load
       */
      loadState(savedState) {
        this.setState(savedState, { skipHistory: true, skipDirty: true });
        console.log(' State loaded successfully');
      }

      /**
       * Export current state
       * @returns {Object} - Serializable state object
       */
      exportState() {
        const { history, historyIndex, maxHistory, monacoEditor, ...exportable } = this._state;
        return exportable;
      }

      // Private methods

      _validateUpdates(updates) {
        const validated = {};

        for (const [key, value] of Object.entries(updates)) {
          // Type validation
          if (key === 'components' && !Array.isArray(value)) {
            console.warn(`Invalid type for ${key}: expected Array`);
            continue;
          }

          if (key === 'schema' && typeof value !== 'object') {
            console.warn(`Invalid type for ${key}: expected Object`);
            continue;
          }

          validated[key] = value;
        }

        return validated;
      }

      _saveToHistory() {
        // Remove any states after current index (for branching)
        if (this.historyIndex < this.history.length - 1) {
          this.history = this.history.slice(0, this.historyIndex + 1);
        }

        // Add current state to history
        this.history.push({ ...this._state });
        this.historyIndex++;

        // Limit history size
        if (this.history.length > this._state.maxHistory) {
          this.history.shift();
          this.historyIndex--;
        }
      }

      _notifyListeners(changedKeys, updates) {
        this.listeners.forEach(({ keys, callback }) => {
          const shouldNotify = keys.includes('*') ||
            changedKeys.some(key => keys.includes(key));

          if (shouldNotify) {
            try {
              callback(updates, changedKeys, this._state);
            } catch (error) {
              console.error('State listener error:', error);
            }
          }
        });
      }
    }

    // Global state instance
    const formDesignerState = new FormDesignerState();

    // Backward compatibility: keep window.FORM_DESIGNER_STATE as a proxy
    Object.defineProperty(window, 'FORM_DESIGNER_STATE', {
      get: () => formDesignerState._state,
      set: (newState) => {
        console.warn('Direct state mutation detected. Use formDesignerState.setState() instead.');
        formDesignerState.setState(newState);
      }
    });

    // ============================================================================
    // Global Error Boundary System
    // ============================================================================
    /**
     * ErrorBoundary - Catches and handles unhandled errors gracefully
     *
     * Features:
     * - Global error catching with window.onerror
     * - Unhandled promise rejection handling
     * - User-friendly error recovery UI
     * - Error logging and reporting
     * - Automatic retry mechanisms
     */
    class ErrorBoundary {
      constructor() {
        this.errorCount = 0;
        this.errorLog = [];
        this.maxErrors = 10;
        this.init();
      }

      init() {
        // Catch synchronous errors
        window.onerror = (message, source, lineno, colno, error) => {
          this.handleError(error || new Error(message), {
            source,
            lineno,
            colno,
            type: 'window.onerror'
          });
          return true; // Prevent default error handling
        };

        // Catch unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
          this.handleError(event.reason, {
            type: 'unhandledrejection',
            promise: event.promise
          });
          event.preventDefault();
        });

        console.log(' Error boundary initialized');
      }

      /**
       * Handle error with user-friendly recovery
       * @param {Error} error - The error object
       * @param {Object} context - Error context
       */
      handleError(error, context = {}) {
        this.errorCount++;

        // Log error
        const errorEntry = {
          message: error?.message || String(error),
          stack: error?.stack || '',
          context,
          timestamp: new Date().toISOString(),
          count: this.errorCount
        };

        this.errorLog.push(errorEntry);

        // Limit error log size
        if (this.errorLog.length > this.maxErrors) {
          this.errorLog.shift();
        }

        console.error('Error Boundary caught error:', errorEntry);

        // Determine severity and recovery strategy
        const severity = this._classifyError(error, context);

        if (severity === 'critical') {
          this.showCriticalErrorUI(error, context);
        } else if (severity === 'high') {
          this.showRecoverableErrorUI(error, context);
        } else {
          this.showMinimalErrorNotification(error);
        }

        // Auto-recovery attempt for known issues
        this._attemptAutoRecovery(error, context);
      }

      /**
       * Show critical error UI with reload option
       */
      showCriticalErrorUI(error, context) {
        const errorOverlay = document.createElement('div');
        errorOverlay.className = 'loading-overlay';
        errorOverlay.innerHTML = `
          <div class="loading-content" style="max-width: 600px;">
            <div style="color: #e74c3c; font-size: 3rem; margin-bottom: 1rem;">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 style="color: #333; margin-bottom: 1rem;">Critical Error</h2>
            <p style="color: #666; margin-bottom: 1.5rem;">
              The Form Designer encountered a critical error and needs to reload.
            </p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; text-align: left;">
              <strong>Error:</strong><br>
              <code style="color: #e74c3c; font-size: 0.875rem;">${this._sanitizeErrorMessage(error.message)}</code>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: center;">
              <button class="btn btn-primary" onclick="location.reload()">
                <i class="fas fa-sync"></i> Reload Page
              </button>
              <button class="btn btn-secondary" onclick="this.closest('.loading-overlay').remove()">
                Try to Continue
              </button>
            </div>
            <p style="margin-top: 1rem; font-size: 0.75rem; color: #999;">
              Error #${this.errorCount} at ${new Date().toLocaleTimeString()}
            </p>
          </div>
        `;

        document.body.appendChild(errorOverlay);
      }

      /**
       * Show recoverable error UI with retry option
       */
      showRecoverableErrorUI(error, context) {
        const errorOverlay = document.createElement('div');
        errorOverlay.className = 'loading-overlay';
        errorOverlay.innerHTML = `
          <div class="loading-content" style="max-width: 500px;">
            <div style="color: #f39c12; font-size: 2.5rem; margin-bottom: 1rem;">
              <i class="fas fa-exclamation-circle"></i>
            </div>
            <h3 style="color: #333; margin-bottom: 1rem;">Something Went Wrong</h3>
            <p style="color: #666; margin-bottom: 1.5rem;">
              ${this._getRecoveryMessage(error, context)}
            </p>
            <div style="background: #fff3cd; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; text-align: left; border-left: 4px solid #f39c12;">
              <strong>Error Details:</strong><br>
              <code style="font-size: 0.875rem;">${this._sanitizeErrorMessage(error.message)}</code>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: center;">
              <button class="btn btn-primary" onclick="errorBoundary._retry(this)">
                <i class="fas fa-redo"></i> Retry
              </button>
              <button class="btn btn-secondary" onclick="this.closest('.loading-overlay').remove()">
                Dismiss
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(errorOverlay);

        // Auto-dismiss after 10 seconds
        setTimeout(() => {
          if (errorOverlay.parentNode) {
            errorOverlay.remove();
          }
        }, 10000);
      }

      /**
       * Show minimal error notification
       */
      showMinimalErrorNotification(error) {
        if (typeof showNotification === 'function') {
          showNotification(`Error: ${this._sanitizeErrorMessage(error.message)}`, 'error');
        }
      }

      /**
       * Classify error severity
       */
      _classifyError(error, context) {
        const message = error?.message || '';

        // Critical errors
        if (message.includes('out of memory') ||
            message.includes('Maximum call stack') ||
            this.errorCount > 5) {
          return 'critical';
        }

        // High severity errors
        if (message.includes('network') ||
            message.includes('fetch') ||
            message.includes('timeout') ||
            context.type === 'unhandledrejection') {
          return 'high';
        }

        // Low severity
        return 'low';
      }

      /**
       * Get context-specific recovery message
       */
      _getRecoveryMessage(error, context) {
        const message = error?.message || '';

        if (message.includes('network') || message.includes('fetch')) {
          return 'A network error occurred. Please check your connection and try again.';
        }

        if (message.includes('timeout')) {
          return 'The operation took too long. Please try again.';
        }

        if (context.type === 'unhandledrejection') {
          return 'An asynchronous operation failed. This might be temporary.';
        }

        return 'An unexpected error occurred, but you can continue working.';
      }

      /**
       * Sanitize error message for display
       */
      _sanitizeErrorMessage(message) {
        if (!message) return 'Unknown error';
        // Limit length and remove potentially sensitive data
        return message.substring(0, 200).replace(/\/[^\s]+\//g, '[path]');
      }

      /**
       * Attempt automatic recovery
       */
      _attemptAutoRecovery(error, context) {
        const message = error?.message || '';

        // Auto-retry network errors
        if (message.includes('network') || message.includes('fetch')) {
          console.log('Auto-recovery: Network error detected, will retry in 3s');
          // Could implement auto-retry here
        }

        // Clear localStorage if quota exceeded
        if (message.includes('quota') || message.includes('storage')) {
          console.log('Auto-recovery: Clearing old localStorage data');
          try {
            // Clear old autosave data
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('autosave_') && key !== `autosave_${formDesignerState.getState('formId')}`) {
                localStorage.removeItem(key);
              }
            }
          } catch (e) {
            console.error('Failed to clear storage:', e);
          }
        }
      }

      /**
       * Retry last operation
       */
      _retry(button) {
        button.textContent = 'Retrying...';
        button.disabled = true;

        setTimeout(() => {
          // Close error overlay
          const overlay = button.closest('.loading-overlay');
          if (overlay) {
            overlay.remove();
          }

          // Show success notification
          if (typeof showNotification === 'function') {
            showNotification('Retry successful', 'success');
          }
        }, 1000);
      }

      /**
       * Get error log for debugging
       */
      getErrorLog() {
        return this.errorLog;
      }

      /**
       * Clear error log
       */
      clearErrorLog() {
        this.errorLog = [];
        this.errorCount = 0;
      }
    }

    // Global error boundary instance
    const errorBoundary = new ErrorBoundary();

    // Expose for debugging
    window.errorBoundary = errorBoundary;

    // ============================================================================
    // Loading State Management System
    // ============================================================================
    /**
     * LoadingManager - Manages loading states with overlay, spinners, and progress
     *
     * Features:
     * - Full-screen overlay with message and progress bar
     * - Inline button loading states
     * - Automatic cleanup on hide
     * - Support for progress tracking
     */
    class LoadingManager {
      constructor() {
        this.overlay = null;
        this.activeLoaders = new Set();
        this.init();
      }

      /**
       * Initialize loading overlay in DOM
       */
      init() {
        // Create overlay element
        this.overlay = document.createElement('div');
        this.overlay.className = 'loading-overlay hidden';
        this.overlay.innerHTML = `
          <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
            <div class="loading-subtext"></div>
            <div class="loading-progress">
              <div class="loading-progress-bar"></div>
            </div>
          </div>
        `;
        document.body.appendChild(this.overlay);
      }

      /**
       * Show loading overlay with optional message
       * @param {Object} options - Loading options
       * @param {string} options.message - Main loading message
       * @param {string} options.subtext - Secondary message
       * @param {boolean} options.showProgress - Show progress bar
       * @returns {string} - Unique loader ID
       */
      show(options = {}) {
        const {
          message = 'Loading...',
          subtext = '',
          showProgress = false
        } = options;

        const loaderId = `loader_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        this.activeLoaders.add(loaderId);

        // Update content
        const textEl = this.overlay.querySelector('.loading-text');
        const subtextEl = this.overlay.querySelector('.loading-subtext');
        const progressEl = this.overlay.querySelector('.loading-progress');

        if (textEl) textEl.textContent = message;
        if (subtextEl) subtextEl.textContent = subtext;
        if (progressEl) {
          progressEl.style.display = showProgress ? 'block' : 'none';
        }

        // Show overlay
        this.overlay.classList.remove('hidden');

        return loaderId;
      }

      /**
       * Update progress bar
       * @param {number} percent - Progress percentage (0-100)
       */
      setProgress(percent) {
        const progressBar = this.overlay.querySelector('.loading-progress-bar');
        if (progressBar) {
          progressBar.style.width = `${Math.min(100, Math.max(0, percent))}%`;
        }
      }

      /**
       * Update loading message
       * @param {string} message - New message
       * @param {string} subtext - New subtext
       */
      updateMessage(message, subtext = '') {
        const textEl = this.overlay.querySelector('.loading-text');
        const subtextEl = this.overlay.querySelector('.loading-subtext');

        if (textEl && message) textEl.textContent = message;
        if (subtextEl) subtextEl.textContent = subtext;
      }

      /**
       * Hide loading overlay
       * @param {string} loaderId - Optional specific loader ID to hide
       */
      hide(loaderId = null) {
        if (loaderId) {
          this.activeLoaders.delete(loaderId);
        } else {
          this.activeLoaders.clear();
        }

        // Only hide if no active loaders remain
        if (this.activeLoaders.size === 0) {
          this.overlay.classList.add('hidden');
          this.setProgress(0);
        }
      }

      /**
       * Show button loading state
       * @param {HTMLElement} button - Button element
       */
      showButtonLoading(button) {
        if (!button) return;
        button.classList.add('btn-loading');
        button.disabled = true;
        button.dataset.originalText = button.textContent;
      }

      /**
       * Hide button loading state
       * @param {HTMLElement} button - Button element
       */
      hideButtonLoading(button) {
        if (!button) return;
        button.classList.remove('btn-loading');
        button.disabled = false;
        if (button.dataset.originalText) {
          button.textContent = button.dataset.originalText;
          delete button.dataset.originalText;
        }
      }

      /**
       * Add inline spinner to element
       * @param {HTMLElement} element - Target element
       * @returns {HTMLElement} - Spinner element
       */
      addInlineSpinner(element) {
        if (!element) return null;

        const spinner = document.createElement('span');
        spinner.className = 'inline-spinner';
        element.appendChild(spinner);
        return spinner;
      }

      /**
       * Remove inline spinner
       * @param {HTMLElement} spinner - Spinner element to remove
       */
      removeInlineSpinner(spinner) {
        if (spinner && spinner.parentNode) {
          spinner.parentNode.removeChild(spinner);
        }
      }

      /**
       * Wrap async function with loading state
       * @param {Function} asyncFn - Async function to wrap
       * @param {Object} loadingOptions - Loading options
       * @returns {Function} - Wrapped function
       */
      async wrap(asyncFn, loadingOptions = {}) {
        const loaderId = this.show(loadingOptions);
        try {
          const result = await asyncFn();
          return result;
        } finally {
          this.hide(loaderId);
        }
      }

      /**
       * Execute async function with progress tracking
       * @param {Function} asyncFn - Async function that accepts progress callback
       * @param {Object} loadingOptions - Loading options
       * @returns {*} - Function result
       */
      async withProgress(asyncFn, loadingOptions = {}) {
        const loaderId = this.show({ ...loadingOptions, showProgress: true });

        try {
          const result = await asyncFn((percent, message) => {
            this.setProgress(percent);
            if (message) {
              this.updateMessage(loadingOptions.message || 'Loading...', message);
            }
          });
          return result;
        } finally {
          this.hide(loaderId);
        }
      }
    }

    // Global loading manager instance
    const loadingManager = new LoadingManager();

    // ============================================================================
    // Autosave System with Redis/Socket.IO Support
    // ============================================================================
    /**
     * Autosave manager with Redis (via Socket.IO) primary, CRUD fallback
     * Reduces database writes by storing drafts in Redis
     */
    class AutosaveManager {
      constructor() {
        this.socket = null;
        this.autosaveInterval = null;
        this.lastSaveTime = null;
        this.saveInProgress = false;
        this.useRedis = true; // Try Redis first
        this.config = {
          interval: 5 * 60 * 1000, // 5 minutes default
          debounceDelay: 2000, // 2 seconds debounce for rapid changes
          maxRetries: 3
        };
        this.debounceTimer = null;
        this.pendingSave = false;
      }

      /**
       * Initialize autosave system
       * @param {object} options - Configuration options
       */
      async init(options = {}) {
        // Merge config
        this.config = { ...this.config, ...options };

        // Try to connect to Socket.IO
        try {
          await this.connectSocket();
          console.log(' Autosave: Socket.IO connected, using Redis backend');
        } catch (error) {
          console.warn(' Autosave: Socket.IO unavailable, falling back to CRUD API');
          this.useRedis = false;
        }

        // Start autosave polling
        this.startAutosave();

        // Save on page unload
        window.addEventListener('beforeunload', (e) => {
          if (window.FORM_DESIGNER_STATE.isDirty) {
            this.saveNow();
            // Show confirmation dialog
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
          }
        });

        console.log(` Autosave initialized (interval: ${this.config.interval / 1000}s, Redis: ${this.useRedis})`);
      }

      /**
       * Connect to Socket.IO server
       */
      connectSocket() {
        return new Promise((resolve, reject) => {
          if (typeof io === 'undefined') {
            return reject(new Error('Socket.IO not available'));
          }

          this.socket = io({
            path: '/socket.io',
            transports: ['websocket', 'polling']
          });

          this.socket.on('connect', () => {
            this.useRedis = true;
            resolve();
          });

          this.socket.on('connect_error', (error) => {
            this.useRedis = false;
            reject(error);
          });

          this.socket.on('autosave:saved', (data) => {
            console.log(' Autosave: Saved to Redis', data.timestamp);
            this.lastSaveTime = data.timestamp;
            this.saveInProgress = false;
            this.updateStatusIndicator('saved');
          });

          this.socket.on('autosave:error', (error) => {
            console.error(' Autosave error:', error);
            this.saveInProgress = false;
            this.updateStatusIndicator('error');
          });

          // Timeout after 3 seconds
          setTimeout(() => {
            if (!this.socket.connected) {
              reject(new Error('Socket.IO connection timeout'));
            }
          }, 3000);
        });
      }

      /**
       * Start autosave polling
       */
      startAutosave() {
        // Clear existing interval
        if (this.autosaveInterval) {
          clearInterval(this.autosaveInterval);
        }

        // Set up polling
        this.autosaveInterval = setInterval(() => {
          if (window.FORM_DESIGNER_STATE.isDirty && !this.saveInProgress) {
            this.saveNow();
          }
        }, this.config.interval);
      }

      /**
       * Trigger debounced autosave
       */
      triggerAutosave() {
        // Clear existing debounce timer
        if (this.debounceTimer) {
          clearTimeout(this.debounceTimer);
        }

        // Set up new debounce timer
        this.debounceTimer = setTimeout(() => {
          if (window.FORM_DESIGNER_STATE.isDirty && !this.saveInProgress) {
            this.saveNow();
          }
        }, this.config.debounceDelay);

        this.pendingSave = true;
      }

      /**
       * Save immediately (bypasses debounce)
       */
      async saveNow() {
        if (this.saveInProgress) {
          console.log(' Autosave already in progress, skipping...');
          return;
        }

        this.saveInProgress = true;
        this.updateStatusIndicator('saving');

        const formData = this.collectFormData();

        try {
          if (this.useRedis && this.socket && this.socket.connected) {
            await this.saveToRedis(formData);
          } else {
            await this.saveToCRUD(formData);
          }

          this.lastSaveTime = Date.now();
          this.pendingSave = false;

        } catch (error) {
          console.error(' Autosave failed:', error);
          this.updateStatusIndicator('error');
          this.saveInProgress = false;

          // Retry with CRUD if Redis fails
          if (this.useRedis) {
            console.log(' Retrying with CRUD API...');
            this.useRedis = false;
            setTimeout(() => this.saveNow(), 1000);
          }
        }
      }

      /**
       * Collect all form data for saving
       */
      collectFormData() {
        const state = window.FORM_DESIGNER_STATE;

        return {
          formId: state.formId,
          formName: document.getElementById('formDisplayName')?.value || 'Untitled Form',
          schema: state.schema || {},
          components: state.components || [],
          customFunctions: state.customFunctions || {},
          variables: state.variables || [],
          isDirty: state.isDirty,
          timestamp: Date.now(),
          version: state.version || 1
        };
      }

      /**
       * Save to Redis via Socket.IO
       */
      saveToRedis(formData) {
        return new Promise((resolve, reject) => {
          if (!this.socket || !this.socket.connected) {
            return reject(new Error('Socket not connected'));
          }

          const timeout = setTimeout(() => {
            reject(new Error('Redis save timeout'));
          }, 5000);

          this.socket.emit('autosave:save', formData, (response) => {
            clearTimeout(timeout);

            if (response.success) {
              resolve(response);
            } else {
              reject(new Error(response.error || 'Redis save failed'));
            }
          });
        });
      }

      /**
       * Save to database via CRUD API (fallback)
       */
      async saveToCRUD(formData) {
        const response = await fetch(`/lowcode/api/forms/${formData.formId}/autosave`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          throw new Error(`CRUD save failed: ${response.statusText}`);
        }

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'CRUD save failed');
        }

        console.log(' Autosave: Saved to database (fallback)');
        this.saveInProgress = false;
        this.updateStatusIndicator('saved');

        return result;
      }

      /**
       * Load autosaved data
       */
      async loadAutosave(formId) {
        try {
          if (this.useRedis && this.socket && this.socket.connected) {
            return await this.loadFromRedis(formId);
          } else {
            return await this.loadFromCRUD(formId);
          }
        } catch (error) {
          console.error(' Load autosave failed:', error);
          return null;
        }
      }

      /**
       * Load from Redis via Socket.IO
       */
      loadFromRedis(formId) {
        return new Promise((resolve, reject) => {
          this.socket.emit('autosave:load', { formId }, (response) => {
            if (response.success) {
              resolve(response.data);
            } else {
              reject(new Error(response.error || 'Redis load failed'));
            }
          });
        });
      }

      /**
       * Load from database via CRUD API
       */
      async loadFromCRUD(formId) {
        const response = await fetch(`/lowcode/api/forms/${formId}/autosave`);

        if (!response.ok) {
          throw new Error(`CRUD load failed: ${response.statusText}`);
        }

        const result = await response.json();
        return result.success ? result.data : null;
      }

      /**
       * Update autosave status indicator in UI
       */
      updateStatusIndicator(status) {
        let indicator = document.getElementById('autosaveIndicator');

        if (!indicator) {
          // Create indicator if it doesn't exist
          indicator = document.createElement('div');
          indicator.id = 'autosaveIndicator';
          indicator.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 10000;
            transition: opacity 0.3s;
          `;
          document.body.appendChild(indicator);
        }

        const icons = {
          saving: '<i class="fas fa-spinner fa-spin"></i>',
          saved: '<i class="fas fa-check-circle"></i>',
          error: '<i class="fas fa-exclamation-triangle"></i>'
        };

        const styles = {
          saving: 'background: #3498db; color: white;',
          saved: 'background: #27ae60; color: white;',
          error: 'background: #e74c3c; color: white;'
        };

        const messages = {
          saving: 'Saving...',
          saved: `Saved ${this.formatTimestamp()}`,
          error: 'Save failed'
        };

        indicator.innerHTML = icons[status] + ' ' + messages[status];
        indicator.style.cssText += styles[status];
        indicator.style.opacity = '1';

        // Auto-hide after 3 seconds for saved/error states
        if (status !== 'saving') {
          setTimeout(() => {
            indicator.style.opacity = '0';
          }, 3000);
        }
      }

      /**
       * Format timestamp for display
       */
      formatTimestamp() {
        if (!this.lastSaveTime) return 'just now';

        const seconds = Math.floor((Date.now() - this.lastSaveTime) / 1000);

        if (seconds < 60) return 'just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        return `${Math.floor(seconds / 3600)}h ago`;
      }

      /**
       * Update autosave interval
       */
      setInterval(minutes) {
        this.config.interval = minutes * 60 * 1000;
        this.startAutosave();
        console.log(` Autosave interval updated: ${minutes} minutes`);
      }

      /**
       * Stop autosave
       */
      stop() {
        if (this.autosaveInterval) {
          clearInterval(this.autosaveInterval);
        }
        if (this.debounceTimer) {
          clearTimeout(this.debounceTimer);
        }
        if (this.socket) {
          this.socket.disconnect();
        }
      }
    }

    // Global autosave manager instance
    const autosaveManager = new AutosaveManager();

    // ============================================================================
    // Safe Code Execution Sandbox
    // ============================================================================
    /**
     * Executes user code in a sandboxed iframe with timeout protection
     * @param {string} code - The JavaScript code to execute
     * @param {object} params - Parameters to pass to the function
     * @param {string} functionName - Name of the function to call
     * @param {number} timeout - Maximum execution time in ms (default 5000)
     * @returns {Promise<any>} - Result of the function execution
     */
    function executeSandboxedCode(code, params, functionName, timeout = 5000) {
      return new Promise((resolve, reject) => {
        // Create isolated iframe sandbox
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.sandbox = 'allow-scripts'; // Minimal permissions
        document.body.appendChild(iframe);

        // Set up timeout protection
        const timeoutId = setTimeout(() => {
          document.body.removeChild(iframe);
          reject(new Error(`Execution timeout after ${timeout}ms`));
        }, timeout);

        try {
          const iframeWindow = iframe.contentWindow;

          // Whitelist of safe globals
          const safeGlobals = {
            console: {
              log: (...args) => console.log('[Sandbox]', ...args),
              error: (...args) => console.error('[Sandbox]', ...args),
              warn: (...args) => console.warn('[Sandbox]', ...args)
            },
            Math: Math,
            JSON: JSON,
            Date: Date,
            Array: Array,
            Object: Object,
            String: String,
            Number: Number,
            Boolean: Boolean
          };

          // Execute code in iframe context
          const wrappedCode = `
            (function() {
              'use strict';
              ${Object.keys(safeGlobals).map(key => `const ${key} = parent.safeGlobals.${key};`).join('\n')}

              ${code}

              try {
                const result = ${functionName}(...Object.values(parent.params));
                parent.postMessage({ success: true, result: result }, '*');
              } catch (error) {
                parent.postMessage({ success: false, error: error.message, stack: error.stack }, '*');
              }
            })();
          `;

          // Attach safe globals to iframe parent reference
          iframeWindow.parent.safeGlobals = safeGlobals;
          iframeWindow.parent.params = params;

          // Listen for result
          const messageHandler = (event) => {
            clearTimeout(timeoutId);
            window.removeEventListener('message', messageHandler);
            document.body.removeChild(iframe);

            if (event.data.success) {
              resolve(event.data.result);
            } else {
              const error = new Error(event.data.error);
              error.stack = event.data.stack;
              reject(error);
            }
          };

          window.addEventListener('message', messageHandler);

          // Execute the code
          const script = iframeWindow.document.createElement('script');
          script.textContent = wrappedCode;
          iframeWindow.document.body.appendChild(script);

        } catch (error) {
          clearTimeout(timeoutId);
          document.body.removeChild(iframe);
          reject(error);
        }
      });
    }

    // Monaco Editor instance
    let monacoEditor = null;
    let currentEditingFunction = null;

    /**
     * Initialize Monaco Editor for the function editor
     */
    function initializeMonacoEditor() {
      require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });

      require(['vs/editor/editor.main'], function() {
        monacoEditor = monaco.editor.create(document.getElementById('functionEditor'), {
          value: '// Select a function to edit or create a new one\n',
          language: 'javascript',
          theme: 'vs-dark',
          automaticLayout: true,
          fontSize: 14,
          minimap: { enabled: true },
          scrollBeyondLastLine: false,
          lineNumbers: 'on',
          renderLineHighlight: 'all',
          bracketPairColorization: { enabled: true },
          formatOnPaste: true,
          formatOnType: true,
          suggestOnTriggerCharacters: true,
          quickSuggestions: true,
          wordBasedSuggestions: true,
          snippetSuggestions: 'inline',
          tabCompletion: 'on',
          parameterHints: { enabled: true },
          autoClosingBrackets: 'always',
          autoClosingQuotes: 'always',
          folding: true,
          foldingStrategy: 'indentation'
        });

        // Add extra type definitions for better IntelliSense
        monaco.languages.typescript.javascriptDefaults.setDiagnosticsOptions({
          noSemanticValidation: false,
          noSyntaxValidation: false
        });

        monaco.languages.typescript.javascriptDefaults.setCompilerOptions({
          target: monaco.languages.typescript.ScriptTarget.ES2020,
          allowNonTsExtensions: true,
          moduleResolution: monaco.languages.typescript.ModuleResolutionKind.NodeJs,
          module: monaco.languages.typescript.ModuleKind.CommonJS,
          noEmit: true,
          esModuleInterop: true,
          allowJs: true,
          checkJs: false
        });

        console.log('Monaco Editor initialized successfully');
      });
    }

    /**
     * Format code in Monaco Editor
     */
    function formatMonacoCode() {
      if (monacoEditor) {
        monacoEditor.getAction('editor.action.formatDocument').run();
      }
    }

    /**
     * Get code from Monaco Editor
     */
    function getMonacoCode() {
      return monacoEditor ? monacoEditor.getValue() : '';
    }

    /**
     * Set code in Monaco Editor
     */
    function setMonacoCode(code) {
      if (monacoEditor) {
        monacoEditor.setValue(code);
      }
    }

    /**
     * Generate proper JavaScript function code with JSDoc
     */
    function generateFunctionCode(funcName, params, returnType, isAsync, description) {
      const paramsList = params || [];
      const funcParams = paramsList.map(p => p.name).join(', ');

      // Generate JSDoc
      let jsdoc = '/**\n';
      if (description) {
        jsdoc += ` * ${description}\n`;
        jsdoc += ' *\n';
      }

      // Add parameter documentation
      paramsList.forEach(param => {
        const required = param.required ? '' : ' (optional)';
        jsdoc += ` * @param {${param.type}} ${param.name}${required}\n`;
      });

      // Add return type documentation
      if (returnType && returnType !== 'void') {
        jsdoc += ` * @returns {${returnType}}\n`;
      }

      jsdoc += ' */\n';

      // Generate function signature
      const asyncKeyword = isAsync ? 'async ' : '';
      let funcBody = `${asyncKeyword}function ${funcName}(${funcParams}) {\n`;
      funcBody += '  // TODO: Implement function logic\n';

      // Add sample return statement based on type
      if (returnType && returnType !== 'void') {
        const sampleReturn = getSampleReturnValue(returnType);
        funcBody += `  \n  return ${sampleReturn};\n`;
      }

      funcBody += '}';

      return jsdoc + funcBody;
    }

    /**
     * Get sample return value based on type
     */
    function getSampleReturnValue(type) {
      const samples = {
        'string': '""',
        'number': '0',
        'boolean': 'false',
        'object': '{}',
        'array': '[]',
        'function': 'function() {}',
        'date': 'new Date()',
        'regexp': '/pattern/',
        'promise': 'Promise.resolve()',
        'map': 'new Map()',
        'set': 'new Set()',
        'symbol': 'Symbol()',
        'bigint': '0n',
        'any': 'null'
      };
      return samples[type.toLowerCase()] || 'null';
    }

    /**
     * Setup collapsible sidebar functionality
     * Allows users to collapse/expand form selector and properties panels
     */
    function setupCollapsibleSidebars() {
      const formSelectorPanel = document.getElementById('formSelectorPanel');
      const propertiesPanel = document.getElementById('propertiesPanel');
      const formSelectorToggle = document.getElementById('formSelectorToggle');
      const propertiesToggle = document.getElementById('propertiesToggle');

      if (!formSelectorPanel || !propertiesPanel || !formSelectorToggle || !propertiesToggle) {
        console.warn('Collapsible sidebar elements not found');
        return;
      }

      // Restore saved state from localStorage
      const formSelectorCollapsed = localStorage.getItem('formSelectorCollapsed') === 'true';
      const propertiesCollapsed = localStorage.getItem('propertiesCollapsed') === 'true';

      if (formSelectorCollapsed) {
        formSelectorPanel.classList.add('collapsed');
        formSelectorToggle.querySelector('i').className = 'fas fa-chevron-right';
      }

      if (propertiesCollapsed) {
        propertiesPanel.classList.add('collapsed');
        propertiesToggle.querySelector('i').className = 'fas fa-chevron-left';
      }

      // Form Selector toggle (with managed cleanup)
      eventManager.on(formSelectorToggle, 'click', () => {
        const isCollapsed = formSelectorPanel.classList.toggle('collapsed');
        const icon = isCollapsed ? 'fa-chevron-right' : 'fa-chevron-left';
        formSelectorToggle.querySelector('i').className = `fas ${icon}`;
        localStorage.setItem('formSelectorCollapsed', isCollapsed);
        formSelectorToggle.title = isCollapsed ? 'Expand Form Selector' : 'Collapse Form Selector';
      }, 'ui');

      // Properties toggle (with managed cleanup)
      eventManager.on(propertiesToggle, 'click', () => {
        const isCollapsed = propertiesPanel.classList.toggle('collapsed');
        const icon = isCollapsed ? 'fa-chevron-left' : 'fa-chevron-right';
        propertiesToggle.querySelector('i').className = `fas ${icon}`;
        localStorage.setItem('propertiesCollapsed', isCollapsed);
        propertiesToggle.title = isCollapsed ? 'Expand Properties Panel' : 'Collapse Properties Panel';
      }, 'ui');

      console.log('Collapsible sidebars initialized');
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupCollapsibleSidebars);
    } else {
      setupCollapsibleSidebars();
    }

    // Double-click to edit form title with validation
    function setupFormTitleEdit() {
      const formNameInput = document.getElementById('formDisplayName');
      if (!formNameInput) return;

      // Store original value
      let originalValue = formNameInput.value;

      // Double-click to enable editing
      eventManager.on(formNameInput, 'dblclick', () => {
        originalValue = formNameInput.value;
        formNameInput.removeAttribute('readonly');
        formNameInput.focus();
        formNameInput.select();
        InputValidator.clearError(formNameInput);
      }, 'forms');

      // Real-time validation on input
      eventManager.on(formNameInput, 'input', () => {
        const validation = InputValidator.validateFormName(formNameInput.value);
        if (!validation.valid) {
          InputValidator.showError(formNameInput, validation.error);
        } else {
          InputValidator.clearError(formNameInput);
        }
      }, 'forms');

      // Blur to save and make readonly again
      eventManager.on(formNameInput, 'blur', () => {
        const validation = InputValidator.validateFormName(formNameInput.value);

        if (!validation.valid) {
          // Revert to original value on invalid input
          formNameInput.value = originalValue;
          InputValidator.clearError(formNameInput);
          showNotification('Form name validation failed: ' + validation.error, 'error');
        } else {
          // Save the sanitized value
          formNameInput.value = validation.sanitized;

          // Mark form as dirty if value changed
          if (validation.sanitized !== originalValue) {
            window.FORM_DESIGNER_STATE.isDirty = true;
          }
        }

        formNameInput.setAttribute('readonly', '');
      }, 'forms');

      // Enter key to save
      eventManager.on(formNameInput, 'keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          formNameInput.blur();
        }

        // Escape to cancel
        if (e.key === 'Escape') {
          e.preventDefault();
          formNameInput.value = originalValue;
          InputValidator.clearError(formNameInput);
          formNameInput.blur();
        }
      }, 'forms');
    }

    // Initialize form title editing
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupFormTitleEdit);
    } else {
      setupFormTitleEdit();
    }

    // Form Selector Panel Management
    let allForms = [];
    let folders = [
      { id: 'root', name: 'All Forms', parentId: null, expanded: true },
      { id: 'recent', name: 'Recent', parentId: null, expanded: false },
      { id: 'favorites', name: 'Favorites', parentId: null, expanded: false }
    ];
    let selectedItem = null;
    const currentFormId = '<%= formId || "" %>';

    async function loadFormsList() {
      try {
        const appId = new URLSearchParams(window.location.search).get('appId');
        if (!appId) {
          console.warn('No appId provided, skipping forms list load');
          return;
        }

        const response = await fetch(`/lowcode/api/forms?applicationId=${appId}`);
        const result = await response.json();

        if (result.success) {
          // API returns data.forms array
          allForms = result.data?.forms || result.data || [];
          console.log('Loaded forms:', allForms.length);
          renderFolderTree();
        } else {
          console.error('Failed to load forms:', result.error);
          showFormsError('Failed to load forms');
        }
      } catch (error) {
        console.error('Error loading forms:', error);
        showFormsError('Error loading forms');
      }
    }

    function renderFolderTree() {
      const container = document.getElementById('folderTree');
      if (!container) return;

      if (!allForms || allForms.length === 0) {
        safeSetHTML(container, `
          <div class="form-selector-empty">
            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
            <p>No forms found</p>
          </div>
        `);
        return;
      }

      container.innerHTML = '';

      // Render each root folder
      folders.filter(f => f.parentId === null).forEach(folder => {
        const folderEl = createFolderElement(folder);
        container.appendChild(folderEl);
      });
    }

    function createFolderElement(folder) {
      const folderDiv = document.createElement('div');
      folderDiv.className = 'folder-item';
      folderDiv.dataset.folderId = folder.id;

      // Get forms in this folder
      let formsInFolder = allForms.filter(f => {
        if (folder.id === 'root') return !f.folderId || f.folderId === 'root';
        if (folder.id === 'recent') return false; // TODO: implement recent logic
        if (folder.id === 'favorites') return false; // TODO: implement favorites logic
        return f.folderId === folder.id;
      });

      // Folder header
      const headerDiv = document.createElement('div');
      headerDiv.className = 'folder-header';
      safeSetHTML(headerDiv, `
        <div class="folder-toggle ${folder.expanded ? 'expanded' : ''}">
          <i class="fas fa-chevron-right"></i>
        </div>
        <i class="fas fa-folder${folder.expanded ? '-open' : ''} folder-icon"></i>
        <span class="folder-name">${folder.name}</span>
        <span class="folder-count">${formsInFolder.length}</span>
      `);

      headerDiv.addEventListener('click', () => toggleFolder(folder.id));
      folderDiv.appendChild(headerDiv);

      // Folder children
      const childrenDiv = document.createElement('div');
      childrenDiv.className = `folder-children ${folder.expanded ? 'expanded' : ''}`;

      // Sort and add forms
      formsInFolder.sort((a, b) =>
        (a.displayName || a.name || '').localeCompare(b.displayName || b.name || '')
      ).forEach(form => {
        const formEl = createFormElement(form);
        childrenDiv.appendChild(formEl);
      });

      folderDiv.appendChild(childrenDiv);
      return folderDiv;
    }

    function createFormElement(form) {
      const formDiv = document.createElement('div');
      formDiv.className = `form-selector-item ${form.id === currentFormId ? 'active' : ''}`;
      formDiv.dataset.formId = form.id;
      formDiv.title = form.displayName || form.name || 'Untitled Form';
      safeSetHTML(formDiv, `
        <i class="fas fa-wpforms"></i>
        <span class="form-name">${form.displayName || form.name || 'Untitled Form'}</span>
      `);
      formDiv.addEventListener('click', (e) => {
        e.stopPropagation();
        navigateToForm(form.id);
      });
      return formDiv;
    }

    function toggleFolder(folderId) {
      const folder = folders.find(f => f.id === folderId);
      if (!folder) return;

      folder.expanded = !folder.expanded;
      renderFolderTree();
    }

    function showFormsError(message) {
      const container = document.getElementById('formSelectorContent');
      if (!container) return;

      safeSetHTML(container, `
        <div class="form-selector-empty">
          <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 0.5rem; color: #e74c3c;"></i>
          <p>${message}</p>
        </div>
      `);
    }

    function navigateToForm(formId) {
      const appId = new URLSearchParams(window.location.search).get('appId');
      window.location.href = `/lowcode/forms/${formId}/designer?appId=${appId}`;
    }

    function setupFormSelector() {
      // Toggle form selector panel
      const formSelectorToggle = document.getElementById('formSelectorToggle');
      const formSelectorPanel = document.getElementById('formSelectorPanel');

      if (formSelectorToggle && formSelectorPanel) {
        formSelectorToggle.addEventListener('click', () => {
          formSelectorPanel.classList.toggle('collapsed');
          const icon = formSelectorToggle.querySelector('i');
          if (formSelectorPanel.classList.contains('collapsed')) {
            icon.classList.remove('fa-chevron-left');
            icon.classList.add('fa-chevron-right');
          } else {
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-left');
          }
        });
      }

      // Toolbar buttons
      document.getElementById('addFormBtn')?.addEventListener('click', () => {
        const appId = new URLSearchParams(window.location.search).get('appId');
        window.location.href = `/lowcode/forms/new?appId=${appId}`;
      });

      document.getElementById('addFolderBtn')?.addEventListener('click', () => {
        const folderName = prompt('Enter folder name:');
        if (folderName && folderName.trim()) {
          folders.push({
            id: 'folder_' + Date.now(),
            name: folderName.trim(),
            parentId: null,
            expanded: true
          });
          renderFolderTree();
        }
      });

      document.getElementById('removeFormBtn')?.addEventListener('click', () => {
        if (selectedItem && confirm('Are you sure you want to delete this item?')) {
          // TODO: implement delete functionality
          alert('Delete functionality coming soon!');
        } else {
          alert('Please select a form or folder to delete');
        }
      });

      document.getElementById('refreshFormsBtn')?.addEventListener('click', () => {
        loadFormsList();
      });

      // Search functionality
      const searchInput = document.getElementById('formSelectorSearch');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase().trim();
          if (searchTerm === '') {
            renderFolderTree();
          } else {
            // Filter and show matching forms
            const filtered = allForms.filter(form => {
              const name = (form.displayName || form.name || '').toLowerCase();
              return name.includes(searchTerm);
            });
            // Show results in flat list
            const container = document.getElementById('folderTree');
            if (container) {
              if (filtered.length === 0) {
                safeSetHTML(container, `
                  <div class="form-selector-empty">
                    <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                    <p>No forms found</p>
                  </div>
                `);
              } else {
                container.innerHTML = '';
                filtered.forEach(form => {
                  container.appendChild(createFormElement(form));
                });
              }
            }
          }
        });
      }

      // Filter dropdown
      const filterSelect = document.getElementById('formSelectorFilter');
      if (filterSelect) {
        filterSelect.addEventListener('change', (e) => {
          // TODO: implement filtering logic
          renderFolderTree();
        });
      }

      // Load forms list
      loadFormsList();
    }

    // Initialize form selector
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupFormSelector);
    } else {
      setupFormSelector();
    }

    /**
     * ============================================================
     * WYSIWYG FORM DESIGNER FEATURES
     * ============================================================
     */

    // State management for WYSIWYG features
    const canvasState = {
      gridVisible: false,
      rulersVisible: true,
      snapToGrid: 24,
      zoom: 100,
      previewMode: 'desktop',
      selectedComponents: [],
      draggedComponent: null,
      resizingComponent: null
    };

    /**
     * Initialize Component Library
     */
    function initComponentLibrary() {
      // Toggle component library panel
      const libraryToggle = document.getElementById('componentLibraryToggle');
      const libraryPanel = document.getElementById('componentLibraryPanel');

      if (libraryToggle && libraryPanel) {
        libraryToggle.addEventListener('click', () => {
          libraryPanel.classList.toggle('collapsed');
          const icon = libraryToggle.querySelector('i');
          if (libraryPanel.classList.contains('collapsed')) {
            icon.classList.remove('fa-chevron-left');
            icon.classList.add('fa-chevron-right');
          } else {
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-left');
          }
        });
      }

      // Category collapse/expand
      const categoryHeaders = document.querySelectorAll('.category-header');
      categoryHeaders.forEach(header => {
        header.addEventListener('click', () => {
          const toggle = header.querySelector('.category-toggle');
          const components = header.nextElementSibling;

          if (toggle && components) {
            toggle.classList.toggle('expanded');
            components.classList.toggle('collapsed');
          }
        });
      });

      // Setup drag and drop for library items
      enableDragDrop();
    }

    /**
     * Enable Drag and Drop functionality
     */
    function enableDragDrop() {
      const libraryItems = document.querySelectorAll('.component-library-item');
      const formSections = ['formHeaderSection', 'formBodySection', 'formFooterSection'];

      // Drag start from library
      libraryItems.forEach(item => {
        item.addEventListener('dragstart', (e) => {
          const componentType = item.dataset.component;
          e.dataTransfer.setData('componentType', componentType);
          e.dataTransfer.effectAllowed = 'copy';
          item.style.opacity = '0.5';
        });

        item.addEventListener('dragend', (e) => {
          item.style.opacity = '1';
        });
      });

      // Enable drop zones
      formSections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (!section) return;

        section.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
          section.style.background = 'rgba(0, 120, 212, 0.05)';
        });

        section.addEventListener('dragleave', (e) => {
          section.style.background = '';
        });

        section.addEventListener('drop', (e) => {
          e.preventDefault();
          section.style.background = '';

          const componentType = e.dataTransfer.getData('componentType');
          if (componentType) {
            addToCanvas(componentType, section);
          }
        });
      });
    }

    /**
     * Add component to canvas
     */
    function addToCanvas(componentType, targetSection) {
      const component = document.createElement('div');
      component.className = 'form-component';
      component.dataset.componentType = componentType;
      safeSetHTML(component, renderComponent(componentType));

      // Add component type badge
      const badge = document.createElement('div');
      badge.className = 'component-type-badge';
      badge.textContent = componentType.toUpperCase();
      component.appendChild(badge);

      // Add resize handles
      addResizeHandles(component);

      // Add component controls
      const controls = document.createElement('div');
      controls.className = 'component-controls';
      safeSetHTML(controls, `
        <button class="control-btn" onclick="deleteComponent(this)" title="Delete">
          <i class="fas fa-trash"></i>
        </button>
        <button class="control-btn" onclick="duplicateComponent(this)" title="Duplicate">
          <i class="fas fa-copy"></i>
        </button>
      `);
      component.appendChild(controls);

      // Make component selectable
      component.addEventListener('click', (e) => {
        e.stopPropagation();
        selectComponent(component);
      });

      // Double-click to edit text
      component.addEventListener('dblclick', (e) => {
        const textEl = component.querySelector('[contenteditable]');
        if (textEl) {
          textEl.focus();
        }
      });

      targetSection.appendChild(component);

      // Remove empty state
      const canvas = document.getElementById('formCanvas');
      if (canvas) {
        canvas.classList.remove('empty');
      }
    }

    /**
     * Render component HTML based on type
     */
    function renderComponent(type) {
      const components = {
        container: '<div style="border: 2px dashed #ccc; padding: 1rem; min-height: 100px;">Container</div>',
        grid: '<div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; min-height: 100px; border: 2px dashed #ccc; padding: 1rem;">12-Column Grid</div>',
        row: '<div style="display: flex; gap: 1rem; padding: 0.5rem; background: #f8f9fa;">Row</div>',
        column: '<div style="padding: 1rem; background: #e9ecef; min-height: 80px;">Column</div>',
        card: '<div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem;"><h5>Card Title</h5><p>Card content</p></div>',
        panel: '<div style="border: 1px solid #ccc; padding: 1rem;"><div style="background: #f8f9fa; padding: 0.5rem; margin: -1rem -1rem 1rem; font-weight: bold;">Panel Header</div>Panel content</div>',
        tabs: '<div><div style="display: flex; gap: 0.5rem; border-bottom: 2px solid #dee2e6; margin-bottom: 1rem;"><div style="padding: 0.5rem 1rem; background: #0078d4; color: white; border-radius: 4px 4px 0 0;">Tab 1</div><div style="padding: 0.5rem 1rem; background: #f8f9fa; border-radius: 4px 4px 0 0;">Tab 2</div></div><div>Tab content</div></div>',
        accordion: '<div style="border: 1px solid #dee2e6; border-radius: 4px;"><div style="padding: 0.75rem; background: #f8f9fa; cursor: pointer;">Accordion Item <i class="fas fa-chevron-down" style="float: right;"></i></div></div>',
        text: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Text Input</label><input type="text" class="form-control" placeholder="Enter text..." /></div>',
        number: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Number Input</label><input type="number" class="form-control" placeholder="0" /></div>',
        email: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label><input type="email" class="form-control" placeholder="email@example.com" /></div>',
        password: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Password</label><input type="password" class="form-control" placeholder="" /></div>',
        textarea: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Text Area</label><textarea class="form-control" rows="4" placeholder="Enter text..."></textarea></div>',
        richtext: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Rich Text Editor</label><div style="border: 1px solid #ced4da; border-radius: 4px; padding: 0.5rem; min-height: 100px;" contenteditable="true">Type here...</div></div>',
        date: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Date Picker</label><input type="date" class="form-control" /></div>',
        time: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Time Picker</label><input type="time" class="form-control" /></div>',
        color: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Color Picker</label><input type="color" class="form-control" style="height: 40px;" /></div>',
        file: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">File Upload</label><input type="file" class="form-control" /></div>',
        checkbox: '<div class="form-check"><input type="checkbox" class="form-check-input" id="check1" /><label class="form-check-label" for="check1">Checkbox Option</label></div>',
        radio: '<div class="form-check"><input type="radio" class="form-check-input" name="radio1" id="radio1" /><label class="form-check-label" for="radio1">Radio Option</label></div>',
        switch: '<div class="form-check form-switch"><input type="checkbox" class="form-check-input" id="switch1" /><label class="form-check-label" for="switch1">Switch</label></div>',
        select: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Select</label><select class="form-select"><option>Option 1</option><option>Option 2</option><option>Option 3</option></select></div>',
        multiselect: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Multi-Select</label><select class="form-select" multiple size="3"><option>Option 1</option><option>Option 2</option><option>Option 3</option></select></div>',
        label: '<label style="font-weight: 500;" contenteditable="true">Label Text</label>',
        heading: '<h2 contenteditable="true">Heading Text</h2>',
        paragraph: '<p contenteditable="true">This is a paragraph. Double-click to edit.</p>',
        divider: '<hr style="border-top: 2px solid #dee2e6; margin: 1rem 0;" />',
        spacer: '<div style="height: 40px; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px);"></div>',
        image: '<img src="https://via.placeholder.com/400x200" style="max-width: 100%; height: auto; border-radius: 4px;" />',
        icon: '<i class="fas fa-star" style="font-size: 2rem; color: #0078d4;"></i>',
        badge: '<span class="badge bg-primary" contenteditable="true">Badge</span>',
        alert: '<div class="alert alert-info" role="alert" contenteditable="true">This is an alert message</div>',
        progress: '<div><label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Progress</label><div class="progress"><div class="progress-bar" style="width: 60%">60%</div></div></div>',
        button: '<button class="btn btn-primary" contenteditable="true">Button</button>',
        buttongroup: '<div class="btn-group" role="group"><button class="btn btn-outline-primary">Left</button><button class="btn btn-outline-primary">Middle</button><button class="btn btn-outline-primary">Right</button></div>',
        link: '<a href="#" class="btn btn-link" contenteditable="true">Link Text</a>',
        dropdown: '<div class="dropdown"><button class="btn btn-secondary dropdown-toggle">Dropdown</button></div>',
        table: '<table class="table table-bordered"><thead><tr><th>Column 1</th><th>Column 2</th></tr></thead><tbody><tr><td>Data 1</td><td>Data 2</td></tr></tbody></table>',
        list: '<ul class="list-group"><li class="list-group-item">List Item 1</li><li class="list-group-item">List Item 2</li></ul>',
        datagrid: '<div style="border: 1px solid #dee2e6; border-radius: 4px; padding: 1rem; background: #f8f9fa;"><i class="fas fa-th-large"></i> Data Grid Component</div>',
        chart: '<div style="border: 1px solid #dee2e6; border-radius: 4px; padding: 3rem; text-align: center; background: #f8f9fa;"><i class="fas fa-chart-bar" style="font-size: 3rem; color: #0078d4;"></i><p style="margin-top: 1rem;">Chart Component</p></div>',
        calendar: '<div style="border: 1px solid #dee2e6; border-radius: 4px; padding: 2rem; text-align: center; background: #f8f9fa;"><i class="fas fa-calendar-alt" style="font-size: 3rem; color: #0078d4;"></i><p style="margin-top: 1rem;">Calendar Component</p></div>'
      };

      return components[type] || '<div>Unknown Component</div>';
    }

    /**
     * Add resize handles to component
     */
    function addResizeHandles(component) {
      const handles = ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'];
      handles.forEach(position => {
        const handle = document.createElement('div');
        handle.className = `resize-handle ${position}`;
        handle.addEventListener('mousedown', (e) => startResize(e, component, position));
        component.appendChild(handle);
      });
    }

    /**
     * Start resizing component
     */
    function startResize(e, component, position) {
      e.preventDefault();
      e.stopPropagation();

      canvasState.resizingComponent = { element: component, position, startX: e.clientX, startY: e.clientY };

      document.addEventListener('mousemove', handleResize);
      document.addEventListener('mouseup', stopResize);
    }

    /**
     * Handle component resize
     */
    function handleResize(e) {
      if (!canvasState.resizingComponent) return;

      const { element, position, startX, startY } = canvasState.resizingComponent;
      const deltaX = e.clientX - startX;
      const deltaY = e.clientY - startY;

      // Apply resize based on handle position
      const currentWidth = element.offsetWidth;
      const currentHeight = element.offsetHeight;

      if (position.includes('e')) {
        element.style.width = `${currentWidth + deltaX}px`;
      }
      if (position.includes('s')) {
        element.style.minHeight = `${currentHeight + deltaY}px`;
      }

      canvasState.resizingComponent.startX = e.clientX;
      canvasState.resizingComponent.startY = e.clientY;
    }

    /**
     * Stop resizing
     */
    function stopResize() {
      canvasState.resizingComponent = null;
      document.removeEventListener('mousemove', handleResize);
      document.removeEventListener('mouseup', stopResize);
    }

    /**
     * Select component for editing
     */
    function selectComponent(element) {
      // Clear previous selection
      document.querySelectorAll('.form-component.selected').forEach(el => {
        el.classList.remove('selected');
      });

      // Select new component
      element.classList.add('selected');
      canvasState.selectedComponents = [element];
    }

    /**
     * Delete component
     */
    window.deleteComponent = function(buttonElement) {
      const component = buttonElement.closest('.form-component');
      if (component && confirm('Delete this component?')) {
        component.remove();
      }
    };

    /**
     * Duplicate component
     */
    window.duplicateComponent = function(buttonElement) {
      const component = buttonElement.closest('.form-component');
      if (component) {
        const clone = component.cloneNode(true);
        component.parentNode.insertBefore(clone, component.nextSibling);
      }
    };

    /**
     * Toggle Grid Overlay
     */
    function toggleGrid() {
      canvasState.gridVisible = !canvasState.gridVisible;
      const gridOverlay = document.getElementById('gridOverlay');
      const btn = document.getElementById('toggleGridBtn');

      if (gridOverlay) {
        gridOverlay.classList.toggle('visible', canvasState.gridVisible);
      }
      if (btn) {
        btn.classList.toggle('active', canvasState.gridVisible);
      }
    }

    /**
     * Toggle Rulers
     */
    function toggleRulers() {
      canvasState.rulersVisible = !canvasState.rulersVisible;
      const horizontal = document.getElementById('rulerHorizontal');
      const vertical = document.getElementById('rulerVertical');
      const corner = document.getElementById('rulerCorner');
      const wrapper = document.getElementById('canvasWrapper');
      const btn = document.getElementById('toggleRulersBtn');

      [horizontal, vertical, corner].forEach(el => {
        if (el) el.classList.toggle('hidden', !canvasState.rulersVisible);
      });

      if (wrapper) {
        wrapper.classList.toggle('no-rulers', !canvasState.rulersVisible);
      }

      if (btn) {
        btn.classList.toggle('active', canvasState.rulersVisible);
      }

      if (canvasState.rulersVisible) {
        drawRulers();
      }
    }

    /**
     * Draw ruler markings
     */
    function drawRulers() {
      const horizontal = document.getElementById('rulerHorizontal');
      const vertical = document.getElementById('rulerVertical');

      if (!horizontal || !vertical) return;

      // Clear existing marks
      horizontal.innerHTML = '';
      vertical.innerHTML = '';

      // Draw horizontal ruler (0-1200px)
      for (let i = 0; i <= 1200; i += 50) {
        const tick = document.createElement('div');
        tick.className = 'ruler-tick';
        tick.style.left = `${i}px`;
        horizontal.appendChild(tick);

        if (i % 100 === 0) {
          const mark = document.createElement('div');
          mark.className = 'ruler-mark';
          mark.style.left = `${i + 2}px`;
          mark.style.top = '2px';
          mark.textContent = i;
          horizontal.appendChild(mark);
        }
      }

      // Draw vertical ruler
      for (let i = 0; i <= 2000; i += 50) {
        const tick = document.createElement('div');
        tick.className = 'ruler-tick';
        tick.style.top = `${i}px`;
        vertical.appendChild(tick);

        if (i % 100 === 0) {
          const mark = document.createElement('div');
          mark.className = 'ruler-mark';
          mark.style.top = `${i + 2}px`;
          mark.style.left = '2px';
          mark.textContent = i;
          vertical.appendChild(mark);
        }
      }
    }

    /**
     * Set Zoom Level
     */
    function setZoom(percentage) {
      canvasState.zoom = percentage;
      const canvas = document.getElementById('formCanvas');

      if (canvas) {
        // Remove all zoom classes
        canvas.classList.remove('zoom-50', 'zoom-75', 'zoom-100', 'zoom-125', 'zoom-150', 'zoom-200');
        // Add new zoom class
        canvas.classList.add(`zoom-${percentage}`);
      }
    }

    /**
     * Set Preview Mode (Desktop/Tablet/Mobile)
     */
    function setPreviewMode(mode) {
      canvasState.previewMode = mode;
      const canvas = document.getElementById('formCanvas');

      if (canvas) {
        canvas.classList.remove('preview-desktop', 'preview-tablet', 'preview-mobile');
        canvas.classList.add(`preview-${mode}`);
      }

      // Update button states
      ['Desktop', 'Tablet', 'Mobile'].forEach(m => {
        const btn = document.getElementById(`preview${m}Btn`);
        if (btn) {
          btn.classList.toggle('active', m.toLowerCase() === mode);
        }
      });
    }

    /**
     * Toggle Header/Footer Sections
     */
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.toggle('visible');
      }
    }

    /**
     * Alignment functions
     */
    function alignComponents(alignment) {
      const selected = canvasState.selectedComponents;
      if (selected.length === 0) return;

      selected.forEach(component => {
        switch(alignment) {
          case 'left':
            component.style.marginLeft = '0';
            component.style.marginRight = 'auto';
            break;
          case 'center':
            component.style.marginLeft = 'auto';
            component.style.marginRight = 'auto';
            break;
          case 'right':
            component.style.marginLeft = 'auto';
            component.style.marginRight = '0';
            break;
        }
      });
    }

    /**
     * Setup WYSIWYG Event Listeners
     */
    function setupWYSIWYGListeners() {
      // Grid toggle
      const gridBtn = document.getElementById('toggleGridBtn');
      if (gridBtn) gridBtn.addEventListener('click', toggleGrid);

      // Rulers toggle
      const rulersBtn = document.getElementById('toggleRulersBtn');
      if (rulersBtn) rulersBtn.addEventListener('click', toggleRulers);

      // Snap to grid
      const snapSelect = document.getElementById('snapToGridSelect');
      if (snapSelect) {
        snapSelect.addEventListener('change', (e) => {
          const value = e.target.value;
          canvasState.snapToGrid = value === 'off' ? 0 : parseInt(value);
          const gridOverlay = document.getElementById('gridOverlay');
          if (gridOverlay) {
            gridOverlay.classList.remove('snap-8', 'snap-16', 'snap-24');
            if (value !== 'off') {
              gridOverlay.classList.add(`snap-${value}`);
            }
          }
        });
      }

      // Zoom control
      const zoomSelect = document.getElementById('zoomSelect');
      if (zoomSelect) {
        zoomSelect.addEventListener('change', (e) => {
          setZoom(parseInt(e.target.value));
        });
      }

      // Preview mode buttons
      const previewBtns = {
        previewDesktopBtn: 'desktop',
        previewTabletBtn: 'tablet',
        previewMobileBtn: 'mobile'
      };

      Object.entries(previewBtns).forEach(([btnId, mode]) => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.addEventListener('click', () => setPreviewMode(mode));
        }
      });

      // Alignment buttons
      const alignBtns = {
        alignLeftBtn: 'left',
        alignCenterBtn: 'center',
        alignRightBtn: 'right'
      };

      Object.entries(alignBtns).forEach(([btnId, alignment]) => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.addEventListener('click', () => alignComponents(alignment));
        }
      });

      // Section toggles
      const headerBtn = document.getElementById('toggleHeaderBtn');
      if (headerBtn) {
        headerBtn.addEventListener('click', () => toggleSection('formHeaderSection'));
      }

      const footerBtn = document.getElementById('toggleFooterBtn');
      if (footerBtn) {
        footerBtn.addEventListener('click', () => toggleSection('formFooterSection'));
      }

      // Click canvas to deselect
      const canvas = document.getElementById('formCanvas');
      if (canvas) {
        canvas.addEventListener('click', (e) => {
          if (e.target === canvas || e.target.classList.contains('form-body')) {
            document.querySelectorAll('.form-component.selected').forEach(el => {
              el.classList.remove('selected');
            });
            canvasState.selectedComponents = [];
          }
        });
      }

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Delete selected component
        if (e.key === 'Delete' && canvasState.selectedComponents.length > 0) {
          canvasState.selectedComponents.forEach(comp => comp.remove());
          canvasState.selectedComponents = [];
        }

        // Ctrl/Cmd + D to duplicate
        if ((e.ctrlKey || e.metaKey) && e.key === 'd' && canvasState.selectedComponents.length > 0) {
          e.preventDefault();
          canvasState.selectedComponents.forEach(comp => {
            const clone = comp.cloneNode(true);
            comp.parentNode.insertBefore(clone, comp.nextSibling);
          });
        }
      });
    }

    /**
     * Initialize WYSIWYG features on page load
     */
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initComponentLibrary();
        setupWYSIWYGListeners();
        drawRulers();
      });
    } else {
      initComponentLibrary();
      setupWYSIWYGListeners();
      drawRulers();
    }

    /**
     * ============================================================
     * END WYSIWYG FORM DESIGNER FEATURES
     * ============================================================
     */

    /**
     * Enhanced Function Builder - Action Button Handlers
     */

    // NPM Package Manager State
    let installedPackages = [];
    let npmSearchResults = [];

    // Initialize Monaco Editor on page load
    document.addEventListener('DOMContentLoaded', () => {
      initializeMonacoEditor();
      setupFunctionActionButtons();
      setupTabSwitching();

      // Initialize autosave system with default 5-minute interval
      autosaveManager.init({
        interval: 5 * 60 * 1000, // 5 minutes
        debounceDelay: 2000       // 2 seconds
      }).then(() => {
        console.log(' Autosave system initialized');
      }).catch((error) => {
        console.warn(' Autosave initialization warning:', error.message);
      });
    });

    /**
     * Tab Switching Functionality
     */
    function setupTabSwitching() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetTab = button.getAttribute('data-tab');

          // Remove active class from all buttons and contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));

          // Add active class to clicked button
          button.classList.add('active');

          // Add active class to corresponding content
          const targetContent = document.getElementById(`${targetTab}Tab`);
          if (targetContent) {
            targetContent.classList.add('active');

            // Special handling for tabs with Monaco editor
            if (targetTab === 'functions' && monacoEditor) {
              // Trigger layout refresh for Monaco editor
              setTimeout(() => {
                monacoEditor.layout();
              }, 50);
            }
          }
        });
      });
    }

    function setupFunctionActionButtons() {
      // Format button
      const formatBtn = document.getElementById('formatFunctionBtn');
      if (formatBtn) {
        formatBtn.addEventListener('click', () => {
          formatMonacoCode();
          showNotification('Code formatted successfully', 'success');
        });
      }

      // Debug button
      const debugBtn = document.getElementById('debugFunctionBtn');
      if (debugBtn) {
        debugBtn.addEventListener('click', () => {
          toggleDebugMode();
        });
      }

      // Test button
      const testBtn = document.getElementById('testFunctionBtn');
      if (testBtn) {
        testBtn.addEventListener('click', () => {
          openTestFunctionDialog();
        });
      }

      // Deploy button
      const deployBtn = document.getElementById('deployFunctionBtn');
      if (deployBtn) {
        deployBtn.addEventListener('click', () => {
          deployFunction();
        });
      }

      // NPM Packages button
      const npmBtn = document.getElementById('npmPackagesBtn');
      if (npmBtn) {
        npmBtn.addEventListener('click', () => {
          toggleNpmPanel();
        });
      }

      // Close NPM panel
      const closeNpmBtn = document.getElementById('closeNpmPanelBtn');
      if (closeNpmBtn) {
        closeNpmBtn.addEventListener('click', () => {
          document.getElementById('npmPanel').style.display = 'none';
        });
      }

      // NPM Search
      const npmSearchBtn = document.getElementById('npmSearchBtn');
      if (npmSearchBtn) {
        npmSearchBtn.addEventListener('click', () => {
          searchNpmPackages();
        });
      }

      const npmSearchInput = document.getElementById('npmSearchInput');
      if (npmSearchInput) {
        npmSearchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            searchNpmPackages();
          }
        });
      }
    }

    function toggleDebugMode() {
      const debugBtn = document.getElementById('debugFunctionBtn');
      const isDebugMode = debugBtn.classList.toggle('btn-warning');

      if (isDebugMode) {
        safeSetHTML(debugBtn, '<i class="fas fa-bug"></i> Debug (ON)');
        showNotification('Debug mode enabled - breakpoints active', 'info');

        // Add debug statement to code
        if (monacoEditor) {
          const currentCode = monacoEditor.getValue();
          if (!currentCode.includes('debugger;')) {
            const lines = currentCode.split('\n');
            const firstBraceIndex = lines.findIndex(line => line.includes('{'));
            if (firstBraceIndex !== -1) {
              lines.splice(firstBraceIndex + 1, 0, '  debugger; // Debug breakpoint');
              monacoEditor.setValue(lines.join('\n'));
            }
          }
        }
      } else {
        safeSetHTML(debugBtn, '<i class="fas fa-bug"></i> Debug');
        showNotification('Debug mode disabled', 'info');

        // Remove debug statement
        if (monacoEditor) {
          const currentCode = monacoEditor.getValue();
          const cleanedCode = currentCode.replace(/\s*debugger;.*\n?/g, '');
          monacoEditor.setValue(cleanedCode);
        }
      }
    }

    function openTestFunctionDialog() {
      if (!currentEditingFunction) {
        showNotification('Please select a function to test', 'warning');
        return;
      }

      // Create test dialog
      const dialog = document.createElement('div');
      dialog.className = 'modal';
      dialog.style.display = 'block';
      safeSetHTML(dialog, `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h3 class="modal-title">Test Function: ${currentEditingFunction}</h3>
            <button class="modal-close" onclick="this.closest('.modal').remove()">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="form-group">
            <label>Test Parameters (JSON)</label>
            <textarea id="testParamsInput" class="property-input" rows="8" placeholder='{\n  "param1": "value1",\n  "param2": 123\n}'></textarea>
          </div>

          <div class="form-group">
            <label>Expected Result (optional)</label>
            <input type="text" id="expectedResultInput" class="property-input" placeholder="Expected return value">
          </div>

          <div id="testResults" style="display: none; margin-top: 1rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 4px;">
            <strong>Test Results:</strong>
            <pre id="testOutput" style="margin-top: 0.5rem; background: #f5f5f5; padding: 0.5rem; border-radius: 4px; overflow-x: auto;"></pre>
          </div>

          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
            <button class="btn btn-primary" onclick="runFunctionTest(this)">
              <i class="fas fa-play"></i> Run Test
            </button>
          </div>
        </div>
      `);

      document.body.appendChild(dialog);
    }

    window.runFunctionTest = async function(btn) {
      const paramsInput = document.getElementById('testParamsInput');
      const expectedInput = document.getElementById('expectedResultInput');
      const resultsDiv = document.getElementById('testResults');
      const outputPre = document.getElementById('testOutput');

      // Show loading state on button
      loadingManager.showButtonLoading(btn);

      // Show loading state in output
      outputPre.textContent = ' Executing function in sandbox...';
      outputPre.style.color = '#666';
      resultsDiv.style.display = 'block';

      try {
        const code = getMonacoCode();
        const params = paramsInput.value ? JSON.parse(paramsInput.value) : {};

        // Execute function in sandboxed iframe with 5 second timeout
        const result = await executeSandboxedCode(code, params, currentEditingFunction, 5000);

        let output = ` Function executed successfully in sandbox\n\n`;
        output += `Result: ${JSON.stringify(result, null, 2)}\n`;

        if (expectedInput.value) {
          const expected = expectedInput.value;
          const matches = JSON.stringify(result) === JSON.stringify(expected);
          output += `\nExpected: ${expected}\n`;
          output += `Match: ${matches ? ' PASS' : ' FAIL'}`;
        }

        outputPre.textContent = output;
        outputPre.style.color = 'green';
      } catch (error) {
        outputPre.textContent = ` Error: ${error.message}\n\nStack:\n${error.stack || 'No stack trace available'}`;
        outputPre.style.color = 'red';
      } finally {
        // Hide loading state on button
        loadingManager.hideButtonLoading(btn);
      }
    };

    function deployFunction() {
      if (!currentEditingFunction) {
        showNotification('Please select a function to deploy', 'warning');
        return;
      }

      const code = getMonacoCode();

      if (!code || code.trim() === '' || code.includes('// Select a function')) {
        showNotification('Please write function code before deploying', 'warning');
        return;
      }

      // Store the function code
      if (!window.FORM_DESIGNER_STATE.customFunctions) {
        window.FORM_DESIGNER_STATE.customFunctions = {};
      }

      window.FORM_DESIGNER_STATE.customFunctions[currentEditingFunction] = {
        name: currentEditingFunction,
        code: code,
        deployedAt: new Date().toISOString()
      };

      // Mark as dirty
      window.FORM_DESIGNER_STATE.isDirty = true;

      showNotification(`Function "${currentEditingFunction}" deployed successfully!`, 'success');

      // Update the functions table if functionsManager exists
      if (window.functionsManager && typeof window.functionsManager.renderFunctionsTable === 'function') {
        window.functionsManager.renderFunctionsTable();
      }
    }

    function toggleNpmPanel() {
      const panel = document.getElementById('npmPanel');
      const isVisible = panel.style.display !== 'none';
      panel.style.display = isVisible ? 'none' : 'block';

      if (!isVisible) {
        loadInstalledPackages();
      }
    }

    function loadInstalledPackages() {
      // For now, show mock data - this would be replaced with actual API call
      const packagesList = document.getElementById('npmPackagesList');

      if (installedPackages.length === 0) {
        safeSetHTML(packagesList, `
          <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
            <p><strong>Installed Packages:</strong></p>
            <p style="margin-top: 1rem; font-size: 0.875rem;">No packages installed yet. Search above to add packages.</p>
          </div>
        `);
      } else {
        safeSetHTML(packagesList, installedPackages.map(pkg => `
          <div class="npm-package-item">
            <div class="npm-package-info">
              <div class="npm-package-name">${pkg.name}</div>
              <div class="npm-package-version">v${pkg.version}</div>
            </div>
            <div class="npm-package-actions">
              <button class="btn btn-sm btn-danger" onclick="uninstallPackage('${pkg.name}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `).join(''));
      }
    }

    async function searchNpmPackages() {
      const searchInput = document.getElementById('npmSearchInput');
      const query = searchInput.value.trim();

      if (!query) {
        showNotification('Please enter a package name to search', 'warning');
        return;
      }

      const packagesList = document.getElementById('npmPackagesList');
      safeSetHTML(packagesList, '<div style="padding: 2rem; text-align: center;"><i class="fas fa-spinner fa-spin"></i> Searching...</div>');

      try {
        // Search npm registry
        const response = await fetch(`https://registry.npmjs.org/-/v1/search?text=${encodeURIComponent(query)}&size=10`);
        const data = await response.json();

        npmSearchResults = data.objects.map(obj => ({
          name: obj.package.name,
          version: obj.package.version,
          description: obj.package.description
        }));

        if (npmSearchResults.length === 0) {
          safeSetHTML(packagesList, '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No packages found</div>');
          return;
        }

        safeSetHTML(packagesList, npmSearchResults.map(pkg => `
          <div class="npm-package-item">
            <div class="npm-package-info">
              <div class="npm-package-name">${pkg.name}</div>
              <div class="npm-package-version">v${pkg.version}</div>
              <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">${pkg.description || ''}</div>
            </div>
            <div class="npm-package-actions">
              <button class="btn btn-sm btn-primary" onclick="installPackage('${pkg.name}', '${pkg.version}')">
                <i class="fas fa-download"></i> Install
              </button>
            </div>
          </div>
        `).join(''));
      } catch (error) {
        safeSetHTML(packagesList, `<div style="padding: 2rem; text-align: center; color: var(--danger-color);">Error searching packages: ${error.message}</div>`);
      }
    }

    window.installPackage = function(name, version) {
      const existing = installedPackages.find(pkg => pkg.name === name);

      if (existing) {
        showNotification(`Package "${name}" is already installed`, 'warning');
        return;
      }

      installedPackages.push({ name, version });
      showNotification(`Package "${name}@${version}" installed successfully`, 'success');
      loadInstalledPackages();

      // Mark form as dirty
      window.FORM_DESIGNER_STATE.isDirty = true;
    };

    window.uninstallPackage = function(name) {
      installedPackages = installedPackages.filter(pkg => pkg.name !== name);
      showNotification(`Package "${name}" uninstalled`, 'success');
      loadInstalledPackages();

      // Mark form as dirty
      window.FORM_DESIGNER_STATE.isDirty = true;
    };

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : type === 'error' ? '#dc3545' : '#17a2b8'};
        color: white;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Add CSS animations for notifications
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    /**
     * Variables UI Manager
     */
    const variablesUI = {
      variables: [],
      forms: [],
      objects: [],
      workflows: [],
      allVariables: [], // Combined list with source information

      async init() {
        await Promise.all([
          this.loadVariables(),
          this.loadForms(),
          this.loadObjects(),
          this.loadWorkflows()
        ]);

        this.setupEventListeners();
        this.renderTable();
      },

      setupEventListeners() {
        // Global search
        document.getElementById('variablesGlobalSearch')?.addEventListener('input', (e) => {
          this.search(e.target.value);
        });

        // Export button
        document.getElementById('exportVariablesBtn')?.addEventListener('click', () => {
          this.exportData();
        });

        // Add variable button
        document.getElementById('addVariableBtn')?.addEventListener('click', () => {
          this.addVariable();
        });
      },

      async loadVariables() {
        // Mock data for now - replace with real API call
        this.variables = [
          { id: '1', name: 'userId', type: 'string', scope: 'session', defaultValue: '', source: 'Manual' },
          { id: '2', name: 'cart', type: 'array', scope: 'global', defaultValue: '[]', source: 'Manual' },
          { id: '3', name: 'isAuthenticated', type: 'boolean', scope: 'session', defaultValue: 'false', source: 'Manual' }
        ];
      },

      async loadForms() {
        const appId = new URLSearchParams(window.location.search).get('appId');
        if (!appId) return;

        try {
          const response = await fetch(`/lowcode/api/forms?applicationId=${appId}`);
          const result = await response.json();
          if (result.success) {
            this.forms = result.data?.forms || result.data || [];
          }
        } catch (error) {
          console.error('Error loading forms:', error);
        }
      },

      async loadObjects() {
        const appId = new URLSearchParams(window.location.search).get('appId');
        if (!appId) return;

        try {
          const response = await fetch(`/lowcode/api/entities?applicationId=${appId}`);
          const result = await response.json();
          if (result.success) {
            this.objects = result.data || [];
          }
        } catch (error) {
          console.error('Error loading objects:', error);
        }
      },

      async loadWorkflows() {
        try {
          const response = await fetch('/api/workflows');
          const result = await response.json();
          if (result.success) {
            this.workflows = result.data || [];
          }
        } catch (error) {
          console.error('Error loading workflows:', error);
        }
      },

      renderTable() {
        const tbody = document.getElementById('variablesTableBody');
        if (!tbody) return;

        // Combine all variables from different sources
        this.allVariables = [
          ...this.variables,
          ...this.forms.map(f => ({
            id: `form_${f.id}`,
            name: f.name || f.displayName,
            type: 'object',
            scope: 'form',
            defaultValue: '{}',
            source: `Form: ${f.displayName || f.name}`
          })),
          ...this.objects.map(obj => ({
            id: `object_${obj.id}`,
            name: obj.name || obj.displayName,
            type: 'object',
            scope: 'global',
            defaultValue: '{}',
            source: `Object: ${obj.displayName || obj.name}`
          })),
          ...this.workflows.map(wf => ({
            id: `workflow_${wf.id}`,
            name: wf.name,
            type: 'object',
            scope: 'workflow',
            defaultValue: '{}',
            source: `Workflow: ${wf.name}`
          }))
        ];

        if (this.allVariables.length === 0) {
          safeSetHTML(tbody, `
            <tr>
              <td colspan="6" class="text-muted" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                No variables defined. Click "Add Variable" to create one.
              </td>
            </tr>
          `);
          return;
        }

        safeSetHTML(tbody, this.allVariables.map(variable => `
          <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 0.75rem; color: var(--text-primary);">
              <strong>${variable.name}</strong>
            </td>
            <td style="padding: 0.75rem; color: var(--text-primary);">
              <span style="background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">${variable.type}</span>
            </td>
            <td style="padding: 0.75rem; color: var(--text-primary);">
              ${variable.scope}
            </td>
            <td style="padding: 0.75rem; color: var(--text-secondary); font-family: monospace; font-size: 0.875rem;">
              ${variable.defaultValue || '-'}
            </td>
            <td style="padding: 0.75rem; color: var(--text-primary);">
              ${variable.source}
            </td>
            <td style="padding: 0.75rem;">
              <div style="display: flex; gap: 0.5rem;">
                ${!variable.id.startsWith('form_') && !variable.id.startsWith('object_') && !variable.id.startsWith('workflow_') ? `
                  <button onclick="variablesUI.editVariable('${variable.id}')"
                          class="btn btn-sm btn-secondary" title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="variablesUI.deleteVariable('${variable.id}')"
                          class="btn btn-sm btn-secondary" style="color: var(--danger-color);" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                ` : `
                  <span style="color: var(--text-tertiary); font-size: 0.875rem;">Read-only</span>
                `}
              </div>
            </td>
          </tr>
        `).join(''));
      },

      search(term) {
        const searchTerm = term.toLowerCase().trim();

        if (!searchTerm) {
          this.renderTable();
          return;
        }

        // Filter variables in the table
        const tbody = document.getElementById('variablesTableBody');
        if (!tbody) return;

        const filteredVariables = this.allVariables.filter(v =>
          v.name.toLowerCase().includes(searchTerm) ||
          v.type.toLowerCase().includes(searchTerm) ||
          v.scope.toLowerCase().includes(searchTerm) ||
          v.source.toLowerCase().includes(searchTerm)
        );

        if (filteredVariables.length === 0) {
          safeSetHTML(tbody, `
            <tr>
              <td colspan="6" class="text-muted" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                No variables found matching "${term}".
              </td>
            </tr>
          `);
          return;
        }

        safeSetHTML(tbody, filteredVariables.map(variable => `
          <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 0.75rem; color: var(--text-primary);">
              <strong>${variable.name}</strong>
            </td>
            <td style="padding: 0.75rem; color: var(--text-primary);">
              <span style="background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">${variable.type}</span>
            </td>
            <td style="padding: 0.75rem; color: var(--text-primary);">
              ${variable.scope}
            </td>
            <td style="padding: 0.75rem; color: var(--text-secondary); font-family: monospace; font-size: 0.875rem;">
              ${variable.defaultValue || '-'}
            </td>
            <td style="padding: 0.75rem; color: var(--text-primary);">
              ${variable.source}
            </td>
            <td style="padding: 0.75rem;">
              <div style="display: flex; gap: 0.5rem;">
                ${!variable.id.startsWith('form_') && !variable.id.startsWith('object_') && !variable.id.startsWith('workflow_') ? `
                  <button onclick="variablesUI.editVariable('${variable.id}')"
                          class="btn btn-sm btn-secondary" title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="variablesUI.deleteVariable('${variable.id}')"
                          class="btn btn-sm btn-secondary" style="color: var(--danger-color);" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                ` : `
                  <span style="color: var(--text-tertiary); font-size: 0.875rem;">Read-only</span>
                `}
              </div>
            </td>
          </tr>
        `).join(''));
      },

      exportData() {
        const exportData = {
          variables: this.variables,
          forms: this.forms.map(f => ({ id: f.id, name: f.name, displayName: f.displayName })),
          objects: this.objects.map(o => ({ id: o.id, name: o.name, displayName: o.displayName })),
          workflows: this.workflows.map(w => ({ id: w.id, name: w.name, description: w.description })),
          exportedAt: new Date().toISOString()
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);

        const link = document.createElement('a');
        link.href = url;
        link.download = `variables-export-${Date.now()}.json`;
        link.click();

        URL.revokeObjectURL(url);
        showNotification('Data exported successfully', 'success');
      },

      addVariable() {
        // TODO: Implement add variable modal
        showNotification('Add Variable functionality to be implemented', 'info');
      },

      editVariable(variableId) {
        const variable = this.variables.find(v => v.id === variableId);
        if (variable) {
          // TODO: Implement edit modal
          showNotification(`Edit variable: ${variable.name}`, 'info');
        }
      },

      deleteVariable(variableId) {
        if (confirm('Are you sure you want to delete this variable?')) {
          this.variables = this.variables.filter(v => v.id !== variableId);
          this.renderTable();
          showNotification('Variable deleted successfully', 'success');
        }
      }
    };

    // Initialize variables UI when page loads
    document.addEventListener('DOMContentLoaded', () => {
      variablesUI.init();
    });
  </script>

  <!-- Visual Query Builder -->
  <link rel="stylesheet" href="/lowcode/static/css/query-builder.css">
  <script src="/lowcode/static/js/form-query-builder.js"></script>
  <script src="/lowcode/static/js/form-query-builder-ui.js"></script>
  <script src="/lowcode/static/js/form-query-builder-ui-tabs.js"></script>
  <script src="/lowcode/static/js/form-query-builder-ui-advanced.js"></script>

  <!-- Initialize Git Toolbar -->
  <script>
    // Initialize Git toolbar for this form
    <% if (formId) { %>
      document.addEventListener('DOMContentLoaded', () => {
        window.gitToolbar = new GitToolbar('form', '<%= formId %>');

        // Hook into save functionality to support auto-commit
        const originalSave = window.saveForm || window.saveFormData;
        if (originalSave) {
          window.saveForm = async function() {
            await originalSave.call(this);

            // Auto-commit if enabled
            if (window.gitToolbar && window.gitToolbar.autoCommit) {
              await window.gitToolbar.showCommitModal();
            }
          };
        }
      });
    <% } %>
  </script>
</body>
</html>
