<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Exprsn Low-Code</title>

  <!-- Exprsn Theme -->
  <link rel="stylesheet" href="/css/exprsn-theme.css">
  <link rel="stylesheet" href="/css/lowcode-theme.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>

  <style>
    .designer-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--bg-primary);
    }

    .designer-header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .app-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex: 1;
    }

    .app-icon {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
    }

    .app-details h1 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--text-primary);
    }

    .app-details p {
      margin: 0.25rem 0 0 0;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      gap: 2rem;
      padding: 0 2rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .stat-item {
      padding: 0.75rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .stat-item i {
      color: var(--primary-color);
    }

    .stat-value {
      font-weight: 600;
      color: var(--text-primary);
    }

    .stat-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success-color);
      margin-right: 0.25rem;
    }

    .header-actions {
      display: flex;
      gap: 0.75rem;
    }

    .designer-main {
      flex: 1;
      overflow: auto;
      padding: 2rem;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 1rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--border-color);
    }

    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .tool-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 2rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      position: relative;
    }

    .tool-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      border-color: var(--primary-color);
    }

    .tool-card.disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .tool-card.disabled:hover {
      transform: none;
      box-shadow: none;
      border-color: var(--border-color);
    }

    .tool-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      color: white;
    }

    .tool-icon.entities { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .tool-icon.forms { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .tool-icon.grids { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .tool-icon.queries { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
    .tool-icon.workflows { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .tool-icon.processes { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .tool-icon.charts { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
    .tool-icon.dashboards { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
    .tool-icon.settings { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
    .tool-icon.preview { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
    .tool-icon.decisions { background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%); }
    .tool-icon.plugins { background: linear-gradient(135deg, #9795f0 0%, #fbc8d4 100%); }
    .tool-icon.cards { background: linear-gradient(135deg, #fa8bff 0%, #2bd2ff 90%); }
    .tool-icon.polls { background: linear-gradient(135deg, #81fbb8 0%, #28c76f 100%); }
    .tool-icon.datasources { background: linear-gradient(135deg, #ee9ae5 0%, #5961f9 100%); }
    .tool-icon.apis { background: linear-gradient(135deg, #13547a 0%, #80d0c7 100%); }
    .tool-icon.security { background: linear-gradient(135deg, #e96443 0%, #904e95 100%); }
    .tool-icon.automation { background: linear-gradient(135deg, #f77062 0%, #fe5196 100%); }

    .tool-content h3 {
      margin: 0;
      font-size: 1.25rem;
      color: var(--text-primary);
    }

    .tool-content p {
      margin: 0.5rem 0 0 0;
      color: var(--text-secondary);
      font-size: 0.875rem;
      line-height: 1.5;
    }

    .tool-footer {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-secondary);
      font-size: 0.75rem;
    }

    .tool-badge {
      background: var(--primary-color);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .tool-badge.success { background: var(--success-color); }
    .tool-badge.warning { background: var(--warning-color); }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }

    .loading-indicator {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .loading-spinner {
      border: 3px solid var(--border-color);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="designer-container">
    <!-- Header -->
    <header class="designer-header">
      <div class="app-info">
        <div class="app-icon">
          <i class="fas fa-cubes"></i>
        </div>
        <div class="app-details">
          <h1 id="appName">Loading...</h1>
          <p id="appDescription">Loading application details...</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.location.href='/lowcode/applications'">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button class="btn btn-primary" onclick="runApplication()">
          <i class="fas fa-play"></i> Run
        </button>
      </div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-dot"></span>
        <span id="activeConnections">0</span>
        <span>Active Connections</span>
      </div>
      <div class="stat-item">
        <i class="fas fa-users"></i>
        <span class="stat-value" id="totalUsers">0</span>
        <span>Users</span>
      </div>
      <div class="stat-item">
        <i class="fas fa-user-tag"></i>
        <span class="stat-value" id="totalRoles">0</span>
        <span>Roles</span>
      </div>
      <div class="stat-item">
        <i class="fas fa-users-cog"></i>
        <span class="stat-value" id="totalGroups">0</span>
        <span>Groups</span>
      </div>
      <div class="stat-item">
        <i class="fas fa-clock"></i>
        <span>Updated <span id="lastUpdated">-</span></span>
      </div>
    </div>

    <!-- Main Content -->
    <main class="designer-main">
      <h2 class="section-title">Application Designer</h2>

      <div class="tools-grid">
        <!-- Entities Tool -->
        <div class="tool-card" data-tool="entities">
          <div class="tool-icon entities">
            <i class="fas fa-database"></i>
          </div>
          <div class="tool-content">
            <h3>Data Entities <small style="color: var(--primary-color); font-size: 0.75rem;">Enhanced</small></h3>
            <p>Visual database designer with 25+ field types, migration generator, CRUD API generation, schema diff, rollback tools, and real-time collaboration.</p>
          </div>
          <div class="tool-footer">
            <span id="entitiesCount">0 entities</span>
            <span class="tool-badge success">13 Features</span>
          </div>
        </div>

        <!-- Forms Tool -->
        <div class="tool-card" data-tool="forms" onclick="window.location.href='/lowcode/forms?appId=<%= appId %>'">
          <div class="tool-icon forms">
            <i class="fas fa-wpforms"></i>
          </div>
          <div class="tool-content">
            <h3>Forms</h3>
            <p>Create interactive forms with drag-and-drop interface builder.</p>
          </div>
          <div class="tool-footer">
            <span id="formsCount">0 forms</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Grids Tool -->
        <div class="tool-card" data-tool="grids">
          <div class="tool-icon grids">
            <i class="fas fa-table"></i>
          </div>
          <div class="tool-content">
            <h3>Data Grids</h3>
            <p>Build data tables with sorting, filtering, and pagination.</p>
          </div>
          <div class="tool-footer">
            <span id="gridsCount">0 grids</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Visual Query Builder Tool -->
        <div class="tool-card" data-tool="queries" onclick="window.location.href='/lowcode/queries?appId=<%= appId %>'">
          <div class="tool-icon queries">
            <i class="fas fa-filter"></i>
          </div>
          <div class="tool-content">
            <h3>Visual Queries <small style="color: var(--primary-color); font-size: 0.75rem; font-weight: 600;">NEW</small></h3>
            <p>Build complex data queries with visual interface supporting 10 datasource types, filters, aggregations, and transformations.</p>
          </div>
          <div class="tool-footer">
            <span id="queriesCount">0 queries</span>
            <span class="tool-badge success">10 Datasources</span>
          </div>
        </div>

        <!-- BPMN Processes Tool -->
        <div class="tool-card" data-tool="processes">
          <div class="tool-icon processes">
            <i class="fas fa-sitemap"></i>
          </div>
          <div class="tool-content">
            <h3>BPMN Processes</h3>
            <p>Design business process workflows with BPMN 2.0 standard notation.</p>
          </div>
          <div class="tool-footer">
            <span id="processesCount">0 processes</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Exprsn-Kicks Workflows Tool -->
        <div class="tool-card" data-tool="workflows">
          <div class="tool-icon workflows">
            <i class="fas fa-project-diagram"></i>
          </div>
          <div class="tool-content">
            <h3>Visual Workflows</h3>
            <p>Build data flow automations with visual node-based programming (Exprsn-Kicks).</p>
          </div>
          <div class="tool-footer">
            <span id="workflowsCount">0 workflows</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Charts Tool -->
        <div class="tool-card" data-tool="charts">
          <div class="tool-icon charts">
            <i class="fas fa-chart-bar"></i>
          </div>
          <div class="tool-content">
            <h3>Charts & Analytics</h3>
            <p>Create data visualizations with 6 chart types (bar, line, pie, area, scatter, doughnut).</p>
          </div>
          <div class="tool-footer">
            <span id="chartsCount">0 charts</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Reports Tool -->
        <div class="tool-card" data-tool="reports" onclick="window.location.href='/lowcode/reports?applicationId=<%= appId %>'">
          <div class="tool-icon reports" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="tool-content">
            <h3>Reports <small style="color: var(--primary-color); font-size: 0.75rem; font-weight: 600;">NEW</small></h3>
            <p>Build SQL reports with visual query builder, parameters, and Chart.js visualizations.</p>
          </div>
          <div class="tool-footer">
            <span id="reportsCount">0 reports</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Dashboards Tool -->
        <div class="tool-card" data-tool="dashboards" onclick="window.location.href='/lowcode/dashboards?appId=<%= appId %>'">
          <div class="tool-icon dashboards">
            <i class="fas fa-th-large"></i>
          </div>
          <div class="tool-content">
            <h3>Dashboards</h3>
            <p>Combine charts, grids, and widgets into interactive dashboards.</p>
          </div>
          <div class="tool-footer">
            <span id="dashboardsCount">0 dashboards</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Application Flow Designer Tool -->
        <div class="tool-card" data-tool="flows" onclick="window.location.href='/lowcode/app-flow-designer?appId=<%= appId %>'">
          <div class="tool-icon workflows">
            <i class="fas fa-diagram-project"></i>
          </div>
          <div class="tool-content">
            <h3>Application Flows <small style="color: var(--primary-color); font-size: 0.75rem; font-weight: 600;">NEW</small></h3>
            <p>Design user journeys and screen navigation flows with visual flowchart designer.</p>
          </div>
          <div class="tool-footer">
            <span id="flowsCount">0 flows</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Settings Tool -->
        <div class="tool-card" data-tool="settings">
          <div class="tool-icon settings">
            <i class="fas fa-cog"></i>
          </div>
          <div class="tool-content">
            <h3>Settings & Variables</h3>
            <p>Configure application settings, define variables, and manage environment-specific values.</p>
          </div>
          <div class="tool-footer">
            <span>Manage settings</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Preview/Run Tool -->
        <div class="tool-card" data-tool="preview">
          <div class="tool-icon preview">
            <i class="fas fa-eye"></i>
          </div>
          <div class="tool-content">
            <h3>Preview & Run</h3>
            <p>Test and interact with your application in runtime mode.</p>
          </div>
          <div class="tool-footer">
            <span>Launch app</span>
            <i class="fas fa-external-link-alt"></i>
          </div>
        </div>

        <!-- Decision Tables Tool -->
        <div class="tool-card" data-tool="decisions">
          <div class="tool-icon decisions">
            <i class="fas fa-gavel"></i>
          </div>
          <div class="tool-content">
            <h3>Decision Tables</h3>
            <p>Define business rules using DMN decision tables with 16 operators and 5 hit policies.</p>
          </div>
          <div class="tool-footer">
            <span id="decisionsCount">0 tables</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Plugins Tool -->
        <div class="tool-card" data-tool="plugins">
          <div class="tool-icon plugins">
            <i class="fas fa-plug"></i>
          </div>
          <div class="tool-content">
            <h3>Plugins & Extensions</h3>
            <p>Extend functionality with custom plugins, hooks, and third-party integrations.</p>
          </div>
          <div class="tool-footer">
            <span id="pluginsCount">0 plugins</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Cards Tool -->
        <div class="tool-card" data-tool="cards">
          <div class="tool-icon cards">
            <i class="fas fa-clone"></i>
          </div>
          <div class="tool-content">
            <h3>Reusable Cards</h3>
            <p>Create reusable UI components and share them across your applications.</p>
          </div>
          <div class="tool-footer">
            <span id="cardsCount">0 cards</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Polls Tool -->
        <div class="tool-card" data-tool="polls">
          <div class="tool-icon polls">
            <i class="fas fa-poll"></i>
          </div>
          <div class="tool-content">
            <h3>Polls & Surveys</h3>
            <p>Create interactive polls and surveys with real-time voting and analytics.</p>
          </div>
          <div class="tool-footer">
            <span id="pollsCount">0 polls</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Data Sources Tool -->
        <div class="tool-card" data-tool="datasources" onclick="window.location.href='/lowcode/datasources?appId=<%= appId %>'">
          <div class="tool-icon datasources">
            <i class="fas fa-database"></i>
          </div>
          <div class="tool-content">
            <h3>Data Sources</h3>
            <p>Connect to external databases, APIs, Forge CRM, and other data sources.</p>
          </div>
          <div class="tool-footer">
            <span id="datasourcesCount">0 sources</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- APIs Tool -->
        <div class="tool-card" data-tool="apis">
          <div class="tool-icon apis">
            <i class="fas fa-code"></i>
          </div>
          <div class="tool-content">
            <h3>APIs & Integrations</h3>
            <p>Build RESTful APIs, webhooks, and integrate with external services.</p>
          </div>
          <div class="tool-footer">
            <span id="apisCount">0 endpoints</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Security Tool -->
        <div class="tool-card" data-tool="security">
          <div class="tool-icon security">
            <i class="fas fa-shield-alt"></i>
          </div>
          <div class="tool-content">
            <h3>Security & Permissions</h3>
            <p>Manage users, roles, groups, and fine-grained access controls (RBAC).</p>
          </div>
          <div class="tool-footer">
            <span>Manage access</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>

        <!-- Automation Tool -->
        <div class="tool-card" data-tool="automation">
          <div class="tool-icon automation">
            <i class="fas fa-magic"></i>
          </div>
          <div class="tool-content">
            <h3>Automation Rules</h3>
            <p>Create event-driven automation rules with triggers, conditions, and actions.</p>
          </div>
          <div class="tool-footer">
            <span id="automationCount">0 rules</span>
            <span class="tool-badge success">Active</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Entity List Modal -->
  <div id="entityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Data Entities</h2>
        <button class="modal-close" onclick="closeModal('entityModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="entityList">
        <div class="loading-indicator">
          <div class="loading-spinner"></div>
          <p>Loading entities...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Grid List Modal -->
  <div id="gridModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Data Grids</h2>
        <button class="modal-close" onclick="closeModal('gridModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="gridList">
        <div class="loading-indicator">
          <div class="loading-spinner"></div>
          <p>Loading grids...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const APP_ID = '<%= appId %>';
    let socket = null;

    // Initialize Socket.IO for real-time stats
    function initSocket() {
      socket = io({
        path: '/socket.io'
      });

      socket.on('connect', () => {
        console.log('Socket connected');
        socket.emit('join-app', APP_ID);
      });

      socket.on('app-stats', (stats) => {
        updateStats(stats);
      });

      socket.on('disconnect', () => {
        console.log('Socket disconnected');
      });
    }

    // Update real-time stats
    function updateStats(stats) {
      document.getElementById('activeConnections').textContent = stats.activeConnections || 0;
      document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
      document.getElementById('totalRoles').textContent = stats.totalRoles || 0;
      document.getElementById('totalGroups').textContent = stats.totalGroups || 0;
    }

    // Load application data
    async function loadApplication() {
      try {
        const response = await fetch(`/lowcode/api/applications/${APP_ID}?includeEntities=true&includeGrids=true&includeForms=true&includeDataSources=true`);
        const data = await response.json();

        if (data.success) {
          const app = data.data;
          document.getElementById('appName').textContent = app.displayName;
          document.getElementById('appDescription').textContent = app.description || 'No description';
          document.title = `${app.displayName} - Designer`;

          // Update counts
          document.getElementById('entitiesCount').textContent = `${app.entities?.length || 0} entities`;
          document.getElementById('gridsCount').textContent = `${app.grids?.length || 0} grids`;
          document.getElementById('formsCount').textContent = `${app.forms?.length || 0} forms`;

          // Update last updated time
          const lastUpdated = new Date(app.updatedAt);
          document.getElementById('lastUpdated').textContent = formatRelativeTime(lastUpdated);

          // Load additional stats
          await loadApplicationStats();
        }
      } catch (error) {
        console.error('Failed to load application:', error);
      }
    }

    // Load application statistics
    async function loadApplicationStats() {
      try {
        // Load processes count
        const processesRes = await fetch(`/lowcode/api/processes/${APP_ID}/processes`);
        if (processesRes.ok) {
          const processesData = await processesRes.json();
          document.getElementById('processesCount').textContent =
            `${processesData.data?.length || 0} processes`;
        }

        // Load charts count
        const chartsRes = await fetch(`/lowcode/api/charts?applicationId=${APP_ID}`);
        if (chartsRes.ok) {
          const chartsData = await chartsRes.json();
          document.getElementById('chartsCount').textContent =
            `${chartsData.data?.charts?.length || 0} charts`;
        }

        // Load dashboards count
        const dashboardsRes = await fetch(`/lowcode/api/dashboards?applicationId=${APP_ID}`);
        if (dashboardsRes.ok) {
          const dashboardsData = await dashboardsRes.json();
          document.getElementById('dashboardsCount').textContent =
            `${dashboardsData.data?.dashboards?.length || 0} dashboards`;
        }

        // Load decision tables count
        const decisionsRes = await fetch(`/api/decision-tables?applicationId=${APP_ID}`);
        if (decisionsRes.ok) {
          const decisionsData = await decisionsRes.json();
          document.getElementById('decisionsCount').textContent =
            `${decisionsData.data?.length || 0} tables`;
        }

        // Load plugins count
        const pluginsRes = await fetch(`/api/plugins`);
        if (pluginsRes.ok) {
          const pluginsData = await pluginsRes.json();
          const appPlugins = pluginsData.data?.filter(p => p.applicationId === APP_ID) || [];
          document.getElementById('pluginsCount').textContent =
            `${appPlugins.length} plugins`;
        }

        // Load cards count
        const cardsRes = await fetch(`/lowcode/api/cards?applicationId=${APP_ID}`);
        if (cardsRes.ok) {
          const cardsData = await cardsRes.json();
          document.getElementById('cardsCount').textContent =
            `${cardsData.data?.cards?.length || 0} cards`;
        }

        // Load polls count
        const pollsRes = await fetch(`/lowcode/api/polls?applicationId=${APP_ID}`);
        if (pollsRes.ok) {
          const pollsData = await pollsRes.json();
          document.getElementById('pollsCount').textContent =
            `${pollsData.data?.polls?.length || 0} polls`;
        }

        // Load data sources count
        const datasourcesRes = await fetch(`/lowcode/api/datasources?applicationId=${APP_ID}`);
        if (datasourcesRes.ok) {
          const datasourcesData = await datasourcesRes.json();
          document.getElementById('datasourcesCount').textContent =
            `${datasourcesData.data?.dataSources?.length || 0} sources`;
        }

        // Load automation count (use workflow count as proxy)
        const workflowsRes = await fetch(`/lowcode/api/workflows?applicationId=${APP_ID}`);
        if (workflowsRes.ok) {
          const workflowsData = await workflowsRes.json();
          document.getElementById('workflowsCount').textContent =
            `${workflowsData.data?.workflows?.length || 0} workflows`;
          document.getElementById('automationCount').textContent =
            `${workflowsData.data?.workflows?.length || 0} rules`;
        }

        // APIs count would require a new endpoint
        document.getElementById('apisCount').textContent = '0 endpoints';
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    function formatRelativeTime(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      return `${diffDays}d ago`;
    }

    function runApplication() {
      window.location.href = `/lowcode/apps/${APP_ID}`;
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Setup click handlers for tool cards
    function setupToolCards() {
      const toolCards = document.querySelectorAll('.tool-card');

      toolCards.forEach(card => {
        const tool = card.getAttribute('data-tool');

        card.addEventListener('click', () => {
          console.log(`Clicked on ${tool} tool`);

          switch(tool) {
            case 'entities':
              window.location.href = `/lowcode/entity-designer?appId=${APP_ID}`;
              break;
            case 'grids':
              window.location.href = `/lowcode/grids/new?appId=${APP_ID}`;
              break;
            case 'forms':
              window.location.href = `/lowcode/forms/new?appId=${APP_ID}`;
              break;
            case 'processes':
              window.location.href = `/lowcode/processes/new?appId=${APP_ID}`;
              break;
            case 'workflows':
              // Integrate Exprsn-Kicks
              window.location.href = `/lowcode/workflows/new?appId=${APP_ID}`;
              break;
            case 'charts':
              window.location.href = `/lowcode/charts/new?appId=${APP_ID}`;
              break;
            case 'dashboards':
              window.location.href = `/lowcode/dashboards/new?appId=${APP_ID}`;
              break;
            case 'decisions':
              window.location.href = `/lowcode/decisions?appId=${APP_ID}`;
              break;
            case 'plugins':
              window.location.href = `/lowcode/plugins?appId=${APP_ID}`;
              break;
            case 'cards':
              window.location.href = `/lowcode/cards?appId=${APP_ID}`;
              break;
            case 'polls':
              window.location.href = `/lowcode/polls?appId=${APP_ID}`;
              break;
            case 'datasources':
              window.location.href = `/lowcode/datasources?appId=${APP_ID}`;
              break;
            case 'apis':
              window.location.href = `/lowcode/apis?appId=${APP_ID}`;
              break;
            case 'security':
              window.location.href = `/lowcode/security?appId=${APP_ID}`;
              break;
            case 'automation':
              window.location.href = `/lowcode/automation?appId=${APP_ID}`;
              break;
            case 'preview':
              runApplication();
              break;
            case 'settings':
              window.location.href = `/lowcode/settings?appId=${APP_ID}`;
              break;
          }
        });
      });
    }

    // Load app data on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadApplication();
      setupToolCards();
      initSocket();

      // Refresh stats every 30 seconds
      setInterval(loadApplicationStats, 30000);
    });
  </script>
</body>
</html>
