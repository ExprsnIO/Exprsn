<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Designer - Exprsn Low-Code</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: #f5f5f5; }
    .designer { display: flex; flex-direction: column; height: 100vh; }
    .header { background: white; border-bottom: 1px solid #e0e0e0; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
    .header-left { display: flex; align-items: center; gap: 1rem; }
    .back-btn { padding: 0.5rem 1rem; background: #f5f5f5; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; color: #333; }
    .back-btn:hover { background: #e0e0e0; }
    .header-title h1 { font-size: 1.25rem; margin-bottom: 0.25rem; }
    .header-title p { font-size: 0.875rem; color: #666; }
    .header-actions { display: flex; gap: 0.75rem; }
    .btn { padding: 0.625rem 1.25rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; }
    .btn-primary { background: #0078D4; color: white; }
    .btn-primary:hover { background: #106EBE; }
    .btn-secondary { background: #f5f5f5; color: #333; }
    .btn-secondary:hover { background: #e0e0e0; }
    .designer-body { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 320px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; }
    .sidebar-tabs { display: flex; border-bottom: 1px solid #e0e0e0; }
    .tab { flex: 1; padding: 0.875rem; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { border-bottom-color: #0078D4; color: #0078D4; }
    .sidebar-content { flex: 1; overflow-y: auto; padding: 1.5rem; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem; }
    .form-control { width: 100%; padding: 0.625rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.875rem; }
    textarea.form-control { resize: vertical; min-height: 120px; font-family: 'Courier New', monospace; }
    .main-area { flex: 1; display: flex; flex-direction: column; }
    .canvas-tabs { display: flex; background: white; border-bottom: 1px solid #e0e0e0; padding: 0 1.5rem; }
    .canvas-tab { padding: 0.875rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; }
    .canvas-tab.active { border-bottom-color: #0078D4; color: #0078D4; }
    .canvas-content { flex: 1; padding: 2rem; overflow-y: auto; }
    .canvas-panel { display: none; height: 100%; }
    .canvas-panel.active { display: block; }
    .chart-container { background: white; padding: 2rem; border-radius: 8px; height: 500px; }
    .sql-preview { background: #2b2b2b; color: #e0e0e0; padding: 1.5rem; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.875rem; white-space: pre-wrap; }
    .results-table { background: white; border-radius: 8px; overflow: hidden; }
    .results-table table { width: 100%; border-collapse: collapse; }
    .results-table th { background: #f5f5f5; padding: 0.875rem; text-align: left; font-weight: 600; font-size: 0.875rem; border-bottom: 2px solid #e0e0e0; }
    .results-table td { padding: 0.875rem; border-bottom: 1px solid #f0f0f0; font-size: 0.875rem; }
    .results-header { background: white; padding: 1rem 1.5rem; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
    .field-builder { margin-top: 1rem; }
    .field-item { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; align-items: center; }
    .field-item select { flex: 1; }
    .field-item button { padding: 0.5rem; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer; }
    .field-item button:hover { background: #e0e0e0; }
    .add-field-btn { width: 100%; padding: 0.625rem; background: #f5f5f5; border: 1px dashed #ddd; border-radius: 6px; cursor: pointer; margin-top: 0.75rem; }
    .add-field-btn:hover { background: #e8f4f8; border-color: #0078D4; }
    .chart-types { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 1rem; }
    .chart-type { padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .chart-type:hover { border-color: #0078D4; background: #f8f8f8; }
    .chart-type.selected { border-color: #0078D4; background: #e8f4f8; }
    .chart-type i { font-size: 1.5rem; margin-bottom: 0.5rem; color: #666; }
    .chart-type span { display: block; font-size: 0.75rem; font-weight: 500; }
  </style>
</head>
<body>
  <div class="designer">
    <div class="header">
      <div class="header-left">
        <a href="/lowcode/reports?applicationId=<%= applicationId %>" class="back-btn"><i class="fas fa-arrow-left"></i> Back</a>
        <div class="header-title">
          <h1><i class="fas fa-chart-bar"></i> <span id="reportName">New Report</span></h1>
          <p>Design and configure your report</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="designer.testReport()"><i class="fas fa-play"></i> Test</button>
        <button class="btn btn-primary" onclick="designer.saveReport()"><i class="fas fa-save"></i> Save</button>
      </div>
    </div>

    <div class="designer-body">
      <div class="sidebar">
        <div class="sidebar-tabs">
          <div class="tab active" onclick="designer.switchTab('basic')">Basic</div>
          <div class="tab" onclick="designer.switchTab('query')">Query</div>
          <div class="tab" onclick="designer.switchTab('chart')">Chart</div>
        </div>
        <div class="sidebar-content">
          <div id="tab-basic">
            <div class="form-group">
              <label>Report Name</label>
              <input type="text" class="form-control" id="displayName" placeholder="Monthly Sales Report">
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea class="form-control" id="description" placeholder="Describe what this report shows..."></textarea>
            </div>
            <div class="form-group">
              <label>Report Type</label>
              <select class="form-control" id="reportType" onchange="designer.updateReportType()">
                <option value="table">Table</option>
                <option value="chart">Chart</option>
                <option value="pivot">Pivot Table</option>
                <option value="kpi">KPI</option>
              </select>
            </div>
            <div class="form-group">
              <label>Category</label>
              <input type="text" class="form-control" id="category" placeholder="Sales, Finance, Operations...">
            </div>
          </div>

          <div id="tab-query" style="display:none;">
            <div class="form-group">
              <label>Data Source Table</label>
              <input type="text" class="form-control" id="tableName" placeholder="users, orders, products...">
            </div>
            <div class="form-group">
              <label>Fields to Select</label>
              <div class="field-builder" id="fieldsList">
                <div class="field-item">
                  <select class="form-control"><option value="*">All Fields (*)</option></select>
                </div>
              </div>
              <button class="add-field-btn" onclick="designer.addField()"><i class="fas fa-plus"></i> Add Field</button>
            </div>
            <div class="form-group">
              <label>WHERE Filter (Optional)</label>
              <textarea class="form-control" id="whereClause" placeholder="status = 'active' AND created_at > '2024-01-01'"></textarea>
            </div>
            <div class="form-group">
              <label>ORDER BY (Optional)</label>
              <input type="text" class="form-control" id="orderBy" placeholder="created_at DESC">
            </div>
            <div class="form-group">
              <label>LIMIT (Optional)</label>
              <input type="number" class="form-control" id="limitRows" placeholder="100">
            </div>
          </div>

          <div id="tab-chart" style="display:none;">
            <div class="form-group">
              <label>Chart Type</label>
              <div class="chart-types">
                <div class="chart-type selected" data-type="bar" onclick="designer.selectChartType('bar')">
                  <i class="fas fa-chart-bar"></i><span>Bar</span>
                </div>
                <div class="chart-type" data-type="line" onclick="designer.selectChartType('line')">
                  <i class="fas fa-chart-line"></i><span>Line</span>
                </div>
                <div class="chart-type" data-type="pie" onclick="designer.selectChartType('pie')">
                  <i class="fas fa-chart-pie"></i><span>Pie</span>
                </div>
                <div class="chart-type" data-type="doughnut" onclick="designer.selectChartType('doughnut')">
                  <i class="fas fa-circle-notch"></i><span>Doughnut</span>
                </div>
                <div class="chart-type" data-type="area" onclick="designer.selectChartType('area')">
                  <i class="fas fa-chart-area"></i><span>Area</span>
                </div>
                <div class="chart-type" data-type="scatter" onclick="designer.selectChartType('scatter')">
                  <i class="fas fa-braille"></i><span>Scatter</span>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>X-Axis Field</label>
              <input type="text" class="form-control" id="xAxisField" placeholder="category, date, name...">
            </div>
            <div class="form-group">
              <label>Y-Axis Field</label>
              <input type="text" class="form-control" id="yAxisField" placeholder="count, total, amount...">
            </div>
          </div>
        </div>
      </div>

      <div class="main-area">
        <div class="canvas-tabs">
          <div class="canvas-tab active" onclick="designer.switchCanvas('preview')">Preview</div>
          <div class="canvas-tab" onclick="designer.switchCanvas('sql')">SQL Query</div>
          <div class="canvas-tab" onclick="designer.switchCanvas('results')">Results</div>
        </div>
        <div class="canvas-content">
          <div class="canvas-panel active" id="canvas-preview">
            <div class="chart-container">
              <canvas id="previewChart"></canvas>
            </div>
          </div>
          <div class="canvas-panel" id="canvas-sql">
            <pre class="sql-preview" id="sqlPreview">-- Generated SQL will appear here
SELECT * FROM your_table LIMIT 10;</pre>
          </div>
          <div class="canvas-panel" id="canvas-results">
            <div class="results-header">
              <span><strong id="resultCount">0</strong> rows returned</span>
              <span>Execution time: <strong id="execTime">0ms</strong></span>
            </div>
            <div class="results-table">
              <table id="resultsTable">
                <thead><tr><th>No results yet</th></tr></thead>
                <tbody><tr><td>Execute the report to see results</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const applicationId = '<%= applicationId %>';
    const reportId = '<%= reportId %>' !== 'null' ? '<%= reportId %>' : null;

    const designer = {
      currentTab: 'basic',
      currentCanvas: 'preview',
      chartType: 'bar',
      previewChart: null,

      async init() {
        if (reportId) await this.loadReport();
        this.updateSQLPreview();
        this.renderPreviewChart();
      },

      async loadReport() {
        try {
          const res = await fetch(`/lowcode/api/reports/${reportId}`);
          const data = await res.json();
          if (data.success) {
            const r = data.data;
            document.getElementById('reportName').textContent = r.displayName;
            document.getElementById('displayName').value = r.displayName;
            document.getElementById('description').value = r.description || '';
            document.getElementById('reportType').value = r.reportType;
            document.getElementById('category').value = r.category || '';
            if (r.queryConfig?.entities?.[0]) {
              document.getElementById('tableName').value = r.queryConfig.entities[0];
            }
          }
        } catch (error) {
          console.error('Failed to load report:', error);
        }
      },

      switchTab(tab) {
        this.currentTab = tab;
        document.querySelectorAll('.sidebar-tabs .tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('tab-basic').style.display = tab === 'basic' ? 'block' : 'none';
        document.getElementById('tab-query').style.display = tab === 'query' ? 'block' : 'none';
        document.getElementById('tab-chart').style.display = tab === 'chart' ? 'block' : 'none';
      },

      switchCanvas(canvas) {
        this.currentCanvas = canvas;
        document.querySelectorAll('.canvas-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.canvas-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('canvas-' + canvas).classList.add('active');
        if (canvas === 'preview') this.renderPreviewChart();
      },

      updateReportType() {
        const type = document.getElementById('reportType').value;
        if (type === 'chart') {
          this.switchCanvas('preview');
          this.renderPreviewChart();
        }
      },

      addField() {
        const fieldsList = document.getElementById('fieldsList');
        const fieldItem = document.createElement('div');
        fieldItem.className = 'field-item';
        fieldItem.innerHTML = `
          <input type="text" class="form-control" placeholder="field_name">
          <select class="form-control" style="max-width:120px;">
            <option value="">None</option>
            <option value="COUNT">COUNT</option>
            <option value="SUM">SUM</option>
            <option value="AVG">AVG</option>
            <option value="MIN">MIN</option>
            <option value="MAX">MAX</option>
          </select>
          <button onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
        `;
        fieldsList.appendChild(fieldItem);
        this.updateSQLPreview();
      },

      selectChartType(type) {
        this.chartType = type;
        document.querySelectorAll('.chart-type').forEach(ct => ct.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        this.renderPreviewChart();
      },

      updateSQLPreview() {
        const table = document.getElementById('tableName').value || 'your_table';
        const where = document.getElementById('whereClause').value;
        const orderBy = document.getElementById('orderBy').value;
        const limit = document.getElementById('limitRows').value;

        let sql = `SELECT *\nFROM ${table}`;
        if (where) sql += `\nWHERE ${where}`;
        if (orderBy) sql += `\nORDER BY ${orderBy}`;
        if (limit) sql += `\nLIMIT ${limit}`;
        sql += ';';

        document.getElementById('sqlPreview').textContent = sql;
      },

      renderPreviewChart() {
        const canvas = document.getElementById('previewChart');
        if (this.previewChart) this.previewChart.destroy();

        const sampleData = {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          datasets: [{
            label: 'Sample Data',
            data: [12, 19, 3, 5, 2, 3],
            backgroundColor: ['#0078D4', '#00BCF2', '#00B294', '#FFB900', '#D83B01', '#B4009E']
          }]
        };

        this.previewChart = new Chart(canvas, {
          type: this.chartType,
          data: sampleData,
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: true } }
          }
        });
      },

      async testReport() {
        const table = document.getElementById('tableName').value;
        if (!table) return alert('Please specify a table name');

        const queryConfig = {
          entities: [table],
          fields: [{ column: '*' }],
          filters: [],
          orderBy: [],
          limit: parseInt(document.getElementById('limitRows').value) || 100
        };

        const where = document.getElementById('whereClause').value;
        if (where) {
          queryConfig.filters.push({ column: where, operator: '', value: '' });
        }

        try {
          const res = await fetch(`/lowcode/api/reports${reportId ? '/' + reportId : ''}`, {
            method: reportId ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              displayName: document.getElementById('displayName').value || 'Test Report',
              applicationId,
              reportType: 'table',
              queryConfig,
              status: 'draft'
            })
          });

          const data = await res.json();
          if (data.success) {
            const execRes = await fetch(`/lowcode/api/reports/${data.data.id}/execute`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ parameterValues: {} })
            });

            const execData = await execRes.json();
            if (execData.success) {
              this.displayResults(execData.data, execData.metadata);
              this.switchCanvas('results');
            }
          }
        } catch (error) {
          alert('Error executing report: ' + error.message);
        }
      },

      displayResults(data, metadata) {
        document.getElementById('resultCount').textContent = metadata.rowCount;
        document.getElementById('execTime').textContent = metadata.executionTime + 'ms';

        const table = document.getElementById('resultsTable');
        if (data.length === 0) {
          table.innerHTML = '<thead><tr><th>No Results</th></tr></thead><tbody><tr><td>Query returned no rows</td></tr></tbody>';
          return;
        }

        const columns = Object.keys(data[0]);
        const thead = '<tr>' + columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
        const tbody = data.slice(0, 100).map(row =>
          '<tr>' + columns.map(col => `<td>${row[col] ?? ''}</td>`).join('') + '</tr>'
        ).join('');

        table.innerHTML = `<thead>${thead}</thead><tbody>${tbody}</tbody>`;
      },

      async saveReport() {
        const displayName = document.getElementById('displayName').value;
        if (!displayName) return alert('Please enter a report name');

        const table = document.getElementById('tableName').value || 'your_table';
        const queryConfig = {
          entities: [table],
          fields: [{ column: '*' }],
          filters: [],
          orderBy: []
        };

        const payload = {
          displayName,
          description: document.getElementById('description').value,
          applicationId,
          reportType: document.getElementById('reportType').value,
          category: document.getElementById('category').value,
          queryConfig,
          visualizationConfig: {
            chartType: this.chartType,
            xAxis: document.getElementById('xAxisField').value,
            yAxis: document.getElementById('yAxisField').value
          },
          status: 'draft'
        };

        try {
          const url = reportId ? `/lowcode/api/reports/${reportId}` : '/lowcode/api/reports';
          const res = await fetch(url, {
            method: reportId ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          if (data.success) {
            alert('Report saved successfully!');
            window.location.href = `/lowcode/reports?applicationId=${applicationId}`;
          } else {
            alert('Error: ' + data.message);
          }
        } catch (error) {
          alert('Error saving report: ' + error.message);
        }
      }
    };

    designer.init();
  </script>
</body>
</html>
