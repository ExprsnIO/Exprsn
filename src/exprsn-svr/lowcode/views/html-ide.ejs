<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Full-Featured IDE</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Monaco Editor -->
  <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css">

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>

  <!-- Xterm.js for terminal -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net.npm/xterm@5.3.0/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      overflow: hidden;
      height: 100vh;
      background: #1e1e1e;
      color: #d4d4d4;
    }

    /* Top Menu Bar - VS Code Style */
    .menu-bar {
      height: 35px;
      background: #323233;
      display: flex;
      align-items: center;
      padding: 0 10px;
      border-bottom: 1px solid #454545;
      color: #cccccc;
      font-size: 13px;
    }

    .menu-item {
      padding: 4px 12px;
      cursor: pointer;
      border-radius: 3px;
    }

    .menu-item:hover {
      background: #505050;
    }

    /* Toolbar - Activity Bar + Title Bar */
    .top-toolbar {
      height: 50px;
      background: #2d2d30;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      border-bottom: 1px solid #454545;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .project-name {
      color: #cccccc;
      font-size: 14px;
      font-weight: 600;
    }

    .toolbar-actions {
      display: flex;
      gap: 8px;
    }

    .toolbar-btn {
      background: #0e639c;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }

    .toolbar-btn:hover {
      background: #1177bb;
    }

    .toolbar-btn.success {
      background: #107c10;
    }

    .toolbar-btn.success:hover {
      background: #0d6b0d;
    }

    /* Main Layout */
    .ide-container {
      display: flex;
      height: calc(100vh - 85px);
    }

    /* Activity Bar (Left icons) */
    .activity-bar {
      width: 50px;
      background: #333333;
      border-right: 1px solid #454545;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10px;
    }

    .activity-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #858585;
      font-size: 24px;
      position: relative;
      margin-bottom: 5px;
    }

    .activity-icon:hover {
      color: #ffffff;
    }

    .activity-icon.active {
      color: #ffffff;
    }

    .activity-icon.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #0078d4;
    }

    /* Sidebar (File Explorer, Components, etc.) */
    .sidebar {
      width: 300px;
      background: #252526;
      border-right: 1px solid #454545;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar.collapsed {
      display: none;
    }

    .sidebar-header {
      padding: 10px 15px;
      background: #2d2d30;
      border-bottom: 1px solid #454545;
      font-size: 11px;
      text-transform: uppercase;
      color: #cccccc;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    /* File Tree */
    .file-tree {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .file-item {
      padding: 4px 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #cccccc;
      font-size: 13px;
      border-radius: 3px;
      user-select: none;
    }

    .file-item:hover {
      background: #2a2d2e;
    }

    .file-item.active {
      background: #37373d;
    }

    .file-item i {
      width: 16px;
      font-size: 14px;
    }

    .file-icon {
      color: #519aba;
    }

    .folder-icon {
      color: #dcb67a;
    }

    /* Component Palette */
    .component-section {
      margin-bottom: 20px;
    }

    .component-section-title {
      font-size: 11px;
      text-transform: uppercase;
      color: #858585;
      margin-bottom: 8px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .component-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }

    .component-item {
      background: #2d2d30;
      border: 1px solid #3e3e42;
      padding: 8px;
      border-radius: 4px;
      cursor: grab;
      text-align: center;
      transition: all 0.2s;
      font-size: 11px;
    }

    .component-item:hover {
      background: #37373d;
      border-color: #0078d4;
    }

    .component-item:active {
      cursor: grabbing;
    }

    .component-item i {
      display: block;
      font-size: 20px;
      margin-bottom: 4px;
      color: #0078d4;
    }

    /* Editor Area */
    .editor-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #1e1e1e;
    }

    /* Tabs */
    .editor-tabs {
      display: flex;
      background: #2d2d30;
      border-bottom: 1px solid #454545;
      overflow-x: auto;
      min-height: 35px;
    }

    .editor-tab {
      padding: 8px 12px;
      background: #2d2d30;
      border-right: 1px solid #454545;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #969696;
      white-space: nowrap;
      min-width: 100px;
      position: relative;
    }

    .editor-tab.active {
      background: #1e1e1e;
      color: #ffffff;
    }

    .editor-tab:hover {
      color: #ffffff;
    }

    .tab-close {
      margin-left: auto;
      padding: 2px 4px;
      border-radius: 3px;
      opacity: 0.6;
    }

    .tab-close:hover {
      background: #505050;
      opacity: 1;
    }

    /* Monaco Editor Container */
    .monaco-container {
      flex: 1;
      position: relative;
    }

    #monaco-editor {
      height: 100%;
      width: 100%;
    }

    /* Split Panel - Editor + Preview/Terminal */
    .split-panel {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .panel-divider {
      height: 4px;
      background: #2d2d30;
      cursor: row-resize;
      border-top: 1px solid #454545;
      border-bottom: 1px solid #454545;
    }

    .panel-divider:hover {
      background: #0078d4;
    }

    /* Bottom Panel (Terminal, Problems, Output) */
    .bottom-panel {
      height: 200px;
      background: #1e1e1e;
      border-top: 1px solid #454545;
      display: flex;
      flex-direction: column;
    }

    .bottom-panel.hidden {
      display: none;
    }

    .panel-tabs {
      display: flex;
      background: #2d2d30;
      border-bottom: 1px solid #454545;
      padding: 0 10px;
    }

    .panel-tab {
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      color: #969696;
      border-bottom: 2px solid transparent;
    }

    .panel-tab.active {
      color: #ffffff;
      border-bottom-color: #0078d4;
    }

    .panel-tab:hover {
      color: #ffffff;
    }

    .panel-content {
      flex: 1;
      overflow: auto;
      padding: 10px;
    }

    #terminal-container {
      height: 100%;
      padding: 5px;
    }

    /* Preview Panel */
    #preview-frame {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }

    /* Right Panel - Properties/Settings */
    .right-panel {
      width: 320px;
      background: #252526;
      border-left: 1px solid #454545;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .right-panel.hidden {
      display: none;
    }

    .properties-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .property-group {
      margin-bottom: 20px;
    }

    .property-label {
      font-size: 12px;
      color: #cccccc;
      margin-bottom: 5px;
      display: block;
    }

    .property-input {
      width: 100%;
      background: #3c3c3c;
      border: 1px solid #454545;
      color: #cccccc;
      padding: 6px 8px;
      border-radius: 3px;
      font-size: 13px;
    }

    .property-input:focus {
      outline: none;
      border-color: #0078d4;
    }

    .property-select {
      width: 100%;
      background: #3c3c3c;
      border: 1px solid #454545;
      color: #cccccc;
      padding: 6px 8px;
      border-radius: 3px;
      font-size: 13px;
    }

    /* Library Manager */
    .library-list {
      list-style: none;
      padding: 0;
    }

    .library-item {
      background: #2d2d30;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      border-left: 3px solid #0078d4;
    }

    .library-name {
      font-weight: 600;
      font-size: 13px;
      color: #cccccc;
    }

    .library-version {
      font-size: 11px;
      color: #858585;
      margin-top: 2px;
    }

    /* Status Bar */
    .status-bar {
      height: 22px;
      background: #0078d4;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      font-size: 12px;
      color: white;
    }

    .status-left, .status-right {
      display: flex;
      gap: 15px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    ::-webkit-scrollbar-thumb {
      background: #424242;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #4e4e4e;
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: #3c3c3c;
      border: 1px solid #454545;
      border-radius: 4px;
      padding: 4px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 10000;
      display: none;
    }

    .context-menu-item {
      padding: 6px 20px;
      cursor: pointer;
      font-size: 13px;
      color: #cccccc;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .context-menu-item:hover {
      background: #094771;
    }

    .context-menu-item i {
      width: 16px;
    }

    /* Notification Toast */
    .notification-toast {
      position: fixed;
      top: 50px;
      right: 20px;
      background: #3c3c3c;
      border: 1px solid #454545;
      border-radius: 4px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 300px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification-icon {
      font-size: 20px;
    }

    .notification-icon.success {
      color: #4ec9b0;
    }

    .notification-icon.error {
      color: #f48771;
    }

    .notification-icon.info {
      color: #0078d4;
    }

    .notification-message {
      flex: 1;
      font-size: 13px;
      color: #cccccc;
    }

    /* Loading Spinner */
    .loading-spinner {
      border: 3px solid #454545;
      border-top: 3px solid #0078d4;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- Menu Bar -->
  <div class="menu-bar">
    <div class="menu-item">File</div>
    <div class="menu-item">Edit</div>
    <div class="menu-item">View</div>
    <div class="menu-item">Run</div>
    <div class="menu-item">Terminal</div>
    <div class="menu-item">Help</div>
  </div>

  <!-- Top Toolbar -->
  <div class="top-toolbar">
    <div class="toolbar-left">
      <div class="project-name">
        <i class="fas fa-folder-open"></i>
        <span id="project-name-display">Loading...</span>
      </div>
    </div>
    <div class="toolbar-actions">
      <button class="toolbar-btn" onclick="saveCurrentFile()">
        <i class="fas fa-save"></i> Save
      </button>
      <button class="toolbar-btn" onclick="togglePreview()">
        <i class="fas fa-eye"></i> Preview
      </button>
      <button class="toolbar-btn success" onclick="runProject()">
        <i class="fas fa-play"></i> Run
      </button>
    </div>
  </div>

  <!-- Main IDE Container -->
  <div class="ide-container">
    <!-- Activity Bar -->
    <div class="activity-bar">
      <div class="activity-icon active" data-panel="explorer" onclick="switchPanel('explorer')" title="Explorer">
        <i class="far fa-folder"></i>
      </div>
      <div class="activity-icon" data-panel="components" onclick="switchPanel('components')" title="Components">
        <i class="fas fa-cubes"></i>
      </div>
      <div class="activity-icon" data-panel="libraries" onclick="switchPanel('libraries')" title="Libraries">
        <i class="fas fa-book"></i>
      </div>
      <div class="activity-icon" data-panel="search" onclick="switchPanel('search')" title="Search">
        <i class="fas fa-search"></i>
      </div>
      <div class="activity-icon" data-panel="git" onclick="switchPanel('git')" title="Source Control">
        <i class="fas fa-code-branch"></i>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <!-- Explorer Panel -->
      <div class="sidebar-panel" id="panel-explorer">
        <div class="sidebar-header">
          EXPLORER
          <i class="fas fa-plus float-end" onclick="createNewFile()" title="New File" style="cursor: pointer;"></i>
        </div>
        <div class="sidebar-content">
          <ul class="file-tree" id="file-tree">
            <!-- Files will be loaded here -->
          </ul>
        </div>
      </div>

      <!-- Components Panel -->
      <div class="sidebar-panel" id="panel-components" style="display: none;">
        <div class="sidebar-header">COMPONENTS</div>
        <div class="sidebar-content">
          <!-- Basic Components -->
          <div class="component-section">
            <div class="component-section-title">Basic Components (13)</div>
            <div class="component-grid">
              <div class="component-item" draggable="true" data-component="textinput">
                <i class="fas fa-keyboard"></i>
                Text Input
              </div>
              <div class="component-item" draggable="true" data-component="email">
                <i class="fas fa-envelope"></i>
                Email
              </div>
              <div class="component-item" draggable="true" data-component="number">
                <i class="fas fa-hashtag"></i>
                Number
              </div>
              <div class="component-item" draggable="true" data-component="textarea">
                <i class="fas fa-align-left"></i>
                Text Area
              </div>
              <div class="component-item" draggable="true" data-component="date">
                <i class="fas fa-calendar"></i>
                Date
              </div>
              <div class="component-item" draggable="true" data-component="checkbox">
                <i class="fas fa-check-square"></i>
                Checkbox
              </div>
              <div class="component-item" draggable="true" data-component="dropdown">
                <i class="fas fa-caret-down"></i>
                Dropdown
              </div>
              <div class="component-item" draggable="true" data-component="radio">
                <i class="fas fa-dot-circle"></i>
                Radio Group
              </div>
              <div class="component-item" draggable="true" data-component="button">
                <i class="fas fa-hand-pointer"></i>
                Button
              </div>
              <div class="component-item" draggable="true" data-component="fileupload">
                <i class="fas fa-upload"></i>
                File Upload
              </div>
              <div class="component-item" draggable="true" data-component="label">
                <i class="fas fa-tag"></i>
                Label
              </div>
              <div class="component-item" draggable="true" data-component="heading">
                <i class="fas fa-heading"></i>
                Heading
              </div>
              <div class="component-item" draggable="true" data-component="paragraph">
                <i class="fas fa-paragraph"></i>
                Paragraph
              </div>
            </div>
          </div>

          <!-- Layout Components -->
          <div class="component-section">
            <div class="component-section-title">Layout Components (5)</div>
            <div class="component-grid">
              <div class="component-item" draggable="true" data-component="divider">
                <i class="fas fa-minus"></i>
                Divider
              </div>
              <div class="component-item" draggable="true" data-component="spacer">
                <i class="fas fa-arrows-alt-v"></i>
                Spacer
              </div>
              <div class="component-item" draggable="true" data-component="container">
                <i class="fas fa-box"></i>
                Container
              </div>
              <div class="component-item" draggable="true" data-component="tabs">
                <i class="fas fa-folder-open"></i>
                Tabs
              </div>
              <div class="component-item" draggable="true" data-component="accordion">
                <i class="fas fa-bars"></i>
                Accordion
              </div>
            </div>
          </div>

          <!-- Data Components -->
          <div class="component-section">
            <div class="component-section-title">Data Components (4)</div>
            <div class="component-grid">
              <div class="component-item" draggable="true" data-component="entitypicker">
                <i class="fas fa-database"></i>
                Entity Picker
              </div>
              <div class="component-item" draggable="true" data-component="crud">
                <i class="fas fa-table"></i>
                CRUD Interface
              </div>
              <div class="component-item" draggable="true" data-component="subgrid">
                <i class="fas fa-th"></i>
                Subgrid
              </div>
              <div class="component-item" draggable="true" data-component="optionslist">
                <i class="fas fa-list"></i>
                Options List
              </div>
            </div>
          </div>

          <!-- HTML Elements -->
          <div class="component-section">
            <div class="component-section-title">HTML Elements</div>
            <div class="component-grid">
              <div class="component-item" draggable="true" data-component="div">
                <i class="fas fa-square"></i>
                Div
              </div>
              <div class="component-item" draggable="true" data-component="span">
                <i class="fas fa-font"></i>
                Span
              </div>
              <div class="component-item" draggable="true" data-component="img">
                <i class="fas fa-image"></i>
                Image
              </div>
              <div class="component-item" draggable="true" data-component="link">
                <i class="fas fa-link"></i>
                Link
              </div>
              <div class="component-item" draggable="true" data-component="table">
                <i class="fas fa-table"></i>
                Table
              </div>
              <div class="component-item" draggable="true" data-component="ul">
                <i class="fas fa-list-ul"></i>
                List
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Libraries Panel -->
      <div class="sidebar-panel" id="panel-libraries" style="display: none;">
        <div class="sidebar-header">
          LIBRARIES
          <i class="fas fa-plus float-end" onclick="addLibrary()" title="Add Library" style="cursor: pointer;"></i>
        </div>
        <div class="sidebar-content">
          <ul class="library-list" id="library-list">
            <!-- Libraries will be loaded here -->
          </ul>
        </div>
      </div>

      <!-- Search Panel -->
      <div class="sidebar-panel" id="panel-search" style="display: none;">
        <div class="sidebar-header">SEARCH</div>
        <div class="sidebar-content">
          <input type="text" class="property-input" placeholder="Search in files..." id="search-input">
          <div id="search-results" style="margin-top: 10px;"></div>
        </div>
      </div>

      <!-- Git Panel -->
      <div class="sidebar-panel" id="panel-git" style="display: none;">
        <div class="sidebar-header">SOURCE CONTROL</div>
        <div class="sidebar-content">
          <p style="color: #858585; font-size: 12px;">Git integration coming soon...</p>
        </div>
      </div>
    </div>

    <!-- Editor Area -->
    <div class="editor-area">
      <div class="split-panel">
        <!-- Editor Tabs -->
        <div class="editor-tabs" id="editor-tabs">
          <div class="editor-tab active" data-file-id="welcome">
            <i class="fas fa-file"></i>
            <span>Welcome</span>
            <span class="tab-close" onclick="closeTab('welcome', event)">
              <i class="fas fa-times"></i>
            </span>
          </div>
        </div>

        <!-- Monaco Editor -->
        <div class="monaco-container">
          <div id="monaco-editor"></div>
        </div>

        <!-- Panel Divider -->
        <div class="panel-divider" id="panel-divider"></div>

        <!-- Bottom Panel -->
        <div class="bottom-panel" id="bottom-panel">
          <div class="panel-tabs">
            <div class="panel-tab active" data-tab="terminal" onclick="switchBottomTab('terminal')">
              <i class="fas fa-terminal"></i> Terminal
            </div>
            <div class="panel-tab" data-tab="preview" onclick="switchBottomTab('preview')">
              <i class="fas fa-eye"></i> Preview
            </div>
            <div class="panel-tab" data-tab="problems" onclick="switchBottomTab('problems')">
              <i class="fas fa-exclamation-triangle"></i> Problems
            </div>
            <div class="panel-tab" data-tab="output" onclick="switchBottomTab('output')">
              <i class="fas fa-list-alt"></i> Output
            </div>
            <div style="margin-left: auto; padding: 6px 12px; cursor: pointer;" onclick="toggleBottomPanel()">
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
          <div class="panel-content">
            <div class="panel-tab-content" id="tab-terminal">
              <div id="terminal-container"></div>
            </div>
            <div class="panel-tab-content" id="tab-preview" style="display: none; height: 100%;">
              <iframe id="preview-frame"></iframe>
            </div>
            <div class="panel-tab-content" id="tab-problems" style="display: none;">
              <p style="color: #858585; font-size: 12px;">No problems detected</p>
            </div>
            <div class="panel-tab-content" id="tab-output" style="display: none;">
              <pre id="output-content" style="color: #cccccc; font-size: 12px; font-family: 'Courier New', monospace;"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Properties -->
    <div class="right-panel hidden" id="right-panel">
      <div class="sidebar-header">
        PROPERTIES
        <i class="fas fa-times float-end" onclick="toggleRightPanel()" style="cursor: pointer;"></i>
      </div>
      <div class="properties-content" id="properties-content">
        <div class="property-group">
          <label class="property-label">File Name</label>
          <input type="text" class="property-input" id="prop-filename" value="">
        </div>
        <div class="property-group">
          <label class="property-label">Language</label>
          <select class="property-select" id="prop-language">
            <option value="html">HTML</option>
            <option value="css">CSS</option>
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
            <option value="sql">SQL</option>
            <option value="json">JSON</option>
            <option value="markdown">Markdown</option>
          </select>
        </div>
        <div class="property-group">
          <label class="property-label">Encoding</label>
          <select class="property-select">
            <option>UTF-8</option>
            <option>UTF-16</option>
            <option>ASCII</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <div class="status-left">
      <div class="status-item">
        <i class="fas fa-code-branch"></i>
        <span>main</span>
      </div>
      <div class="status-item" id="status-file">
        <i class="fas fa-file"></i>
        <span>Welcome</span>
      </div>
    </div>
    <div class="status-right">
      <div class="status-item" id="status-language">
        <span>Plain Text</span>
      </div>
      <div class="status-item" id="status-position">
        <span>Ln 1, Col 1</span>
      </div>
      <div class="status-item" id="status-encoding">
        <span>UTF-8</span>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="context-menu">
    <div class="context-menu-item" onclick="handleContextAction('new')">
      <i class="fas fa-file"></i> New File
    </div>
    <div class="context-menu-item" onclick="handleContextAction('rename')">
      <i class="fas fa-edit"></i> Rename
    </div>
    <div class="context-menu-item" onclick="handleContextAction('delete')">
      <i class="fas fa-trash"></i> Delete
    </div>
    <div class="context-menu-item" onclick="handleContextAction('copy')">
      <i class="fas fa-copy"></i> Copy Path
    </div>
  </div>

  <!-- Monaco Loader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

  <script>
    // Global State
    let projectId = '<%= projectId %>';
    let currentFile = null;
    let openFiles = new Map();
    let monacoEditor = null;
    let terminal = null;
    let socket = null;

    // Initialize Monaco Editor
    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });

    require(['vs/editor/editor.main'], function () {
      monacoEditor = monaco.editor.create(document.getElementById('monaco-editor'), {
        value: getWelcomeContent(),
        language: 'markdown',
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 14,
        minimap: { enabled: true },
        scrollBeyondLastLine: false,
        wordWrap: 'on',
        lineNumbers: 'on',
        renderWhitespace: 'selection',
        bracketPairColorization: { enabled: true },
        guides: {
          indentation: true,
          bracketPairs: true
        }
      });

      // Track cursor position
      monacoEditor.onDidChangeCursorPosition((e) => {
        document.getElementById('status-position').innerHTML =
          `<span>Ln ${e.position.lineNumber}, Col ${e.position.column}</span>`;
      });

      // Track content changes
      monacoEditor.onDidChangeModelContent(() => {
        if (currentFile) {
          markFileAsModified(currentFile.id);
        }
      });

      // Load project
      loadProject();
    });

    // Initialize Terminal
    terminal = new Terminal({
      cursorBlink: true,
      fontSize: 13,
      fontFamily: 'Courier New, monospace',
      theme: {
        background: '#1e1e1e',
        foreground: '#d4d4d4'
      }
    });
    terminal.open(document.getElementById('terminal-container'));
    terminal.writeln('Welcome to Exprsn HTML IDE Terminal');
    terminal.writeln('Type "help" for available commands');
    terminal.write('$ ');

    // Terminal input handling
    let terminalInput = '';
    terminal.onData((data) => {
      if (data === '\r') {
        terminal.writeln('');
        handleTerminalCommand(terminalInput);
        terminalInput = '';
        terminal.write('$ ');
      } else if (data === '\u007F') {
        if (terminalInput.length > 0) {
          terminalInput = terminalInput.slice(0, -1);
          terminal.write('\b \b');
        }
      } else {
        terminalInput += data;
        terminal.write(data);
      }
    });

    // Initialize Socket.IO for collaboration
    socket = io({
      path: '/socket.io',
      transports: ['websocket', 'polling']
    });

    socket.on('connect', () => {
      console.log('Connected to collaboration server');
      socket.emit('join-project', { projectId });
    });

    socket.on('file-updated', (data) => {
      showNotification('File updated by another user', 'info');
      if (data.fileId === currentFile?.id) {
        loadFile(data.fileId);
      }
    });

    // Load Project
    async function loadProject() {
      try {
        const response = await fetch(`/lowcode/api/html-projects/${projectId}`);
        const result = await response.json();

        if (result.success) {
          document.getElementById('project-name-display').textContent = result.project.name;
          loadFileTree();
          loadLibraries();
        }
      } catch (error) {
        console.error('Failed to load project:', error);
        showNotification('Failed to load project', 'error');
      }
    }

    // Load File Tree
    async function loadFileTree() {
      try {
        const response = await fetch(`/lowcode/api/html-projects/${projectId}/files`);
        const result = await response.json();

        if (result.success) {
          renderFileTree(result.files);
        }
      } catch (error) {
        console.error('Failed to load files:', error);
      }
    }

    // Render File Tree
    function renderFileTree(files) {
      const tree = document.getElementById('file-tree');
      tree.innerHTML = '';

      // Build hierarchical structure
      const rootFiles = files.filter(f => !f.parentId);

      rootFiles.forEach(file => {
        const li = createFileItem(file, files);
        tree.appendChild(li);
      });
    }

    // Create File Item
    function createFileItem(file, allFiles) {
      const li = document.createElement('li');

      const item = document.createElement('div');
      item.className = 'file-item';
      item.dataset.fileId = file.id;

      const icon = file.type === 'folder' ? 'fa-folder' : getFileIcon(file.type);
      const iconClass = file.type === 'folder' ? 'folder-icon' : 'file-icon';

      item.innerHTML = `
        <i class="fas ${icon} ${iconClass}"></i>
        <span>${file.name}</span>
      `;

      if (file.type !== 'folder') {
        item.onclick = () => openFile(file);
      }

      // Right-click context menu
      item.oncontextmenu = (e) => {
        e.preventDefault();
        showContextMenu(e.pageX, e.pageY, file);
      };

      li.appendChild(item);

      // Add children if folder
      if (file.type === 'folder') {
        const children = allFiles.filter(f => f.parentId === file.id);
        if (children.length > 0) {
          const ul = document.createElement('ul');
          ul.className = 'file-tree';
          ul.style.marginLeft = '16px';
          children.forEach(child => {
            ul.appendChild(createFileItem(child, allFiles));
          });
          li.appendChild(ul);
        }
      }

      return li;
    }

    // Get File Icon
    function getFileIcon(type) {
      const icons = {
        html: 'fa-file-code',
        css: 'fa-file-code',
        javascript: 'fa-file-code',
        json: 'fa-file-code',
        image: 'fa-file-image',
        font: 'fa-font',
        other: 'fa-file'
      };
      return icons[type] || 'fa-file';
    }

    // Open File
    async function openFile(file) {
      try {
        // Check if already open
        if (openFiles.has(file.id)) {
          switchToTab(file.id);
          return;
        }

        // Fetch file content
        const response = await fetch(`/lowcode/api/html-files/${file.id}`);
        const result = await response.json();

        if (result.success) {
          const fileData = result.file;

          // Add to open files
          openFiles.set(file.id, {
            id: file.id,
            name: file.name,
            type: file.type,
            content: fileData.content || '',
            modified: false
          });

          // Create tab
          createTab(file);

          // Switch to this file
          switchToTab(file.id);

          // Update editor
          const language = getMonacoLanguage(file.type);
          monaco.editor.setModelLanguage(monacoEditor.getModel(), language);
          monacoEditor.setValue(fileData.content || '');

          currentFile = openFiles.get(file.id);

          // Update status bar
          updateStatusBar(file);
        }
      } catch (error) {
        console.error('Failed to open file:', error);
        showNotification('Failed to open file', 'error');
      }
    }

    // Get Monaco Language
    function getMonacoLanguage(fileType) {
      const languages = {
        html: 'html',
        css: 'css',
        javascript: 'javascript',
        json: 'json',
        python: 'python',
        sql: 'sql'
      };
      return languages[fileType] || 'plaintext';
    }

    // Create Tab
    function createTab(file) {
      const tabsContainer = document.getElementById('editor-tabs');

      const tab = document.createElement('div');
      tab.className = 'editor-tab';
      tab.dataset.fileId = file.id;
      tab.innerHTML = `
        <i class="fas ${getFileIcon(file.type)}"></i>
        <span>${file.name}</span>
        <span class="tab-close" onclick="closeTab('${file.id}', event)">
          <i class="fas fa-times"></i>
        </span>
      `;

      tab.onclick = () => switchToTab(file.id);

      tabsContainer.appendChild(tab);
    }

    // Switch to Tab
    function switchToTab(fileId) {
      // Update tab active state
      document.querySelectorAll('.editor-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.fileId === fileId);
      });

      // Update file tree active state
      document.querySelectorAll('.file-item').forEach(item => {
        item.classList.toggle('active', item.dataset.fileId === fileId);
      });

      // Load file content
      const file = openFiles.get(fileId);
      if (file) {
        currentFile = file;
        monacoEditor.setValue(file.content);
        monaco.editor.setModelLanguage(monacoEditor.getModel(), getMonacoLanguage(file.type));
        updateStatusBar(file);
      }
    }

    // Close Tab
    function closeTab(fileId, event) {
      if (event) event.stopPropagation();

      const file = openFiles.get(fileId);
      if (file && file.modified) {
        if (!confirm(`Save changes to ${file.name}?`)) {
          return;
        }
        saveFile(fileId);
      }

      // Remove from open files
      openFiles.delete(fileId);

      // Remove tab
      const tab = document.querySelector(`[data-file-id="${fileId}"]`);
      if (tab) tab.remove();

      // Switch to another tab if this was active
      if (currentFile && currentFile.id === fileId) {
        if (openFiles.size > 0) {
          const firstFileId = openFiles.keys().next().value;
          switchToTab(firstFileId);
        } else {
          currentFile = null;
          monacoEditor.setValue(getWelcomeContent());
        }
      }
    }

    // Save Current File
    async function saveCurrentFile() {
      if (!currentFile) {
        showNotification('No file open', 'info');
        return;
      }

      await saveFile(currentFile.id);
    }

    // Save File
    async function saveFile(fileId) {
      try {
        const file = openFiles.get(fileId);
        if (!file) return;

        const content = monacoEditor.getValue();

        const response = await fetch(`/lowcode/api/html-files/${fileId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });

        const result = await response.json();

        if (result.success) {
          file.content = content;
          file.modified = false;
          updateTabModifiedState(fileId, false);
          showNotification('File saved successfully', 'success');

          // Notify other users via Socket.IO
          socket.emit('file-updated', { projectId, fileId });
        }
      } catch (error) {
        console.error('Failed to save file:', error);
        showNotification('Failed to save file', 'error');
      }
    }

    // Mark File as Modified
    function markFileAsModified(fileId) {
      const file = openFiles.get(fileId);
      if (file && !file.modified) {
        file.modified = true;
        file.content = monacoEditor.getValue();
        updateTabModifiedState(fileId, true);
      }
    }

    // Update Tab Modified State
    function updateTabModifiedState(fileId, modified) {
      const tab = document.querySelector(`.editor-tab[data-file-id="${fileId}"]`);
      if (tab) {
        const nameSpan = tab.querySelector('span:first-of-type');
        if (modified && !nameSpan.textContent.startsWith('‚óè')) {
          nameSpan.textContent = '‚óè ' + nameSpan.textContent;
        } else if (!modified && nameSpan.textContent.startsWith('‚óè')) {
          nameSpan.textContent = nameSpan.textContent.replace('‚óè ', '');
        }
      }
    }

    // Update Status Bar
    function updateStatusBar(file) {
      document.getElementById('status-file').innerHTML =
        `<i class="fas fa-file"></i><span>${file.name}</span>`;
      document.getElementById('status-language').innerHTML =
        `<span>${getLanguageName(file.type)}</span>`;
    }

    // Get Language Name
    function getLanguageName(type) {
      const names = {
        html: 'HTML',
        css: 'CSS',
        javascript: 'JavaScript',
        json: 'JSON',
        python: 'Python',
        sql: 'SQL'
      };
      return names[type] || 'Plain Text';
    }

    // Load Libraries
    async function loadLibraries() {
      try {
        const response = await fetch(`/lowcode/api/html-projects/${projectId}/libraries`);
        const result = await response.json();

        if (result.success) {
          renderLibraries(result.libraries);
        }
      } catch (error) {
        console.error('Failed to load libraries:', error);
      }
    }

    // Render Libraries
    function renderLibraries(libraries) {
      const list = document.getElementById('library-list');
      list.innerHTML = '';

      libraries.forEach(lib => {
        const li = document.createElement('li');
        li.className = 'library-item';
        li.innerHTML = `
          <div class="library-name">${lib.name}</div>
          <div class="library-version">v${lib.version}</div>
        `;
        list.appendChild(li);
      });
    }

    // Switch Panel
    function switchPanel(panelName) {
      // Update activity bar
      document.querySelectorAll('.activity-icon').forEach(icon => {
        icon.classList.toggle('active', icon.dataset.panel === panelName);
      });

      // Update sidebar panels
      document.querySelectorAll('.sidebar-panel').forEach(panel => {
        panel.style.display = panel.id === `panel-${panelName}` ? 'flex' : 'none';
      });
    }

    // Switch Bottom Tab
    function switchBottomTab(tabName) {
      // Update tabs
      document.querySelectorAll('.panel-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      // Update content
      document.querySelectorAll('.panel-tab-content').forEach(content => {
        content.style.display = content.id === `tab-${tabName}` ? 'block' : 'none';
      });

      // Adjust heights for iframe
      if (tabName === 'preview') {
        document.getElementById('tab-preview').style.height = '100%';
      }
    }

    // Toggle Bottom Panel
    function toggleBottomPanel() {
      const panel = document.getElementById('bottom-panel');
      panel.classList.toggle('hidden');
    }

    // Toggle Preview
    function togglePreview() {
      switchBottomTab('preview');
      const panel = document.getElementById('bottom-panel');
      panel.classList.remove('hidden');
      updatePreview();
    }

    // Update Preview
    function updatePreview() {
      const iframe = document.getElementById('preview-frame');

      // Get current HTML content
      let content = monacoEditor.getValue();

      // If current file is not HTML, try to find index.html
      if (currentFile && currentFile.type !== 'html') {
        // Load the entry point file
        fetch(`/lowcode/api/html-projects/${projectId}/preview`)
          .then(res => res.text())
          .then(html => {
            iframe.srcdoc = html;
          });
      } else {
        iframe.srcdoc = content;
      }
    }

    // Run Project
    function runProject() {
      window.open(`/lowcode/api/html-projects/${projectId}/preview`, '_blank');
    }

    // Toggle Right Panel
    function toggleRightPanel() {
      document.getElementById('right-panel').classList.toggle('hidden');
    }

    // Create New File
    async function createNewFile() {
      const fileName = prompt('Enter file name:');
      if (!fileName) return;

      try {
        const response = await fetch(`/lowcode/api/html-projects/${projectId}/files`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: fileName,
            type: detectFileType(fileName),
            content: ''
          })
        });

        const result = await response.json();

        if (result.success) {
          showNotification('File created successfully', 'success');
          loadFileTree();
        }
      } catch (error) {
        console.error('Failed to create file:', error);
        showNotification('Failed to create file', 'error');
      }
    }

    // Detect File Type
    function detectFileType(fileName) {
      const ext = fileName.split('.').pop().toLowerCase();
      const types = {
        'html': 'html',
        'htm': 'html',
        'css': 'css',
        'js': 'javascript',
        'json': 'json',
        'py': 'python',
        'sql': 'sql'
      };
      return types[ext] || 'other';
    }

    // Show Context Menu
    function showContextMenu(x, y, file) {
      const menu = document.getElementById('context-menu');
      menu.style.display = 'block';
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.dataset.fileId = file.id;
    }

    // Hide context menu on click outside
    document.addEventListener('click', () => {
      document.getElementById('context-menu').style.display = 'none';
    });

    // Handle Context Menu Actions
    function handleContextAction(action) {
      const menu = document.getElementById('context-menu');
      const fileId = menu.dataset.fileId;

      switch (action) {
        case 'new':
          createNewFile();
          break;
        case 'rename':
          // Implement rename
          break;
        case 'delete':
          // Implement delete
          break;
        case 'copy':
          // Copy file path to clipboard
          break;
      }
    }

    // Handle Terminal Commands
    function handleTerminalCommand(command) {
      const parts = command.trim().split(' ');
      const cmd = parts[0];

      switch (cmd) {
        case 'help':
          terminal.writeln('Available commands:');
          terminal.writeln('  help     - Show this help message');
          terminal.writeln('  clear    - Clear terminal');
          terminal.writeln('  ls       - List files');
          terminal.writeln('  save     - Save current file');
          terminal.writeln('  run      - Run project');
          break;
        case 'clear':
          terminal.clear();
          break;
        case 'ls':
          terminal.writeln('Listing files...');
          // Implement file listing
          break;
        case 'save':
          saveCurrentFile();
          terminal.writeln('File saved');
          break;
        case 'run':
          runProject();
          terminal.writeln('Running project...');
          break;
        default:
          terminal.writeln(`Command not found: ${cmd}`);
      }
    }

    // Show Notification
    function showNotification(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = 'notification-toast';

      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle'
      };

      toast.innerHTML = `
        <i class="fas ${icons[type]} notification-icon ${type}"></i>
        <div class="notification-message">${message}</div>
      `;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Welcome Content
    function getWelcomeContent() {
      return `# Welcome to Exprsn HTML IDE

A full-featured development environment for building HTML applications with Low-Code components.

## Features

- **Monaco Editor**: VS Code-powered code editing with syntax highlighting for HTML, CSS, JavaScript, Python, SQL
- **22 Low-Code Components**: Drag-and-drop form components from the sidebar
- **Live Preview**: See your changes in real-time
- **Integrated Terminal**: Execute commands without leaving the IDE
- **Socket.IO Collaboration**: Real-time multi-user editing
- **Library Manager**: Manage external dependencies
- **File Explorer**: Organize your project files

## Getting Started

1. Create a new file using the + icon in the Explorer
2. Or open an existing file from the file tree
3. Start coding with full IntelliSense support
4. Preview your work in the Preview panel
5. Save your changes with Ctrl+S (Cmd+S on Mac)

## Keyboard Shortcuts

- **Ctrl+S / Cmd+S**: Save file
- **Ctrl+P / Cmd+P**: Quick open file
- **Ctrl+F / Cmd+F**: Find in file
- **Ctrl+Shift+F / Cmd+Shift+F**: Find in all files
- **F5**: Run project

Happy coding! üöÄ
`;
    }

    // Panel Resizing
    let isResizing = false;
    const panelDivider = document.getElementById('panel-divider');
    const bottomPanel = document.getElementById('bottom-panel');

    panelDivider.addEventListener('mousedown', (e) => {
      isResizing = true;
      document.body.style.cursor = 'row-resize';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;

      const containerHeight = document.querySelector('.split-panel').offsetHeight;
      const newHeight = containerHeight - e.clientY + 85;

      if (newHeight > 50 && newHeight < containerHeight - 100) {
        bottomPanel.style.height = newHeight + 'px';
      }
    });

    document.addEventListener('mouseup', () => {
      isResizing = false;
      document.body.style.cursor = 'default';
    });

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
      // Save: Ctrl+S or Cmd+S
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveCurrentFile();
      }

      // Run: F5
      if (e.key === 'F5') {
        e.preventDefault();
        runProject();
      }
    });

    // Component Drag Handlers
    document.querySelectorAll('.component-item').forEach(item => {
      item.addEventListener('dragstart', (e) => {
        const componentType = e.target.dataset.component;
        e.dataTransfer.setData('component', componentType);
      });
    });

    // Allow dropping on editor
    const editorContainer = document.getElementById('monaco-editor');
    editorContainer.addEventListener('dragover', (e) => {
      e.preventDefault();
    });

    editorContainer.addEventListener('drop', (e) => {
      e.preventDefault();
      const componentType = e.dataTransfer.getData('component');
      if (componentType) {
        insertComponentCode(componentType);
      }
    });

    // Insert Component Code
    function insertComponentCode(componentType) {
      const templates = {
        textinput: '<input type="text" class="form-control" placeholder="Enter text">',
        email: '<input type="email" class="form-control" placeholder="Enter email">',
        number: '<input type="number" class="form-control" placeholder="Enter number">',
        textarea: '<textarea class="form-control" rows="3"></textarea>',
        date: '<input type="date" class="form-control">',
        checkbox: '<div class="form-check"><input type="checkbox" class="form-check-input"><label class="form-check-label">Checkbox</label></div>',
        dropdown: '<select class="form-select"><option>Option 1</option><option>Option 2</option></select>',
        radio: '<div class="form-check"><input type="radio" name="radio" class="form-check-input"><label class="form-check-label">Radio</label></div>',
        button: '<button type="button" class="btn btn-primary">Button</button>',
        fileupload: '<input type="file" class="form-control">',
        label: '<label class="form-label">Label</label>',
        heading: '<h2>Heading</h2>',
        paragraph: '<p>Paragraph text</p>',
        divider: '<hr>',
        spacer: '<div style="height: 20px;"></div>',
        container: '<div class="container"><div class="row"><div class="col">Content</div></div></div>',
        tabs: '<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" href="#">Tab 1</a></li></ul>',
        accordion: '<div class="accordion"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button">Accordion</button></h2></div></div>',
        div: '<div></div>',
        span: '<span></span>',
        img: '<img src="" alt="">',
        link: '<a href="#">Link</a>',
        table: '<table class="table"><thead><tr><th>Header</th></tr></thead><tbody><tr><td>Data</td></tr></tbody></table>',
        ul: '<ul><li>Item 1</li><li>Item 2</li></ul>'
      };

      const code = templates[componentType] || `<!-- ${componentType} -->`;

      const position = monacoEditor.getPosition();
      monacoEditor.executeEdits('insert-component', [{
        range: new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column),
        text: '\n' + code + '\n'
      }]);

      showNotification(`${componentType} component inserted`, 'success');
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
