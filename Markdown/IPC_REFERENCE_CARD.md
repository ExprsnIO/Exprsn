# IPC System Quick Reference Card

**1-page reference for Exprsn IPC system** • Print or keep handy during development

---

## Quick Start

```bash
# 1. Generate certificates (once)
node scripts/generate-tls-certs.js

# 2. Start Bridge service first
cd src/exprsn-bridge && npm start

# 3. Start your service
cd src/exprsn-{service} && npm start

# 4. Test IPC
node test-ipc-communication.js
```

---

## Code Template

```javascript
// 1. Imports
const IPCWorker = require('../../shared/ipc/IPCWorker');
const { HTTPSServerManager } = require('../../shared/utils/httpsServer');
const { bypassAll, logBypassStatus } = require('../../shared/middleware/devBypass');

// 2. Initialize
logBypassStatus();
const ipc = new IPCWorker({ serviceName: 'exprsn-{service}' });

// 3. Event handlers
ipc.on('ready', () => logger.info('IPC ready'));
ipc.on('error', (err) => logger.error('IPC error', err));
ipc.on('event:name', async (data, meta) => {
  // Handle event
});

// 4. Middleware (BEFORE auth!)
app.use(bypassAll);
app.use((req, res, next) => { req.ipc = ipc; next(); });

// 5. Server
const serverManager = new HTTPSServerManager({
  serviceName: 'exprsn-{service}',
  port: 3000
});
const servers = await serverManager.start(app);

// 6. Shutdown
process.on('SIGTERM', async () => {
  await ipc.disconnect();
  process.exit(0);
});
```

---

## Common Operations

### Emit Event
```javascript
await req.ipc.emit('post:created', { id, content }, {
  target: 'broadcast'  // or 'exprsn-herald'
});
```

### Listen for Event
```javascript
ipc.on('user:updated', async (data, meta) => {
  console.log('User updated:', data);
  console.log('From service:', meta.source);
});
```

### CRUD Operations
```javascript
// Create
const post = await ipc.create('posts', { content: 'Hello' });

// Read
const posts = await ipc.read('posts', { userId: '123' });

// Update
await ipc.update('posts', 'post-id', { content: 'Updated' });

// Delete
await ipc.delete('posts', 'post-id');
```

### JSONLex
```javascript
const result = await ipc.executeJSONLex({
  __jsonlex: true,
  expr: {
    fullName: {
      $concat: [{ $var: 'firstName' }, ' ', { $var: 'lastName' }]
    }
  }
}, { firstName: 'John', lastName: 'Doe' });
// Result: { fullName: 'John Doe' }
```

---

## Event Naming Convention

```
resource:action
```

**Examples:**
- `post:created`, `post:updated`, `post:deleted`
- `user:login`, `user:logout`, `user:updated`
- `message:sent`, `message:delivered`, `message:read`
- `content:flagged`, `content:moderated`
- `notification:sent`, `notification:delivered`

---

## Environment Variables

```bash
# Required
TLS_ENABLED=true
IPC_BROKER_KEY=<auto-generated>
DEV_BYPASS=true
NODE_ENV=development
REDIS_ENABLED=true

# Optional
IPC_RATE_LIMIT=true
IPC_RATE_MAX=1000
IPC_RATE_WINDOW=60000
IPC_TOKEN_TTL=300
```

---

## Monitoring

```bash
# IPC statistics
curl -k https://localhost:3010/api/ipc/stats

# Service health
curl -k https://localhost:{port}/health

# Test IPC
node test-ipc-communication.js

# Watch logs
tail -f src/exprsn-{service}/logs/*.log | grep IPC
```

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Certificates not found | `node scripts/generate-tls-certs.js` |
| Connection refused | Start Bridge first (`cd src/exprsn-bridge && npm start`) |
| Redis error | `redis-cli ping` (start Redis if needed) |
| Auth errors | Verify `bypassAll` BEFORE auth middleware |
| Events not received | Check event name matches exactly (case-sensitive) |
| Rate limit exceeded | Set `IPC_RATE_MAX=2000` in `.env` |

---

## Ports

- **Bridge:** 3010 (HTTPS), 3009 (HTTP redirect)
- **Timeline:** 3004 (HTTPS), 3003 (HTTP redirect)
- **Auth:** 3001 (HTTPS), 3000 (HTTP redirect)
- **Your Service:** {port} (HTTPS), {port-1} (HTTP redirect)

---

## Request-Response Pattern

```javascript
// Service A - Request
const requestId = uuid();
let handler;
const promise = new Promise(resolve => {
  handler = (data) => {
    if (data.requestId === requestId) {
      ipc.off('response', handler);
      resolve(data.result);
    }
  };
  ipc.on('response', handler);
});

await ipc.emit('request', { requestId, query: {} }, {
  target: 'exprsn-timeline'
});

const result = await promise;

// Service B - Respond
ipc.on('request', async (data, meta) => {
  const result = await processRequest(data.query);
  await ipc.emit('response', {
    requestId: data.requestId,
    result
  }, { target: meta.source });
});
```

---

## Best Practices

✅ **DO:**
- Use `bypassAll` middleware BEFORE auth
- Emit events after database operations
- Handle IPC errors gracefully (don't fail requests)
- Use meaningful event names
- Disconnect IPC in shutdown handlers
- Check Bridge is running first

❌ **DON'T:**
- Skip `logBypassStatus()` call
- Put auth middleware before `bypassAll`
- Fail requests if IPC emit fails
- Use generic event names like `update`
- Forget to add `req.ipc` to context
- Start service before Bridge

---

## Documentation

- **Full Docs:** [IPC_SYSTEM.md](./IPC_SYSTEM.md)
- **Quick Start:** [IPC_QUICK_START.md](./IPC_QUICK_START.md)
- **Examples:** [IPC_INTEGRATION_EXAMPLES.md](./IPC_INTEGRATION_EXAMPLES.md)
- **Migration:** [IPC_MIGRATION_GUIDE.md](./IPC_MIGRATION_GUIDE.md)
- **Summary:** [IPC_IMPLEMENTATION_SUMMARY.md](./IPC_IMPLEMENTATION_SUMMARY.md)

---

## Service Integration Checklist

```
□ Import IPC utilities (Worker, HTTPS, bypass)
□ Call logBypassStatus()
□ Initialize IPCWorker
□ Add IPC event handlers
□ Add bypassAll BEFORE auth
□ Add req.ipc to context
□ Replace server with HTTPSServerManager
□ Emit events in routes
□ Add IPC disconnect to shutdown
□ Test with: node test-ipc-communication.js
```

---

**Need Help?** Check troubleshooting in [IPC_MIGRATION_GUIDE.md](./IPC_MIGRATION_GUIDE.md)

**IPC System v1.0** • December 29, 2025 • Exprsn Platform
