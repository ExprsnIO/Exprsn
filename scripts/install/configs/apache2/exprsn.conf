# ═══════════════════════════════════════════════════════════════════════
# Apache2 Configuration for Exprsn Certificate Authority Ecosystem
# ═══════════════════════════════════════════════════════════════════════

<VirtualHost *:80>
    ServerName exprsn.local
    ServerAdmin admin@exprsn.local

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/exprsn-error.log
    CustomLog ${APACHE_LOG_DIR}/exprsn-access.log combined

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer-when-downgrade"

    # Enable proxying
    ProxyPreserveHost On
    ProxyRequests Off

    # ───────────────────────────────────────────────────────────────────
    # Certificate Authority (Main)
    # ───────────────────────────────────────────────────────────────────
    ProxyPass / http://127.0.0.1:3000/
    ProxyPassReverse / http://127.0.0.1:3000/

    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://127.0.0.1:3000/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://127.0.0.1:3000/$1 [P,L]

    # ───────────────────────────────────────────────────────────────────
    # Setup & Management Service
    # ───────────────────────────────────────────────────────────────────
    ProxyPass /setup http://127.0.0.1:3015/setup
    ProxyPassReverse /setup http://127.0.0.1:3015/setup

    # WebSocket support for Setup
    ProxyPass /setup/socket.io/ ws://127.0.0.1:3015/socket.io/
    ProxyPassReverse /setup/socket.io/ ws://127.0.0.1:3015/socket.io/

    # ───────────────────────────────────────────────────────────────────
    # API Gateway (Bridge)
    # ───────────────────────────────────────────────────────────────────
    ProxyPass /api/ http://127.0.0.1:3010/
    ProxyPassReverse /api/ http://127.0.0.1:3010/

    # ───────────────────────────────────────────────────────────────────
    # Authentication Service
    # ───────────────────────────────────────────────────────────────────
    ProxyPass /auth/ http://127.0.0.1:3001/
    ProxyPassReverse /auth/ http://127.0.0.1:3001/

    # ───────────────────────────────────────────────────────────────────
    # Messaging Service (Spark)
    # ───────────────────────────────────────────────────────────────────
    ProxyPass /spark/ http://127.0.0.1:3002/
    ProxyPassReverse /spark/ http://127.0.0.1:3002/

    # WebSocket support for Spark
    ProxyPass /spark/socket.io/ ws://127.0.0.1:3002/socket.io/
    ProxyPassReverse /spark/socket.io/ ws://127.0.0.1:3002/socket.io/

    # ───────────────────────────────────────────────────────────────────
    # Timeline Service
    # ───────────────────────────────────────────────────────────────────
    ProxyPass /timeline/ http://127.0.0.1:3004/
    ProxyPassReverse /timeline/ http://127.0.0.1:3004/

    # WebSocket support for Timeline
    ProxyPass /timeline/socket.io/ ws://127.0.0.1:3004/socket.io/
    ProxyPassReverse /timeline/socket.io/ ws://127.0.0.1:3004/socket.io/

    # ───────────────────────────────────────────────────────────────────
    # Nexus Service (Groups & Events)
    # ───────────────────────────────────────────────────────────────────
    ProxyPass /nexus/ http://127.0.0.1:3011/
    ProxyPassReverse /nexus/ http://127.0.0.1:3011/

    # ───────────────────────────────────────────────────────────────────
    # Dynamic Page Server (SVR)
    # ───────────────────────────────────────────────────────────────────
    ProxyPass /pages/ http://127.0.0.1:5000/
    ProxyPassReverse /pages/ http://127.0.0.1:5000/

    # WebSocket support for SVR
    ProxyPass /pages/socket.io/ ws://127.0.0.1:5000/socket.io/
    ProxyPassReverse /pages/socket.io/ ws://127.0.0.1:5000/socket.io/

    # ───────────────────────────────────────────────────────────────────
    # OCSP Responder
    # ───────────────────────────────────────────────────────────────────
    ProxyPass /ocsp http://127.0.0.1:3000/ocsp
    ProxyPassReverse /ocsp http://127.0.0.1:3000/ocsp

    # ───────────────────────────────────────────────────────────────────
    # CRL Distribution
    # ───────────────────────────────────────────────────────────────────
    ProxyPass /crl http://127.0.0.1:3000/crl
    ProxyPassReverse /crl http://127.0.0.1:3000/crl

    # ───────────────────────────────────────────────────────────────────
    # Health Check Endpoint
    # ───────────────────────────────────────────────────────────────────
    <Location /health>
        SetHandler server-status
        Require all granted
    </Location>

    # ───────────────────────────────────────────────────────────────────
    # Deny access to sensitive files
    # ───────────────────────────────────────────────────────────────────
    <DirectoryMatch "^\.|\/\.">
        Require all denied
    </DirectoryMatch>

    <FilesMatch "^\.env$">
        Require all denied
    </FilesMatch>

    <FilesMatch "package\.json$">
        Require all denied
    </FilesMatch>

</VirtualHost>

# ═══════════════════════════════════════════════════════════════════════
# SSL/TLS Configuration (uncomment after obtaining certificates)
# ═══════════════════════════════════════════════════════════════════════

# <VirtualHost *:443>
#     ServerName your-domain.com
#     ServerAdmin admin@your-domain.com
#
#     # SSL Configuration
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/your-domain.com/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/your-domain.com/privkey.pem
#
#     # Modern SSL configuration
#     SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
#     SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
#     SSLHonorCipherOrder off
#     SSLSessionTickets off
#
#     # OCSP Stapling
#     SSLUseStapling on
#     SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"
#
#     # Logging
#     ErrorLog ${APACHE_LOG_DIR}/exprsn-ssl-error.log
#     CustomLog ${APACHE_LOG_DIR}/exprsn-ssl-access.log combined
#
#     # Include all proxy configurations from above
#     # ... (same as HTTP VirtualHost)
# </VirtualHost>

# # Redirect HTTP to HTTPS
# <VirtualHost *:80>
#     ServerName your-domain.com
#
#     # Allow ACME challenge
#     Alias /.well-known/acme-challenge/ /var/www/html/.well-known/acme-challenge/
#     <Directory "/var/www/html/.well-known/acme-challenge/">
#         Options None
#         AllowOverride None
#         Require all granted
#     </Directory>
#
#     # Redirect everything else to HTTPS
#     RewriteEngine On
#     RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge/
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
# </VirtualHost>
